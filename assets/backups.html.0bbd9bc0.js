import{_ as e,o as i,c as n,e as d}from"./app.94cd83f3.js";const a={},o=d(`<h2 id="\u5907\u4EFD\u548C\u6062\u590D" tabindex="-1"><a class="header-anchor" href="#\u5907\u4EFD\u548C\u6062\u590D" aria-hidden="true">#</a> \u5907\u4EFD\u548C\u6062\u590D</h2><blockquote><p>\u4EFB\u610F\u65F6\u95F4\u70B9\u5907\u4EFD\u6062\u590D=\u5168\u91CF\u5907\u4EFD(mongodump/\u590D\u5236\u6570\u636E\u5E93\u6587\u4EF6/\u6587\u4EF6\u7CFB\u7EDF\u5FEB\u7167) + oplog</p></blockquote><h4 id="mongodump" tabindex="-1"><a class="header-anchor" href="#mongodump" aria-hidden="true">#</a> <code>mongodump</code></h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mongodump -h HOST -d DB_NAME -o \u5907\u4EFD\u7684\u6570\u636E\u5B58\u653E\u4F4D\u7F6E
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="mongorestore" tabindex="-1"><a class="header-anchor" href="#mongorestore" aria-hidden="true">#</a> <code>mongorestore</code></h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mongorestore -h HOST:PORT -d DB_NAME PATH
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="\u5907\u4EFD\u548C\u6062\u590D\u7684\u91CD\u8981\u9009\u9879" tabindex="-1"><a class="header-anchor" href="#\u5907\u4EFD\u548C\u6062\u590D\u7684\u91CD\u8981\u9009\u9879" aria-hidden="true">#</a> \u5907\u4EFD\u548C\u6062\u590D\u7684\u91CD\u8981\u9009\u9879</h4><p><code>mongodump</code>\uFF1A</p><ul><li><p>--oplog \u53EA\u5BF9\u5168\u5E93\u5BFC\u51FA\u6709\u6548\uFF0C\u4E0D\u80FD\u6307\u5B9A-d</p><p>\u5E42\u7B49\u6027\uFF0C\u5DF2\u5B58\u5728\u7684\u6570\u636E\uFF0C\u91CD\u505Aoplog\u4E0D\u4F1A\u91CD\u590D\uFF1B\u4E0D\u5B58\u5728\u7684\u6570\u636E\u91CD\u505Aoplog\u5C31\u53EF\u4EE5\u8FDB\u5165\u6570\u636E\u5E93</p></li></ul><p><code>mongoresotre</code>:</p><ul><li>--oplogReplay: \u53EF\u4EE5\u91CD\u653Eoplog.bson\u4E2D\u7684\u64CD\u4F5C\u5185\u5BB9</li><li>--oplogLimit: \u56DE\u653E\u7684\u65F6\u95F4\u8282\u70B9\uFF0C\u6B64\u65F6\u95F4\u4E4B\u524D\u7684\u6570\u636E\u53EF\u6062\u590D</li></ul><p>\u901A\u8FC7oplog\u67E5\u8BE2\u8BEF\u64CD\u4F5C\u7684\u6700\u540E\u65F6\u95F4</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>bsondump oplog.rs.bson | grep &quot;&quot;op&quot;:&quot;d&quot;&quot; |head
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u6216</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>db.oplog.rs.find({&quot;op&quot;:&quot;d&quot;}).sort({&quot;ts&quot;:=1})
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="\u5168\u91CF\u52A0\u589E\u91CF\u5907\u4EFD\u548C\u6062\u590D\u6848\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u5168\u91CF\u52A0\u589E\u91CF\u5907\u4EFD\u548C\u6062\u590D\u6848\u4F8B" aria-hidden="true">#</a> \u5168\u91CF\u52A0\u589E\u91CF\u5907\u4EFD\u548C\u6062\u590D\u6848\u4F8B</h4><blockquote><p>\u5220\u9664\u590D\u5236\u96C6\u4E2D\u539F\u6765\u7684\u6570\u636E\u6587\u4EF6\u76EE\u5F55 \u91CD\u65B0\u5EFA\u7ACB\u6570\u636E\u76EE\u5F55</p><p>\u91CD\u65B0\u542F\u52A8\u590D\u5236\u96C6\u4E2D\u7684\u5B9E\u4F8B \u8FDB\u884C\u590D\u5236\u96C6\u7684\u914D\u7F6E</p><p>var cfg ={&quot;_id&quot;:&quot;cluster_id&quot;,</p><p>&quot;protocolVersion&quot; : 1,</p><p>&quot;members&quot;:[</p><p>{&quot;_id&quot;:1,&quot;host&quot;:&quot;ip:37017&quot;,&quot;priority&quot;:10},</p><p>{&quot;_id&quot;:2,&quot;host&quot;:&quot;ip:37018&quot;},</p><p>{&quot;_id&quot;:3,&quot;host&quot;:&quot;ip:37019&quot;}</p><p>]</p><p>}</p><p>rs.initiate(cfg)</p></blockquote><h5 id="\u5168\u91CF\u5907\u4EFD" tabindex="-1"><a class="header-anchor" href="#\u5168\u91CF\u5907\u4EFD" aria-hidden="true">#</a> \u5168\u91CF\u5907\u4EFD</h5><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>./bin/mongodump --host=HOST --port=PORT--out=/root/fullbackup
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="\u589E\u91CF\u5907\u4EFD" tabindex="-1"><a class="header-anchor" href="#\u589E\u91CF\u5907\u4EFD" aria-hidden="true">#</a> \u589E\u91CF\u5907\u4EFD</h5><p>\u6A21\u62DF\u63D2\u5165\u6570\u636E\u548C\u66F4\u65B0\u540E</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>/bin/mongodump --host=HOST --port=PORT -d local -c oplog.rs -o=/root/oplog_bak
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="\u6062\u590D\u5168\u91CF\u6570\u636E" tabindex="-1"><a class="header-anchor" href="#\u6062\u590D\u5168\u91CF\u6570\u636E" aria-hidden="true">#</a> \u6062\u590D\u5168\u91CF\u6570\u636E</h5><p>\u5148\u5220\u9664\u6240\u6709\u6570\u636E</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>/bin/mongorestore --host=HOST --port=PORT --dir=/root/fullbackup
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="\u6062\u590D\u6570\u636E\u5230\u6307\u5B9A\u7684\u65F6\u95F4\u70B9" tabindex="-1"><a class="header-anchor" href="#\u6062\u590D\u6570\u636E\u5230\u6307\u5B9A\u7684\u65F6\u95F4\u70B9" aria-hidden="true">#</a> \u6062\u590D\u6570\u636E\u5230\u6307\u5B9A\u7684\u65F6\u95F4\u70B9</h5><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\u6539\u53D8oplog.rs.bson \u4E3A oplog.bson \u5220\u9664oplog.rs.metadata.bson
mv /root/oplog_bak/local/oplog.rs.bson /root/oplog_bak/local/oplog.bson
rm /root/oplog_bak/local/oplog.rs.metadata.json -rf

\u627E\u51FA\u7B2C\u4E00\u6B21\u66F4\u65B0\u7684\u65F6\u95F4
use local
db.oplog.rs.find({&quot;op&quot; : &quot;u&quot;}).sort({&quot;ts&quot;:1})
\u6062\u590D\u5230\u6307\u5B9A\u7684\u65F6\u95F4\u70B9\u7684\u6570\u636E
./bin/mongorestore --host=HOST --port=PORT --oplogReplay --oplogLimit &quot;\u5B9E\u9645\u67E5\u8BE2\u51FA\u6765\u7684\u65F6\u95F4&quot; /root/oplog_bak/local
1606651336

./bin/mongorestore --host=HOST --port=PORT --oplogReplay --oplogLimit &quot;1606651336:4&quot; /root/oplog_bak/local
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u6062\u590D\u6240\u6709\u7684\u589E\u91CF\u6570\u636E" tabindex="-1"><a class="header-anchor" href="#\u6062\u590D\u6240\u6709\u7684\u589E\u91CF\u6570\u636E" aria-hidden="true">#</a> \u6062\u590D\u6240\u6709\u7684\u589E\u91CF\u6570\u636E</h5><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>./bin/mongorestore --host=HOST --port=PORT --oplogReplay /root/oplog_bak/local
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="\u5B9A\u65F6\u5907\u4EFD" tabindex="-1"><a class="header-anchor" href="#\u5B9A\u65F6\u5907\u4EFD" aria-hidden="true">#</a> \u5B9A\u65F6\u5907\u4EFD</h4><h5 id="\u7F16\u5199\u5907\u4EFD\u811A\u672C-root-backup-mongobk-sh" tabindex="-1"><a class="header-anchor" href="#\u7F16\u5199\u5907\u4EFD\u811A\u672C-root-backup-mongobk-sh" aria-hidden="true">#</a> \u7F16\u5199\u5907\u4EFD\u811A\u672C <code>/root/backup/mongobk.sh</code></h5><p><code>chmod +x /root/backup/mongobk.sh</code></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>#!/bin/sh
# dump \u547D\u4EE4\u6267\u884C\u8DEF\u5F84\uFF0C\u6839\u636Emongodb\u5B89\u88C5\u8DEF\u5F84\u800C\u5B9A
DUMP=/root/mongodb/bin/mongodump
# \u4E34\u65F6\u5907\u4EFD\u8DEF\u5F84
OUT_DIR=/root/backup/mongod_bak/mongod_bak_now
# \u538B\u7F29\u540E\u7684\u5907\u4EFD\u5B58\u653E\u8DEF\u5F84
TAR_DIR=/root/backup/mongod_bak/mongod_bak_list
# \u5F53\u524D\u7CFB\u7EDF\u65F6\u95F4
DATE=\`date +%Y_%m_%d%H%M%S\`
# \u6570\u636E\u5E93\u8D26\u53F7
#DB_USER=user
# \u6570\u636E\u5E93\u5BC6\u7801
#DB_PASS=password
# \u4EE3\u8868\u5220\u96647\u5929\u524D\u7684\u5907\u4EFD\uFF0C\u5373\u53EA\u4FDD\u7559\u8FD1 7 \u5929\u7684\u5907\u4EFD
DAYS=7
# \u6700\u7EC8\u4FDD\u5B58\u7684\u6570\u636E\u5E93\u5907\u4EFD\u6587\u4EF6
TAR_BAK=&quot;mongod_bak_$DATE.tar.gz&quot;
cd $OUT_DIR
rm -rf $OUT_DIR/*
mkdir -p $OUT_DIR/$DATE
$DUMP -h 127.0.0.1 --port 37017 -o $OUT_DIR/$DATE
# \u538B\u7F29\u683C\u5F0F\u4E3A .tar.gz \u683C\u5F0F
tar -zPcvf $TAR_DIR/$TAR_BAK $OUT_DIR/$DATE
# \u5220\u9664 7 \u5929\u524D\u7684\u5907\u4EFD\u6587\u4EF6
find $TAR_DIR/ -mtime +$DAYS -delete
exit
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u7F16\u8F91crontab" tabindex="-1"><a class="header-anchor" href="#\u7F16\u8F91crontab" aria-hidden="true">#</a> \u7F16\u8F91crontab</h5><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>crontab -e

# \u6BCF\u5929\u51CC\u66682\u70B930\u5206\u6267\u884C\u5907\u4EFD
30 2 * * * /root/backup/mongobk.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u67E5\u770Bcrontab\u7684\u72B6\u6001" tabindex="-1"><a class="header-anchor" href="#\u67E5\u770Bcrontab\u7684\u72B6\u6001" aria-hidden="true">#</a> \u67E5\u770Bcrontab\u7684\u72B6\u6001</h5><p><code>service crond status</code></p><h5 id="\u542F\u52A8\u5B9A\u65F6\u4EFB\u52A1\u548C\u52A0\u5165\u5F00\u673A\u81EA\u542F\u52A8" tabindex="-1"><a class="header-anchor" href="#\u542F\u52A8\u5B9A\u65F6\u4EFB\u52A1\u548C\u52A0\u5165\u5F00\u673A\u81EA\u542F\u52A8" aria-hidden="true">#</a> \u542F\u52A8\u5B9A\u65F6\u4EFB\u52A1\u548C\u52A0\u5165\u5F00\u673A\u81EA\u542F\u52A8</h5><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code># \u542F\u52A8\u5B9A\u65F6\u4EFB\u52A1
service crond start
# \u52A0\u5165\u5F00\u673A\u81EA\u52A8\u542F\u52A8
chkconfig --level 35 crond on
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="\u67E5\u770B\u5B9A\u65F6\u4EFB\u52A1\u548C\u5220\u9664\u5B9A\u65F6\u4EFB\u52A1" tabindex="-1"><a class="header-anchor" href="#\u67E5\u770B\u5B9A\u65F6\u4EFB\u52A1\u548C\u5220\u9664\u5B9A\u65F6\u4EFB\u52A1" aria-hidden="true">#</a> \u67E5\u770B\u5B9A\u65F6\u4EFB\u52A1\u548C\u5220\u9664\u5B9A\u65F6\u4EFB\u52A1</h5><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>crontab -l
crontab -r 
crontab -e
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,41),s=[o];function r(l,t){return i(),n("div",null,s)}const u=e(a,[["render",r],["__file","backups.html.vue"]]);export{u as default};
