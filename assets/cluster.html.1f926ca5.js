import{_ as n,o as s,c as e,e as a}from"./app.94cd83f3.js";const i={},t=a(`<h1 id="mongodb-\u96C6\u7FA4" tabindex="-1"><a class="header-anchor" href="#mongodb-\u96C6\u7FA4" aria-hidden="true">#</a> MongoDB - \u96C6\u7FA4</h1><h2 id="_1-\u4E3B\u4ECE\u590D\u5236" tabindex="-1"><a class="header-anchor" href="#_1-\u4E3B\u4ECE\u590D\u5236" aria-hidden="true">#</a> 1. <s>\u4E3B\u4ECE\u590D\u5236</s></h2><blockquote><p>4.0 \u540E\u5DF2\u5F03\u7528</p></blockquote><p>\u4E3B\u4ECE\u67B6\u6784\u4E2D\uFF0Cmaster\u8282\u70B9\u8D1F\u8D23\u6570\u636E\u7684\u8BFB\u5199\uFF0Cslave\u6CA1\u6709\u5199\u5165\u6743\u9650\u53EA\u80FD\u8BFB\u53D6</p><p>\u5728\u4E3B\u4ECE\u7ED3\u6784\u4E2D\uFF0C\u4E3B\u8282\u70B9\u7684\u64CD\u4F5C\u8BB0\u5F55\u4E3A<code>oplog</code>,\u5B83\u5B58\u50A8\u5728\u7CFB\u7EDF\u8BE5\u6570\u636E\u5E93<code>local</code>\u7684<code>oplog.$main</code>\u96C6\u5408\u4E2D\uFF0C\u8FD9\u4E2A\u96C6\u5408\u7684\u6BCF\u4E2A\u6587\u6863\u90FD\u4EE3\u8868\u4E3B\u8282\u70B9\u4E0A\u6267\u884C\u7684\u4E00\u4E2A\u64CD\u4F5C\u3002\u4ECE\u670D\u52A1\u5668\u4F1A\u5B9A\u671F\u4ECE\u4E3B\u670D\u52A1\u5668\u83B7\u53D6oplog\u8BB0\u5F55\uFF0C\u7136\u540E\u5728\u672C\u673A\u4E0A\u6267\u884C\u3002\u5BF9\u4E8E\u5B58\u50A8oplog\u7684\u96C6\u5408\uFF0CMongo\u91C7\u7528\u56FA\u5B9A\u96C6\u5408\uFF0C\u5373\u65B0\u64CD\u4F5C\u4F1A\u8986\u76D6\u65E7\u64CD\u4F5C\u3002</p><p>\u7531\u4E8E\u6CA1\u6709\u81EA\u52A8\u6545\u969C\u8F6C\u79FB\uFF0C\u9700\u8981\u6307\u5B9Amaster\u548Cslave\u7AEF\uFF0C\u4E0D\u63A8\u8350\u5728\u751F\u4EA7\u4E2D\u4F7F\u7528\uFF0C\u4E144.0\u540E\u4E0D\u518D\u652F\u6301\u4E3B\u4ECE\u590D\u5236</p><h2 id="_2-\u590D\u5236\u96C6-replica-sets" tabindex="-1"><a class="header-anchor" href="#_2-\u590D\u5236\u96C6-replica-sets" aria-hidden="true">#</a> 2. \u590D\u5236\u96C6 Replica Sets</h2><p>\u590D\u5236\u96C6\u662F\u7531\u4E00\u7EC4\u62E5\u6709\u76F8\u540C\u6570\u636E\u96C6\u7684mongod\u5B9E\u4F8B\u7EC4\u6210\u7684\u96C6\u7FA4\uFF0C\u75312\u53F0\u62162\u53F0\u4EE5\u4E0A\u7684\u670D\u52A1\u5668\u7EC4\u6210\uFF0C\u4EE5\u53CA\u590D\u5236\u96C6\u6210\u5458\u5305\u62EC<code>Primary</code>\u4E3B\u8282\u70B9\u3001<code>Secondary</code>\u4ECE\u8282\u70B9\u548C\u6295\u7968\u8282\u70B9\u3002</p><p>\u590D\u5236\u96C6\u63D0\u4F9B\u4E86\u6570\u636E\u7684\u5197\u4F59\u5907\u4EFD\uFF0C\u5E76\u5728\u591A\u4E2A\u670D\u52A1\u5668\u4E0A\u5B58\u50A8\u6570\u636E\u526F\u672C\uFF0C\u63D0\u9AD8\u4E86\u6570\u636E\u7684\u53EF\u7528\u6027\uFF0C\u4FDD\u8BC1\u6570\u636E\u7684\u5B89\u5168\u6027\u3002\u76F8\u6BD4\u4E8E\u4E3B\u4ECE\u591A\u4E86<strong>\u81EA\u52A8\u5207\u6362</strong>\u7684\u529F\u80FD</p><h3 id="_2-1-\u4E3A\u4EC0\u4E48\u8981\u4F7F\u7528\u590D\u5236\u96C6" tabindex="-1"><a class="header-anchor" href="#_2-1-\u4E3A\u4EC0\u4E48\u8981\u4F7F\u7528\u590D\u5236\u96C6" aria-hidden="true">#</a> 2.1 \u4E3A\u4EC0\u4E48\u8981\u4F7F\u7528\u590D\u5236\u96C6</h3><ul><li>\u9AD8\u53EF\u7528\uFF1A \u9632\u6B62\u8BBE\u5907\u6545\u969C\uFF0C\u63D0\u4F9B\u81EA\u52A8failover\u529F\u80FD</li><li>\u707E\u96BE\u6062\u590D\uFF1A\u53D1\u751F\u6545\u969C\u65F6\uFF0C\u53EF\u4ECE\u5176\u4ED6\u8282\u70B9\u6062\u590D\uFF0C\u7528\u4E8E\u5907\u4EFD</li><li>\u8BFB\u5199\u9694\u79BB\uFF1A \u53EF\u5728\u5907\u8282\u70B9\u6267\u884C\u8BFB\uFF0C\u51CF\u5C11\u4E3B\u5E93\u538B\u529B\uFF0C\u5982\u7528\u4E8E\u5206\u6790 \u62A5\u8868 \u6570\u636E\u6316\u6398 \u7CFB\u7EDF\u4EFB\u52A1\u7B49</li></ul><h3 id="_2-2-\u590D\u5236\u96C6\u96C6\u7FA4\u67B6\u6784\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#_2-2-\u590D\u5236\u96C6\u96C6\u7FA4\u67B6\u6784\u539F\u7406" aria-hidden="true">#</a> 2.2 \u590D\u5236\u96C6\u96C6\u7FA4\u67B6\u6784\u539F\u7406</h3><p>\u539F\u7406\u548C\u4E3B\u4ECE\u590D\u5236\u76F8\u540C\uFF0C</p><h4 id="_2-2-1-oplog\u5177\u6709\u5E42\u7B49\u6027-\u7EC4\u6210\u7ED3\u6784\u5982\u4E0B" tabindex="-1"><a class="header-anchor" href="#_2-2-1-oplog\u5177\u6709\u5E42\u7B49\u6027-\u7EC4\u6210\u7ED3\u6784\u5982\u4E0B" aria-hidden="true">#</a> 2.2.1 <strong>oplog</strong>\u5177\u6709\u5E42\u7B49\u6027\uFF0C\u7EC4\u6210\u7ED3\u6784\u5982\u4E0B</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>{
	&quot;ts&quot; : Timestamp(1446011584, 2),
	&quot;h&quot; : NumberLong(&quot;1687359108795812092&quot;),
	&quot;v&quot; : 2,
	&quot;op&quot; : &quot;i&quot;,
	&quot;ns&quot; : &quot;test.nosql&quot;,
	&quot;o&quot; : { &quot;_id&quot; : ObjectId(&quot;563062c0b085733f34ab4129&quot;), &quot;name&quot; : &quot;mongodb&quot;, &quot;score&quot; : &quot;10&quot;}
}
ts:\u64CD\u4F5C\u65F6\u95F4\uFF0C\u5F53\u524Dtimestamp + \u8BA1\u6570\u5668\uFF0C\u8BA1\u6570\u5668\u6BCF\u79D2\u90FD\u88AB\u91CD\u7F6E
h:\u64CD\u4F5C\u7684\u5168\u5C40\u552F\u4E00\u6807\u8BC6
v:oplog\u7248\u672C\u4FE1\u606F
op:\u64CD\u4F5C\u7C7B\u578B
  i:\u63D2\u5165\u64CD\u4F5C
  u:\u66F4\u65B0\u64CD\u4F5C
  d:\u5220\u9664\u64CD\u4F5C c:\u6267\u884C\u547D\u4EE4(\u5982createDatabase\uFF0CdropDatabase)
n:\u7A7A\u64CD\u4F5C\uFF0C\u7279\u6B8A\u7528\u9014
ns:\u64CD\u4F5C\u9488\u5BF9\u7684\u96C6\u5408
o:\u64CD\u4F5C\u5185\u5BB9 o2:\u66F4\u65B0\u67E5\u8BE2\u6761\u4EF6,\u4EC5update\u64CD\u4F5C\u5305\u542B\u8BE5\u5B57\u6BB5
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-\u6709\u4E09\u79CD\u7C7B\u578B\u7684\u8282\u70B9" tabindex="-1"><a class="header-anchor" href="#_2-2-2-\u6709\u4E09\u79CD\u7C7B\u578B\u7684\u8282\u70B9" aria-hidden="true">#</a> 2.2.2 <strong>\u6709\u4E09\u79CD\u7C7B\u578B\u7684\u8282\u70B9</strong></h4><ul><li>PRIMARY \u53EF\u4EE5\u67E5\u8BE2\u548C\u65B0\u589E</li><li>SECONDARY \u53EA\u80FD\u67E5\u8BE2\u4E0D\u80FD\u65B0\u589E \u57FA\u4E8E <code>priority</code>\u6743\u91CD\u53EF\u4EE5\u88AB\u9009\u4E3A\u4E3B\u8282\u70B9</li><li>ARBITER \u4E0D\u80FD\u67E5\u8BE2\u548C\u65B0\u589E \u4E0D\u80FD\u53D8\u4E3A\u4E3B\u8282\u70B9</li></ul><h4 id="_2-2-3-\u6570\u636E\u540C\u6B65" tabindex="-1"><a class="header-anchor" href="#_2-2-3-\u6570\u636E\u540C\u6B65" aria-hidden="true">#</a> 2.2.3 \u6570\u636E\u540C\u6B65</h4><p>\u590D\u5236\u96C6\u6570\u636E\u540C\u6B65\u5206\u4E3A<strong>\u521D\u59CB\u5316\u540C\u6B65</strong>\u548C<strong>keep\u590D\u5236\u540C\u6B65</strong>\u3002\u521D\u59CB\u5316\u540C\u6B65\u6307\u5168\u91CF\u4ECE\u4E3B\u8282\u70B9\u540C\u6B65\u6570\u636E\uFF0C\u5982\u679CPrimary\u8282\u70B9\u6570\u636E\u91CF \u6BD4\u8F83\u5927\u540C\u6B65\u65F6\u95F4\u4F1A\u6BD4\u8F83\u2ED3\u3002\u800Ckeep\u590D\u5236\u6307\u521D\u59CB\u5316\u540C\u6B65\u8FC7\u540E\uFF0C\u8282\u70B9\u4E4B\u95F4\u7684\u5B9E\u65F6\u540C\u6B65\u4E00\u822C\u662F\u589E\u91CF\u540C\u6B65\u3002</p><ul><li>\u521D\u59CB\u5316\u540C\u6B65\u6709\u4EE5\u4E0B\u4E24\u79CD\u60C5\u51B5\u89E6\u53D1 <ul><li>Secondary\u7B2C\u4E00\u6B21\u52A0\u5165</li><li>Secondary\u843D\u540E\u7684\u6570\u636E\u91CF\u8D85\u8FC7\u4E86oplog\u7684\u5927\u5C0F\uFF0C\u8FD9\u6837\u4E5F\u4F1A\u88AB\u5168\u91CF\u590D\u5236</li></ul></li></ul><p>MongoDB\u7684Primary<strong>\u8282\u70B9\u9009\u4E3E</strong>\u57FA\u4E8E\u5FC3\u8DF3\u89E6\u53D1\u3002\u4E00\u4E2A\u590D\u5236\u96C6N\u4E2A\u8282\u70B9\u4E2D\u7684\u4EFB\u610F\u4E24\u4E2A\u8282\u70B9\u7EF4\u6301\u5FC3\u8DF3\uFF0C\u6BCF\u4E2A\u8282\u70B9\u7EF4\u62A4\u5176\u4ED6 N-1\u4E2A\u8282\u70B9\u7684\u72B6\u6001</p><blockquote><p><strong>\u5FC3\u8DF3\u68C0\u6D4B</strong>:</p><p>\u6574\u4E2A\u96C6\u7FA4\u9700\u8981\u4FDD\u6301\u4E00\u5B9A\u7684\u901A\u4FE1\u624D\u80FD\u77E5\u9053\u54EA\u4E9B\u8282\u70B9\u6D3B\u7740\u54EA\u4E9B\u8282\u70B9\u6302\u6389,mongodb\u8282\u70B9\u4F1A\u5411\u526F\u672C\u96C6\u4E2D\u7684\u5176\u4ED6\u8282\u70B9\u6BCF2\u79D2\u5C31\u4F1A \u53D1\u9001\u4E00\u6B21pings\u5305\uFF0C\u5982\u679C\u5176\u4ED6\u8282\u70B9\u572810\u79D2\u949F\u4E4B\u5185\u6CA1\u6709\u8FD4\u56DE\u5C31\u6807\u793A\u4E3A\u4E0D\u80FD\u8BBF\u95EE\u3002</p><p>\u6BCF\u4E2A\u8282\u70B9\u5185\u90E8\u90FD\u4F1A\u7EF4\u62A4\u4E00\u4E2A\u72B6\u6001\u6620\u5C04\u8868\uFF0C \u8868\u660E\u5F53\u524D\u6BCF\u4E2A\u8282\u70B9\u662F\u4EC0\u4E48\u2EC6\u8272\u3001\u65E5\u5FD7\u65F6\u95F4\u6233\u7B49\u5173\u952E\u4FE1\u606F\u3002</p><p>\u5982\u679C\u4E3B\u8282\u70B9\u53D1\u73B0\u81EA\u5DF1\u65E0\u6CD5\u4E0E\u5927\u90E8\u5206\u8282\u70B9\u901A\u8BAF\u5219\u628A\u81EA\u5DF1\u964D\u7EA7\u4E3A secondary\u53EA\u8BFB\u8282\u70B9</p></blockquote><p><strong>\u4E3B\u8282\u70B9\u9009\u4E3E\u89E6\u53D1\u7684\u65F6\u673A</strong>:</p><ul><li>\u7B2C\u4E00\u6B21\u521D\u59CB\u5316\u4E00\u4E2A\u590D\u5236\u96C6</li><li>Secondary\u8282\u70B9\u6743\u91CD\u6BD4Primary\u8282\u70B9\u9AD8\u65F6\uFF0C\u53D1\u8D77\u66FF\u6362\u9009\u4E3E</li><li>Secondary\u8282\u70B9\u53D1\u73B0\u96C6\u7FA4\u4E2D\u6CA1\u6709Primary\u65F6\uFF0C\u53D1\u8D77\u9009\u4E3E</li><li>Primary\u8282\u70B9\u4E0D\u80FD\u8BBF\u95EE\u5230\u5927\u90E8\u5206(Majority)\u6210\u5458\u65F6\u4E3B\u52A8\u964D\u7EA7</li></ul><p>\u5F53\u89E6\u53D1\u9009\u4E3E\u65F6,Secondary\u8282\u70B9\u5C1D\u8BD5\u5C06\u81EA\u8EAB\u9009\u4E3E\u4E3APrimary\u3002<strong>\u4E3B\u8282\u70B9\u9009\u4E3E</strong>\u662F\u4E00\u4E2A\u4E8C\u9636\u6BB5\u8FC7\u7A0B+\u591A\u6570\u6D3E\u534F\u8BAE</p><ul><li>\u7B2C\u4E00\u9636\u6BB5: \u68C0\u6D4B\u81EA\u8EAB\u662F\u5426\u6709\u88AB\u9009\u4E3E\u7684\u8D44\u683C \u5982\u679C\u7B26\u5408\u8D44\u683C\u4F1A\u5411\u5176\u5B83\u8282\u70B9\u53D1\u8D77\u672C\u8282\u70B9\u662F\u5426\u6709\u9009\u4E3E\u8D44\u683C\u7684FreshnessCheck,\u8FDB\u884C\u540C\u50DA \u4EF2\u88C1</li><li>\u7B2C\u4E8C\u9636\u6BB5: \u53D1\u8D77\u8005\u5411\u96C6\u7FA4\u4E2D\u5B58\u6D3B\u8282\u70B9\u53D1\u9001Elect(\u9009\u4E3E)\u8BF7\u6C42\uFF0C\u4EF2\u88C1\u8005\u6536\u5230\u8BF7\u6C42\u7684\u8282\u70B9\u4F1A\u6267\u884C\u4E00\u7CFB\u5217\u5408\u6CD5\u6027\u68C0\u67E5\uFF0C\u5982\u679C\u68C0\u67E5\u901A\u8FC7\uFF0C\u5219\u4EF2\u88C1\u8005(\u4E00\u4E2A\u590D\u5236\u96C6\u4E2D\u6700\u591A50\u4E2A\u8282\u70B9 \u5176\u4E2D\u53EA\u67097\u4E2A\u5177\u6709\u6295\u7968\u6743)\u7ED9\u53D1\u8D77\u8005\u6295\u4E00\u7968\u3002 pv0\u901A\u8FC730\u79D2\u9009\u4E3E\u9501\u9632\u6B62\u4E00\u6B21\u9009\u4E3E\u4E2D\u4E24\u6B21\u6295\u7968\u3002 pv1\u4F7F\u7528\u4E86terms(\u4E00\u4E2A\u5355\u8C03\u9012\u589E\u7684\u9009\u4E3E\u8BA1\u6570\u5668)\u6765\u9632\u6B62\u5728\u4E00\u6B21\u9009\u4E3E\u4E2D\u6295\u4E24\u6B21\u7968\u7684\u60C5\u51B5\u3002</li><li>\u591A\u6570\u6D3E\u534F\u8BAE: \u53D1\u8D77\u8005\u5982\u679C\u83B7\u5F97\u8D85\u8FC7\u534A\u6570\u7684\u6295\u7968\uFF0C\u5219\u9009\u4E3E\u901A\u8FC7\uFF0C\u81EA\u8EAB\u6210\u4E3APrimary\u8282\u70B9\u3002\u83B7\u5F97\u4F4E\u4E8E\u534A\u6570\u9009\u7968\u7684\u539F\u56E0\uFF0C\u9664\u4E86\u5E38\u2EC5\u7684\u7F51\u7EDC\u95EE \u9898\u5916\uFF0C\u76F8\u540C\u4F18\u5148\u7EA7\u7684\u8282\u70B9\u540C\u65F6\u901A\u8FC7\u7B2C\u4E00\u9636\u6BB5\u7684\u540C\u50DA\u4EF2\u88C1\u5E76\u8FDB\u5165\u7B2C\u4E8C\u9636\u6BB5\u4E5F\u662F\u4E00\u4E2A\u539F\u56E0\u3002\u56E0\u6B64\uFF0C\u5F53\u9009\u7968\u4E0D\u8DB3\u65F6\uFF0C\u4F1A sleep[0,1]\u79D2\u5185\u7684\u968F\u673A\u65F6\u95F4\uFF0C\u4E4B\u540E\u518D\u6B21\u5C1D\u8BD5\u9009\u4E3E\u3002</li></ul><h3 id="_2-3-\u642D\u5EFA\u590D\u5236\u96C6" tabindex="-1"><a class="header-anchor" href="#_2-3-\u642D\u5EFA\u590D\u5236\u96C6" aria-hidden="true">#</a> 2.3 \u642D\u5EFA\u590D\u5236\u96C6</h3><ol><li>\u590D\u5236\u4E09\u4E2A\u7A0B\u5E8F\uFF0C\u7AEF\u53E3\u5B9A\u4E49\u4E3A27017\uFF0C27018\uFF0C27019\uFF0C\u642D\u5EFA\u4F2A\u96C6\u7FA4\uFF0C\u6587\u4EF6\u76EE\u5F55\u5982\u4E0B</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ tree <span class="token parameter variable">-L</span> <span class="token number">2</span>                                                                                                                
<span class="token builtin class-name">.</span>
\u251C\u2500\u2500 mongodb-27017
    \u251C\u2500\u2500 bin
    \u2514\u2500\u2500 mongo.conf
\u251C\u2500\u2500 mongodb-27018
    \u251C\u2500\u2500 bin
    \u2514\u2500\u2500 mongo.conf
\u2514\u2500\u2500 mongodb-27019
    \u251C\u2500\u2500 bin
    \u2514\u2500\u2500 mongo.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>\u4E09\u4E2A\u914D\u7F6E\u6587\u4EF6\u57FA\u672C\u76F8\u540C\uFF0C\u53EA\u6709\u7AEF\u53E3\u53F7\u7684\u533A\u522B\uFF0C\u5982\u4E0B</li></ol><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">dbpath</span><span class="token punctuation">=</span><span class="token value attr-value">/data/mongo/27017</span>
<span class="token key attr-name">port</span><span class="token punctuation">=</span><span class="token value attr-value">27017</span>
<span class="token key attr-name">bind_ip</span><span class="token punctuation">=</span><span class="token value attr-value">0.0.0.0</span>
<span class="token key attr-name">fork</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">logpath</span><span class="token punctuation">=</span><span class="token value attr-value">/data/mongo/logs/27017/mongo.log</span>
<span class="token key attr-name">replSet</span><span class="token punctuation">=</span><span class="token value attr-value">mongoCluster</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>\u521B\u5EFA\u5BF9\u5E94\u7684data\u548Clogs\u65E5\u5FD7\u76EE\u5F55</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>data/mongo
\u251C\u2500\u2500 <span class="token number">27017</span>
\u251C\u2500\u2500 <span class="token number">27018</span>
\u251C\u2500\u2500 <span class="token number">27019</span>
\u2514\u2500\u2500 logs
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>\u542F\u52A8\u4E09\u4E2A\u5B9E\u4F8B</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$  mongodb-27017/bin/mongod <span class="token parameter variable">-f</span> mongodb-27017/mongo.conf
$  mongodb-27018/bin/mongod <span class="token parameter variable">-f</span> mongodb-27018/mongo.conf
$  mongodb-27019/bin/mongod <span class="token parameter variable">-f</span> mongodb-27019/mongo.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>\u521D\u59CB\u5316\u8282\u70B9-\u8FDB\u5165\u5230\u4E00\u4E2Amongo\u8282\u70B9\u4E2D\u6267\u884C</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> cfg<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string-property property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token string">&quot;mongoCluster&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;protocolVersion&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string-property property">&quot;members&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string-property property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string-property property">&quot;host&quot;</span><span class="token operator">:</span><span class="token string">&quot;10.0.24.3:27017&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string-property property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string-property property">&quot;host&quot;</span><span class="token operator">:</span><span class="token string">&quot;10.0.24.3:27018&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string-property property">&quot;_id&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string-property property">&quot;host&quot;</span><span class="token operator">:</span><span class="token string">&quot;10.0.24.3:27019&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

rs<span class="token punctuation">.</span><span class="token function">initiate</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="6"><li><p>\u8282\u70B9\u7684\u52A8\u6001\u589E\u5220</p><ul><li>\u589E <code>rs.add(&quot;ip:port&quot;)</code></li><li>\u5220 <code>rs.remove(&quot;ip:port&quot;)</code></li></ul></li><li><p>\u52A0\u5165\u4EF2\u88C1\u8282\u70B9(\u53EF\u4E0D\u52A0)</p><p>\u542F\u52A8\u4E00\u4E2A\u4EF2\u88C1\u5B9E\u4F8B27020\uFF0C\u7136\u540E\u5728\u590D\u5236\u96C6\u4E2D\u6267\u884C</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">mongoCluster</span><span class="token operator">:</span><span class="token constant">PRIMARY</span><span class="token operator">&gt;</span> rs<span class="token punctuation">.</span><span class="token function">addArb</span><span class="token punctuation">(</span><span class="token string">&quot;10.0.24.3:27020&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token string-property property">&quot;ok&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;$clusterTime&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;clusterTime&quot;</span> <span class="token operator">:</span> <span class="token function">Timestamp</span><span class="token punctuation">(</span><span class="token number">1670917290</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string-property property">&quot;signature&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token string-property property">&quot;hash&quot;</span> <span class="token operator">:</span> <span class="token function">BinData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token string-property property">&quot;keyId&quot;</span> <span class="token operator">:</span> <span class="token function">NumberLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;operationTime&quot;</span> <span class="token operator">:</span> <span class="token function">Timestamp</span><span class="token punctuation">(</span><span class="token number">1670917290</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="_2-4-\u590D\u5236\u96C6\u6210\u5458\u7684\u914D\u7F6E\u53C2\u6570" tabindex="-1"><a class="header-anchor" href="#_2-4-\u590D\u5236\u96C6\u6210\u5458\u7684\u914D\u7F6E\u53C2\u6570" aria-hidden="true">#</a> 2.4 \u590D\u5236\u96C6\u6210\u5458\u7684\u914D\u7F6E\u53C2\u6570</h3><blockquote><p>\u5BF9\u5E94<code>var cfg=...</code></p></blockquote><table><thead><tr><th style="text-align:center;">\u53C2\u6570\u5B57\u6BB5</th><th style="text-align:center;">\u7C7B\u578B\u4E66\u540D</th><th style="text-align:center;">\u53D6\u503C</th><th style="text-align:center;">\u8BF4\u660E</th></tr></thead><tbody><tr><td style="text-align:center;">_id</td><td style="text-align:center;">\u6574\u6570</td><td style="text-align:center;">_id:0</td><td style="text-align:center;">\u590D\u5236\u96C6\u4E2D\u7684\u6807\u793A</td></tr><tr><td style="text-align:center;">host</td><td style="text-align:center;">\u5B57\u7B26\u4E32</td><td style="text-align:center;">host:&quot;\u4E3B\u673A:\u7AEF\u53E3&quot;</td><td style="text-align:center;">\u8282\u70B9\u4E3B\u673A\u540D</td></tr><tr><td style="text-align:center;">arbiterOnly</td><td style="text-align:center;">\u5E03\u5C14\u503C</td><td style="text-align:center;">arbiterOnly:true</td><td style="text-align:center;">\u662F\u5426\u4E3A\u4EF2\u88C1(\u88C1\u5224)\u8282\u70B9</td></tr><tr><td style="text-align:center;">priority</td><td style="text-align:center;">\u6574\u6570</td><td style="text-align:center;">priority=0..n</td><td style="text-align:center;">\u9ED8\u8BA41\uFF0C\u662F\u5426\u6709\u8D44\u683C\u53D8\u6210\u4E3B\u8282\u70B9\uFF0C<br>\u53D6\u503C\u8303\u56F40-1000\uFF0C0 \u8FDC\u4E0D\u4F1A\u53D8\u6210\u4E3B\u8282\u70B9</td></tr><tr><td style="text-align:center;">hidden</td><td style="text-align:center;">\u5E03\u5C14\u503C</td><td style="text-align:center;">0\u62161</td><td style="text-align:center;">\u9690\u85CF\uFF0C\u6743\u91CD\u5FC5\u987B\u4E3A0\uFF0C\u624D\u53EF\u4EE5\u8BBE\u7F6E</td></tr><tr><td style="text-align:center;">votes</td><td style="text-align:center;">\u6574\u6570</td><td style="text-align:center;">0\u62161</td><td style="text-align:center;">\u6295\u7968\uFF0C\u662F\u5426\u4E3A\u6295\u7968\u8282\u70B9,0 \u4E0D\u6295\u7968\uFF0C1\u6295\u7968</td></tr><tr><td style="text-align:center;">slaveDelay</td><td style="text-align:center;">\u6574\u6570</td><td style="text-align:center;">slaveDelay=3600</td><td style="text-align:center;">\u4ECE\u5E93\u7684\u5EF6\u8FDF\u591A\u5C11\u79D2</td></tr><tr><td style="text-align:center;">buildIndexes</td><td style="text-align:center;">\u5E03\u5C14\u503C</td><td style="text-align:center;">0\u62161</td><td style="text-align:center;">\u4E3B\u5E93\u7684\u7D22\u5F15\uFF0C\u4ECE\u5E93\u4E5F\u521B\u5EFA\uFF0C_id\u7D22\u5F15\u65E0\u6548</td></tr></tbody></table><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>version: &#39;3.3&#39;
services:
  mongo_rs_1:
    env_file:
      - .env
    image: mongo:4.2
    container_name: mongo_rs_1
    restart: always
    ports:
      - \${MONGO_RS_1_PORT}:27017
    volumes:
      - \${PWD}/rs1/db:/data/db
      - \${PWD}/rs1/log:/var/log/mongodb
      - \${PWD}/rs1/config:/etc/mongo
    command: 
      - --replSet
      - rs
  mongo_rs_2:
    image: mongo:4.2
    container_name: mongo_rs_2
    restart: always
    ports:
      - \${MONGO_RS_2_PORT}:27017
    volumes:
      - \${PWD}/rs2/db:/data/db
      - \${PWD}/rs2/log:/var/log/mongodb
      - \${PWD}/rs2/config:/etc/mongo
    command: 
      - --replSet
      - rs
  mongo_rs_3:
    image: mongo:4.2
    container_name: mongo_rs_3
    restart: always
    ports:
      - \${MONGO_RS_3_PORT}:27017
    volumes:
      - \${PWD}/rs3/db:/data/db
      - \${PWD}/rs3/log:/var/log/mongodb
      - \${PWD}/rs3/config:/etc/mongo
    command: 
      - --replSet
      - rs
  mongo_rs_init:
    image: mongo:4.2
    depends_on: 
      - mongo_rs_1
      - mongo_rs_2
      - mongo_rs_3
    restart: on-failure:5
    command: 
      - mongo
      - mongodb://mongo_rs_1:27017/admin
      - --eval
      - &#39;rs.initiate({ _id: &quot;rs&quot;, members: [{_id:1,host:&quot;mongo_rs_1:27017&quot;},{_id:2,host:&quot;mongo_rs_2:27017&quot;},{_id:3,host:&quot;mongo_rs_3:27017&quot;}]})&#39;

# rs.secondaryOk()
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-\u5206\u7247\u96C6\u7FA4" tabindex="-1"><a class="header-anchor" href="#_3-\u5206\u7247\u96C6\u7FA4" aria-hidden="true">#</a> 3. \u5206\u7247\u96C6\u7FA4</h2><blockquote><p>\u5206\u7247(sharding)\u662FMongoDB\u7528\u6765\u5C06\u5927\u578B\u96C6\u5408\u6C34\u5E73\u5206\u5272\u5230\u4E0D\u540C\u7684\u670D\u52A1\u5668(\u6216\u8005\u590D\u5236\u96C6)\u4E0A\u91C7\u7528\u7684\u65B9\u6CD5\uFF0C\u4E0D\u9700\u8981\u529F\u80FD\u5F3A\u5927\u7684\u5927\u578B\u8BA1\u7B97\u673A\u5C31\u53EF\u4EE5\u5B58\u50A8\u66F4\u591A\u7684\u6570\u636E\uFF0C\u4EE5\u5904\u7406\u66F4\u5927\u7684\u8D1F\u8F7D</p></blockquote><h3 id="_3-1-\u4E3A\u4EC0\u4E48\u8981\u5206\u7247" tabindex="-1"><a class="header-anchor" href="#_3-1-\u4E3A\u4EC0\u4E48\u8981\u5206\u7247" aria-hidden="true">#</a> 3.1 \u4E3A\u4EC0\u4E48\u8981\u5206\u7247</h3><ol><li>\u5B58\u50A8\u5BB9\u91CF\u9700\u6C42\u8D85\u51FA\u5355\u673A\u78C1\u76D8\u5BB9\u91CF</li><li>\u6D3B\u8DC3\u7684\u6570\u636E\u96C6\u8D85\u51FA\u5355\u673A\u5185\u5B58\u5BB9\u91CF\uFF0C\u5BFC\u81F4\u5F88\u591A\u8BF7\u6C42\u90FD\u8981\u4ECE\u78C1\u76D8\u8BFB\u53D6\u6570\u636E\uFF0C\u5F71\u54CD\u6027\u80FD</li><li>IOPS\u8D85\u51FA\u5355\u4E2AMongoDB\u8282\u70B9\u7684\u670D\u52A1\u80FD\u529B\uFF0C\u968F\u7740\u6570\u636E\u7684\u589E\u2ED3\uFF0C\u5355\u673A\u5B9E\u4F8B\u7684\u74F6\u9888\u4F1A\u8D8A\u6765\u8D8A\u660E\u663E</li><li>\u526F\u672C\u96C6\u5177\u6709\u8282\u70B9\u6570\u91CF\u9650\u5236</li></ol><blockquote><p>\u5782\u76F4\u6269\u5C55\uFF1A\u589E\u52A0\u66F4\u591A\u7684CPU\u548C\u5B58\u50A8\u8D44\u6E90\u6765\u6269\u5C55\u5BB9\u91CF</p><p>\u6C34\u5E73\u6269\u5C55\uFF1A\u5C06\u6570\u636E\u96C6\u5206\u5E03\u5728\u591A\u4E2A\u670D\u52A1\u5668\u4E0A\u3002\u6C34\u5E73\u6269\u5C55\u5373\u5206\u7247</p></blockquote><h3 id="_3-2-\u5206\u7247\u7684\u5DE5\u4F5C\u539F\u7406" tabindex="-1"><a class="header-anchor" href="#_3-2-\u5206\u7247\u7684\u5DE5\u4F5C\u539F\u7406" aria-hidden="true">#</a> 3.2 \u5206\u7247\u7684\u5DE5\u4F5C\u539F\u7406</h3><p><img src="https://s2.loli.net/2022/12/13/KhfVlqBwjULoRT8.png" alt="image.png"></p><p>\u5206\u7247\u96C6\u7FA4\u7531\u4E09\u4E2A\u670D\u52A1\u7EC4\u6210\uFF1A</p><ul><li><code>Shards Server</code>: \u6BCF\u4E2Ashard\u7531\u4E00\u4E2A\u6216\u591A\u4E2Amongod\u8FDB\u7A0B\u7EC4\u6210\uFF0C\u7528\u4E8E\u5B58\u50A8\u6570\u636E</li><li><code>Router Server</code>: \u6570\u636E\u5E93\u96C6\u7FA4\u7684\u8BF7\u6C42\u5165\u53E3\uFF0C\u6240\u6709\u8BF7\u6C42\u90FD\u901A\u8FC7Router(mongos)\u8FDB\u884C\u534F\u8C03\uFF0C\u4E0D\u9700\u8981\u5728\u5E94\u7528\u7A0B\u5E8F\u6DFB\u52A0\u4E00\u4E2A \u8DEF\u7531\u9009\u62E9\u5668,Router(mongos)\u5C31\u662F\u4E00\u4E2A\u8BF7\u6C42\u5206\u53D1\u4E2D\u5FC3\u5B83\u8D1F\u8D23\u628A\u5E94\u7528\u7A0B\u5E8F\u7684\u8BF7\u6C42\u8F6C\u53D1\u5230\u5BF9\u5E94\u7684Shard\u670D\u52A1\u5668\u4E0A</li><li><code>Config Server</code>: \u914D\u7F6E\u670D\u52A1\u5668\u3002\u5B58\u50A8\u6240\u6709\u6570\u636E\u5E93\u5143\u4FE1\u606F(\u8DEF\u7531\u3001\u5206\u7247)\u7684\u914D\u7F6E</li></ul><p><strong>\u76F8\u5173\u6982\u5FF5</strong></p><ul><li><p><strong>\u7247\u952E\uFF08shard key\uFF09</strong></p><p>\u4E3A\u4E86\u5728\u6570\u636E\u96C6\u5408\u4E2D\u5206\u914D\u6587\u6863\uFF0CMongoDB\u4F7F\u7528\u5206\u7247\u4E3B\u952E\u5206\u5272\u96C6\u5408</p></li><li><p><strong>\u533A\u5757 \uFF08chunk\uFF09</strong></p><p>\u5728\u4E00\u4E2Ashard server\u5185\u90E8\uFF0CMongoDB\u8FD8\u662F\u4F1A\u628A\u6570\u636E\u5206\u4E3Achunks\uFF0C\u6BCF\u4E2Achunk\u4EE3\u8868\u8FD9\u4E2Ashard server\u5185\u90E8\u4E00\u90E8 \u5206\u6570\u636E\u3002MongoDB\u5206\u5272\u5206\u7247\u6570\u636E\u5230\u533A\u5757\uFF0C\u6BCF\u4E00\u4E2A\u533A\u5757\u5305\u542B\u57FA\u4E8E\u5206\u7247\u4E3B\u952E\u7684\u5DE6\u95ED\u53F3\u5F00\u7684\u533A\u95F4\u8303\u56F4</p></li><li><p><strong>\u5206\u7247\u7B56\u7565</strong></p></li></ul><p><strong>\u8303\u56F4\u5206\u7247</strong><img src="https://s2.loli.net/2022/12/13/WT1dyaYJDMgb2ur.png" alt=""></p><p>\u200B \u8303\u56F4\u5206\u7247\u662F\u57FA\u4E8E\u5206\u7247\u4E3B\u952E\u7684\u503C\u5207\u5206\u6570\u636E\uFF0C\u6BCF\u4E00\u4E2A\u533A\u5757\u5C06\u4F1A\u5206\u914D\u5230\u4E00\u4E2A\u8303\u56F4</p><p>\u200B \u8303\u56F4\u5206\u7247\u9002\u5408\u6EE1\u8DB3\u5728\u4E00\u5B9A\u8303\u56F4\u5185\u7684\u67E5\u627E\uFF0C\u4F8B\u5982\u67E5\u627EX\u7684\u503C\u5728[20,30)\u4E4B\u95F4\u7684\u6570\u636E\uFF0Cmongo \u8DEF\u7531\u6839\u636EConfig server\u4E2D\u5B58\u50A8\u7684\u5143\u6570\u636E\uFF0C\u53EF\u4EE5\u76F4\u63A5\u5B9A\u4F4D\u5230\u6307\u5B9A\u7684shard\u7684Chunk\u4E2D</p><p><strong>\u7F3A\u70B9</strong>: \u5982\u679Cshard key\u6709\u660E\u663E\u9012\u589E(\u6216\u8005\u9012\u51CF)\u8D8B\u52BF\uFF0C\u5219\u65B0\u63D2\u5165\u7684\u6587\u6863\u591A\u4F1A\u5206\u5E03\u5230\u540C\u4E00\u4E2Achunk\uFF0C\u65E0\u6CD5\u6269\u5C55\u5199\u7684\u80FD\u529B</p><p><strong>HASH\u5206\u7247</strong></p><p><img src="https://s2.loli.net/2022/12/13/vupLQehjZxVf6WB.png" alt="image.png"></p><p>Hash\u5206\u7247\u662F\u8BA1\u7B97\u4E00\u4E2A\u5206\u7247\u4E3B\u952E\u7684hash\u503C\uFF0C\u6BCF\u4E00\u4E2A\u533A\u5757\u5C06\u5206\u914D\u4E00\u4E2A\u8303\u56F4\u7684hash\u503C</p><p>Hash\u5206\u7247\u4E0E\u8303\u56F4\u5206\u7247\u4E92\u8865\uFF0C\u80FD\u5C06\u6587\u6863\u968F\u673A\u7684\u5206\u6563\u5230\u5404\u4E2Achunk\uFF0C\u5145\u5206\u7684\u6269\u5C55\u5199\u80FD\u529B\uFF0C\u5F25\u8865\u4E86\u8303\u56F4\u5206\u7247\u7684\u4E0D\u8DB3\uFF0C</p><p><strong>\u7F3A\u70B9</strong>\uFF1A\u4E0D\u80FD\u9AD8\u6548\u7684\u670D\u52A1\u8303\u56F4\u67E5\u8BE2\uFF0C\u6240\u6709\u7684\u8303\u56F4\u67E5\u8BE2\u8981\u5206\u53D1\u5230\u540E\u7AEF\u6240\u6709\u7684Shard\u624D\u80FD\u627E\u51FA\u6EE1\u8DB3\u6761\u4EF6\u7684\u6587\u6863</p><p><strong>\u7EC4\u5408\u7247\u952E</strong> \u6570\u636E\u5E93\u4E2D\u6CA1\u6709\u6BD4\u8F83\u5408\u9002\u7684\u7247\u952E\u4F9B\u9009\u62E9\uFF0C\u6216\u8005\u662F\u6253\u7B97\u4F7F\u7528\u7684\u7247\u952E\u57FA\u6570\u592A\u5C0F(\u5373\u53D8\u5316\u5C11\u5982\u661F\u671F\u53EA\u67097\u5929\u53EF\u53D8\u5316)\uFF0C \u53EF\u4EE5\u9009\u53E6\u4E00\u4E2A\u5B57\u6BB5\u4F7F\u7528\u7EC4\u5408\u7247\u952E\uFF0C\u751A\u81F3\u53EF\u4EE5\u6DFB\u52A0\u5197\u4F59\u5B57\u6BB5\u6765\u7EC4\u5408\u3002\u4E00\u822C\u662F\u7C97\u7C92\u5EA6+\u7EC6\u7C92\u5EA6\u8FDB\u884C\u7EC4\u5408\u3002</p><blockquote><p>\u5408\u7406\u9009\u62E9shard key</p><p>\u65E0\u975E\u4ECE\u4E24\u4E2A\u65B9\u9762\u8003\u8651\uFF0C\u6570\u636E\u7684\u67E5\u8BE2\u548C\u5199\u5165\uFF0C\u6700\u597D\u7684\u6548\u679C\u5C31\u662F\u6570\u636E\u67E5\u8BE2\u65F6\u80FD\u547D\u4E2D\u66F4\u5C11\u7684\u5206\u7247\uFF0C\u6570\u636E\u5199\u5165\u65F6\u80FD\u591F\u968F\u673A\u7684\u5199\u5165\u6BCF\u4E2A\u5206\u7247\uFF0C\u5173\u952E\u5728\u4E8E\u5982\u4F55\u6743\u8861\u6027\u80FD\u548C\u8D1F\u8F7D\u3002</p></blockquote><h3 id="_3-3-\u642D\u5EFA\u5206\u7247\u96C6\u7FA4" tabindex="-1"><a class="header-anchor" href="#_3-3-\u642D\u5EFA\u5206\u7247\u96C6\u7FA4" aria-hidden="true">#</a> 3.3 \u642D\u5EFA\u5206\u7247\u96C6\u7FA4</h3><p>\u7ED3\u6784</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ tree -L 1 .                                                                                                                            
.
\u251C\u2500\u2500 config-17017
\u251C\u2500\u2500 config-17018
\u251C\u2500\u2500 config-17019
\u251C\u2500\u2500 mongodb-linux-x86_64-rhel70-4.2.23.tgz
\u251C\u2500\u2500 route-27017
\u251C\u2500\u2500 shard-1-37017
\u251C\u2500\u2500 shard-1-37018
\u251C\u2500\u2500 shard-1-37019
\u251C\u2500\u2500 shard-2-47017
\u251C\u2500\u2500 shard-2-47018
\u251C\u2500\u2500 shard-2-47019
\u251C\u2500\u2500 shard-3-57017
\u251C\u2500\u2500 shard-3-57018
\u251C\u2500\u2500 shard-3-57019
\u251C\u2500\u2500 start-config.sh
\u251C\u2500\u2500 start-mongo-all.sh
\u251C\u2500\u2500 start-route.sh
\u251C\u2500\u2500 start-shard.sh
\u2514\u2500\u2500 stop-mongo-all.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u914D\u7F6E\u8282\u70B9</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ cat config-17017/mongo.conf                                                                                                            
dbpath=/data/mongo/shard/config/config1
port=17017
bind_ip=0.0.0.0
fork=true
logpath=/data/mongo/shard/config/config1/logs/config.log
logappend=true
# \u914D\u7F6E\u670D\u52A1\u5668
configsvr=true
# \u914D\u7F6E\u670D\u52A1\u5668\u526F\u672C\u96C6\u540D
replSet=configsvr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FDB\u884C\u914D\u7F6E</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>use admin
var cfg = {&quot;_id&quot;:&quot;configsvr&quot;,
&quot;members&quot;:[
    {&quot;_id&quot;:1,&quot;host&quot;:&quot;10.0.24.3:17017&quot;},
    {&quot;_id&quot;:2,&quot;host&quot;:&quot;10.0.24.3:17018&quot;},
    {&quot;_id&quot;:3,&quot;host&quot;:&quot;10.0.24.3:17019&quot;},
]}
rs.initiate(cfg)

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5206\u7247\u96C6\u7FA4\u8282\u70B9</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ cat shard-1-37017/mongo.conf                                                                                                           
dbpath=/data/mongo/shard/1/37017
port=37017
bind_ip=0.0.0.0
fork=true
logpath=/data/mongo/shard/1/37017/logs/mongo.log
replSet=shard1
shardsvr=true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6BCF\u4E2A\u96C6\u7FA4\u90FD\u8FDB\u884C\u914D\u7F6E</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>var cfg = {
    &quot;_id&quot;:&quot;shard1&quot;,
    &quot;protocolVersion&quot;:1,
    &quot;members&quot;:[
        {&quot;_id&quot;:1,&quot;host&quot;:&quot;10.0.24.3:37017&quot;},
        {&quot;_id&quot;:2,&quot;host&quot;:&quot;10.0.24.3:37018&quot;},
        {&quot;_id&quot;:3,&quot;host&quot;:&quot;10.0.24.3:37019&quot;},
    ]
};
rs.initiate(cfg)
rs.status()
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8DEF\u7531\u8282\u70B9</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ cat route-27017/mongo.conf                                                                                                             
port=27017
bind_ip=0.0.0.0
fork=true
logpath=/data/mongo/shard/route/27017/logs/mongo.log
configdb=configsvr/10.0.24.3:17017,10.0.24.3:17018,10.0.24.3:17019
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F9D\u6B21\u542F\u52A8\u914D\u7F6E\u3001\u5206\u7247\u96C6\u7FA4\u3001\u8DEF\u7531\u8282\u70B9(\u914D\u7F6E\u9700\u8981\u5728\u542F\u52A8\u540E\u64CD\u4F5C)</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ cat start-config.sh                                                                                                                    
#!/bin/bash

echo &quot;mongo shard config&quot;
for port in {17017..17019}
do
    config-\${port}/bin/mongod -f config-\${port}/mongo.conf
    echo &quot;\${port} started.&quot;
done

---
$ cat start-route.sh                                                                                                                     
#!/bin/bash

echo &quot;mongo shard route&quot;
for port in {27017..27017}
do
    route-\${port}/bin/mongos -f route-\${port}/mongo.conf
    echo &quot;\${port} started.&quot;
done
---
$ cat start-route.sh                                                                                                                     
#!/bin/bash

echo &quot;mongo shard route&quot;
for port in {27017..27017}
do
    route-\${port}/bin/mongos -f route-\${port}/mongo.conf
    echo &quot;\${port} started.&quot;
done
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FDB\u5165\u5230\u8DEF\u7531\u8282\u70B9\uFF0C\u6DFB\u52A0\u96C6\u7FA4</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sh.addShard(&quot;shard1/10.0.24.3:37017,10.0.24.3:37018,10.0.24.3:37019&quot;)
sh.addShard(&quot;shard2/10.0.24.3:47017,10.0.24.3:47018,10.0.24.3:47019&quot;)
sh.addShard(&quot;shard3/10.0.24.3:57017,10.0.24.3:57018,10.0.24.3:57019&quot;)
sh.status()
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F00\u542F\u6570\u636E\u5E93\u548C\u96C6\u5408\u5206\u7247</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sh.enableSharding(&quot;\u6570\u636E\u5E93\u540D\u79F0&quot;)

sh.shardCollection(&quot;\u6570\u636E\u5E93\u540D\u79F0.\u96C6\u5408\u540D\u79F0&quot;,{&quot;\u7247\u952E\u540D\u79F0\u5982name&quot;:\u7D22\u5F15\u8BF4\u660E})
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,83),l=[t];function o(r,d){return s(),e("div",null,l)}const u=n(i,[["render",o],["__file","cluster.html.vue"]]);export{u as default};
