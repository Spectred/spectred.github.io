# MongoDB - 集群

## 1. ~~主从复制~~

> 4.0 后已弃用

主从架构中，master节点负责数据的读写，slave没有写入权限只能读取

在主从结构中，主节点的操作记录为`oplog`,它存储在系统该数据库`local`的`oplog.$main`集合中，这个集合的每个文档都代表主节点上执行的一个操作。从服务器会定期从主服务器获取oplog记录，然后在本机上执行。对于存储oplog的集合，Mongo采用固定集合，即新操作会覆盖旧操作。

由于没有自动故障转移，需要指定master和slave端，不推荐在生产中使用，且4.0后不再支持主从复制

## 2. 复制集 Replica Sets

复制集是由一组拥有相同数据集的mongod实例组成的集群，由2台或2台以上的服务器组成，以及复制集成员包括`Primary`主节点、`Secondary`从节点和投票节点。

复制集提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性，保证数据的安全性。相比于主从多了**自动切换**的功能

### 2.1 为什么要使用复制集

- 高可用： 防止设备故障，提供自动failover功能
- 灾难恢复：发生故障时，可从其他节点恢复，用于备份
- 读写隔离： 可在备节点执行读，减少主库压力，如用于分析 报表 数据挖掘 系统任务等

### 2.2 复制集集群架构原理

原理和主从复制相同，

**oplog**具有幂等性，组成结构如下

```
{
	"ts" : Timestamp(1446011584, 2),
	"h" : NumberLong("1687359108795812092"),
	"v" : 2,
	"op" : "i",
	"ns" : "test.nosql",
	"o" : { "_id" : ObjectId("563062c0b085733f34ab4129"), "name" : "mongodb", "score" : "10"}
}
ts:操作时间，当前timestamp + 计数器，计数器每秒都被重置
h:操作的全局唯一标识
v:oplog版本信息
op:操作类型
  i:插入操作
  u:更新操作
  d:删除操作 c:执行命令(如createDatabase，dropDatabase)
n:空操作，特殊用途
ns:操作针对的集合
o:操作内容 o2:更新查询条件,仅update操作包含该字段
```





