---
sidebar: 'auto'
sidebarDepth: 1
---
# åˆ†å¸ƒå¼

> ğŸ‘ğŸ» [å‡¤å‡°æ¶æ„](https://icyfenix.cn/)

## 1. åˆ†å¸ƒå¼é”

> [æ·±åº¦å‰–æï¼šRedisåˆ†å¸ƒå¼é”åˆ°åº•å®‰å…¨å—ï¼Ÿçœ‹å®Œè¿™ç¯‡æ–‡ç« å½»åº•æ‡‚äº†ï¼](https://mp.weixin.qq.com/s/s8xjm1ZCKIoTGT3DCVA4aw)
>
> [Redisson-8.åˆ†å¸ƒå¼é”å’ŒåŒæ­¥å™¨](https://github.com/redisson/redisson/wiki/8.-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%92%8C%E5%90%8C%E6%AD%A5%E5%99%A8)

åˆ†å¸ƒå¼é”å®ç°å¤šä¸ªè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„äº’æ–¥ã€‚å®ç°æ–¹å¼ä¸Šå¯ä»¥é‡‡ç”¨ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶æ¥åšï¼Œå¦‚`MySQL`ã€`ZooKeeper`ã€`Redis`ã€`etcd`ç­‰

### 1.1 åŸºäºå…³ç³»å‹æ•°æ®åº“(MySQL)çš„åˆ†å¸ƒå¼é”

æ‚²è§‚é”ï¼š `select id from t where col = xx for update`ï¼Œä¼šä¸€ç›´é˜»å¡åˆ°äº‹åŠ¡æäº¤ï¼Œ

ä¹è§‚é”: `select id,old_version from t where col = xx`å’Œ `update t set ver = old_version+1 where col=xx and ver=old_verison`

### 1.2 åŸºäºRedisçš„åˆ†å¸ƒå¼é”

#### 1.2.1 `setnx lock v` å’Œ`del lock`

**åŠ é”**æ—¶å®¢æˆ·ç«¯1åŠ é”æˆåŠŸ `SETNX lock 1 => 1`,å®¢æˆ·ç«¯2åŠ é”å¤±è´¥`SETNX lock 1 => 0`

**è§£é”**æ—¶å®¢æˆ·ç«¯1 `del lock => 1`

**å­˜åœ¨çš„é—®é¢˜**: å½“å®¢æˆ·ç«¯1ä¸­æ²¡èƒ½é‡Šæ”¾é”(å¦‚ä¸šåŠ¡å¼‚å¸¸æˆ–è¿›ç¨‹å´©æºƒ)ï¼Œå¯¼è‡´å…¶ä»–å®¢æˆ·ç«¯ä¸€ç›´éƒ½æ‹¿ä¸åˆ°é”ï¼Œå¯¼è‡´æ­»é” ï¼ˆè¿™ç§æƒ…å†µéœ€è¦äººå·¥ä»‹å…¥è§£é”ï¼‰

#### 1.2.2 `set lock v ex n nx`

ä¸ºäº†é¿å…æ­»é”çš„é—®é¢˜ï¼Œæ·»åŠ è¿‡æœŸæ—¶é—´è‡ªåŠ¨é‡Šæ”¾é”ï¼Œç”¨ä¸€è¡Œå‘½ä»¤ä¿è¯åŸå­æ€§ï¼Œå¦‚`set lock 1 ex 10 nx => OK`,å…¶ä»–å®¢æˆ·ç«¯å°è¯•åŠ é”æ—¶è¿”å›`(nil)`

**å­˜åœ¨çš„é—®é¢˜:** 

A. è¿‡æœŸæ—¶é—´å¯èƒ½ä¸å‡†ç¡®ï¼Œè®¾ç½®å°‘äº†å¯¼è‡´æå‰é‡Šæ”¾é”ï¼Œè®¾ç½®å¤šäº†ä¼šåŠ é”æ—¶é—´è¿‡é•¿(ä¸€èˆ¬æ²¡è¿™ä¸ªé—®é¢˜ï¼Œé”å¯ä»¥é‡Šæ”¾æ—¶å¯ä»¥æŒ‡å®šdel lock,ä½†æ˜¯ä¼šå¯¼è‡´Bé—®é¢˜)ï¼Œ

B. ä¸€ä¸ªå®¢æˆ·ç«¯å¯èƒ½é‡Šæ”¾äº†å…¶ä»–å®¢æˆ·ç«¯é”æŒæœ‰çš„é”

#### 1.2.3 `set lock $uuid ex n nx`

å¯¹äºå®¢æˆ·ç«¯é‡Šæ”¾å…¶ä»–å®¢æˆ·ç«¯æŒæœ‰é”çš„é—®é¢˜ï¼Œå¯ä»¥å°†valè®¾ç½®ä¸ºä¸€ä¸ªéšæœºä¸”å”¯ä¸€çš„å€¼(åªæœ‰åŠ é”çš„å®¢æˆ·ç«¯çŸ¥é“ï¼Œä¹Ÿå¯ä»¥æ˜¯çº¿ç¨‹å·)

**åŠ é”**æ—¶: `set lock 45r8iu ex 10 nx` 

**è§£é”**æ—¶: é‡‡ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰å®¢æˆ·ç«¯åŠ é”ï¼Œæ˜¯çš„è¯è¿›è¡Œåˆ é™¤

```lua
// åˆ¤æ–­é”æ˜¯è‡ªå·±çš„ï¼Œæ‰é‡Šæ”¾
if redis.call("GET",KEYS[1]) == ARGV[1]
then
    return redis.call("DEL",KEYS[1])
else
    return 0
end
```

#### 1.2.4 ä½¿ç”¨[Redisson](https://github.com/redisson/redisson)

ä¸ºäº†è§£å†³é”å¯èƒ½æå‰è¿‡æœŸçš„é—®é¢˜ï¼Œå¯ä»¥åœ¨åŠ é”æ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œç„¶åé€šè¿‡å®ˆæŠ¤çº¿ç¨‹å®šæ—¶æ£€æµ‹é”çš„å¤±æ•ˆæ—¶é—´ï¼Œå¦‚æœå¿«è¿‡æœŸäº†ä½†æ˜¯ä¸šåŠ¡æ“ä½œè¿˜æœªå®Œæˆï¼Œå°±è‡ªåŠ¨è¿›è¡Œç»­æœŸ

> æ­¤æ—¶ï¼Œåªé€šè¿‡Redisè§£å†³åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆå¦‚ä¸‹ï¼š
>
> 1. ğŸ”åŠ é”æ—¶ï¼Œé‡‡ç”¨`set lock $uuid ex 10 nx`ï¼Œæ¥ä¿è¯äº’æ–¥æ€§ï¼Œè‡ªåŠ¨å¤±æ•ˆæ€§ï¼Œåªèƒ½åŠ é”å®¢æˆ·ç«¯è§£é”ï¼Œå¹¶ä¸”å¼€å¯å®ˆæŠ¤çº¿ç¨‹æ£€æµ‹å¤±æ•ˆï¼Œæ ¹æ®ä¸šåŠ¡å†³å®šæ˜¯å¦éœ€è¦ç»­æœŸ
> 2. ğŸ”“è§£é”æ—¶, é€šè¿‡Luaè„šæœ¬ä¿è¯åŸå­æ€§ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦ä¸ºå®¢æˆ·å•åŠ é”ï¼Œæ˜¯çš„è¯æ‰è§£é”

**`Redisson`çš„åˆ†å¸ƒå¼é”åŸç†æ˜¯æ€æ ·çš„ï¼Ÿ**

**åŠ é”ï¼š**

Redissoné¦–å…ˆé€šè¿‡hashé€‰æ‹©ä¸€ä¸ªredisèŠ‚ç‚¹ï¼Œç„¶åæ‰§è¡ŒåŠ é”çš„Luaè„šæœ¬æ¥ä¿è¯åŸå­æ€§ï¼Œè®¾ç½®ä¸€ä¸ªhashç»“æ„çš„é” `hset lock $uuid:1 1`,å…¶ä¸­$uudi:1è¡¨ç¤ºå®Œæˆäº†åŠ é”ï¼Œvalçš„1è¡¨ç¤ºåŠ é”åŠ äº†ä¸€æ¬¡(å¯é‡å…¥)ï¼Œ

å½“å…¶ä»–å®¢æˆ·æ®µæƒ³è·å–é”æ—¶æ‰§è¡ŒåŒæ ·çš„è„šæœ¬å…ˆåˆ¤æ–­key lockæ˜¯å¦å­˜åœ¨ï¼Œåœ¨åˆ¤æ–­æ˜¯å¦æœ‰å®¢æˆ·ç«¯2çš„IDï¼Œä»¥åŠé”çš„å‰©ä½™æ—¶é—´ï¼Œè¿›è¡Œè‡ªæ—‹ï¼Œ

åœ¨åŠ é”æˆåŠŸçš„åŒæ—¶ä¼šå¯ç”¨ä¸€ä¸ª`watch dog`çš„åå°çº¿ç¨‹ï¼Œæ¯éš”10ç§’è¿›è¡Œæ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦ç»­æœŸ

**è§£é”ï¼š**

ç”±äºæ˜¯å¯é‡å…¥é”ï¼Œå½“valå€¼ä¸º0æ—¶è¡¨ç¤ºä¸å†æŒæœ‰é”ï¼Œé€šè¿‡`pub/sub`çš„æ–¹å¼è¿›è¡Œé‡Šæ”¾é”æ‰§è¡Œ`del lock`

#### 1.2.5 RedLock

RedLockçš„å¤§æ¦‚æµç¨‹æ˜¯å…ˆæœ‰å¤šäº5ä¸ªçš„Rediså®ä¾‹ï¼Œç„¶ååˆ†åˆ«å‘å„ä¸ªå®ä¾‹è¯·æ±‚åŠ é”ï¼Œå½“å¤§äºåŠæ•°åŠ é”æˆåŠŸå°±è®¤ä¸ºæ˜¯åŠ é”æˆåŠŸï¼Œé‡Šæ”¾é”æ—¶æ“ä½œæ‰€æœ‰èŠ‚ç‚¹

ä½†æ˜¯è¦è€ƒè™‘åŠ é”çš„è€—æ—¶ï¼Œç½‘ç»œç­‰åŸå› 

### 1.3 åŸºäºZooKeeperçš„åˆ†å¸ƒå¼é”

ZooKeeperå®ç°çš„åˆ†å¸ƒå¼é”: 

1. å®¢æˆ·ç«¯1åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼ˆä¼šäº§ç”ŸæƒŠç¾¤æ•ˆåº”ï¼Œä¸€èˆ¬ä½¿ç”¨ä¸´æ—¶æœ‰åºèŠ‚ç‚¹ï¼‰ å¦‚`/lock`
2. å®¢æˆ·ç«¯2å°è¯•åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹å¤±è´¥ï¼ŒåŠ é”å¤±è´¥ï¼Œ
3. å®¢æˆ·ç«¯1æ“ä½œå…±äº«èµ„æºå®Œæˆåï¼Œåˆ é™¤`/lock`èŠ‚ç‚¹ï¼Œé‡Šæ”¾é”ï¼Œå®¢æˆ·ç«¯2é€šè¿‡watcheræœºåˆ¶å‘ç°å¯ä»¥åŠ é”

**å¯èƒ½æœ‰çš„é—®é¢˜**: ZooKeeperé•¿æ—¶é—´æ”¶ä¸åˆ°å®¢æˆ·ç«¯çš„å¿ƒè·³(ä¾‹å¦‚GCæˆ–è€…ç½‘ç»œå»¶è¿Ÿ)ï¼Œä¹Ÿä¼šæŠŠä¸´æ—¶èŠ‚ç‚¹åˆ é™¤ï¼Œå¯¼è‡´å…¶ä»–å®¢æˆ·ç«¯æå‰æ‹¿åˆ°äº†é”ï¼Œä½†æ˜¯åŸå®¢æˆ·ç«¯è®¤ä¸ºè‡ªå·±æœ‰é”

> ZooKeeperå’ŒRediså®ç°åˆ†å¸ƒå¼é”çš„ä¼˜åŠ£
>
> ZooKeeperå®ç°ç®€å•ï¼Œä¸éœ€è¦è€ƒè™‘é”çš„è¿‡æœŸæ—¶é—´ï¼Œé€šè¿‡`watcher`åŠ é”å¤±è´¥å¯ä»¥ç­‰å¾…é”çš„é‡Šæ”¾ï¼Œå®ç°ä¹è§‚é”ï¼Œ
>
> ä½†æ˜¯ZooKeeperçš„éƒ¨ç½²å’Œè¿ç»´æˆæœ¬é«˜ï¼Œæ€§èƒ½ä¸Šä¸å¦‚Redisï¼Œä¹Ÿå­˜åœ¨ç€å®¢æˆ·ç«¯ä¸ZooKeeperé•¿æ—¶é—´å¤±è”å¯¼è‡´çš„é”æå‰é‡Šæ”¾çš„é—®é¢˜



## 2. åˆ†å¸ƒå¼ç¼“å­˜

> å‰ç«¯æœ‰é¡µé¢å’Œæµè§ˆå™¨ç¼“å­˜ï¼ŒApplication Cacheï¼ŒlocalStoreç­‰ï¼Œ
>
> ç½‘ç»œä¼ è¾“ç¼“å­˜ï¼Œä¼šæœ‰å¤šå±‚ç¼“å­˜ï¼ŒCDN,è´Ÿè½½å‡è¡¡ï¼Œ
>
> æœåŠ¡ç«¯ç¼“å­˜ï¼Œæœ¬åœ°ç¼“å­˜:Guava,Map,Caffine,å¤–éƒ¨ç¼“å­˜å¤§å¤šæ•°æœåŠ¡ç«¯ç¼“å­˜é‡‡ç”¨redisï¼Œ
>
> æ•°æ®åº“ç¼“å­˜,MyBtaisçš„ä¸€äºŒçº§ç¼“å­˜ï¼ŒMySQLçš„ç¼“å­˜

### 2.1 Redisçš„æŒä¹…åŒ–ï¼Œé«˜å¯ç”¨ï¼Œè¿‡æœŸç­–ç•¥ï¼Œç¼“å­˜å¼‚å¸¸é—®é¢˜ï¼Œç¼“å­˜å’Œæ•°æ®åº“åŒå†™ä¸€è‡´æ€§é—®é¢˜

> https://spectred.github.io/interview/redis.html

## 3. åˆ†å¸ƒå¼äº‹åŠ¡

## 5. åˆ†å¸ƒå¼æœåŠ¡

## 6. æ¶ˆæ¯é˜Ÿåˆ—

## 7. åˆ†å¸ƒå¼å­˜å‚¨

## 8. åˆ†å¸ƒå¼é«˜å¯ç”¨

## 9. åˆ†å¸ƒå¼åŸºç¡€ç†è®º
