<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://spectred.github.io/java/concurrent/locks.html"><meta property="og:title" content="锁"><meta property="og:description" content="1. 内置锁 synchronized Java提供了内置锁机制来支持原子性、可见性和有序性。 每个Java对象都可以用作一个实现同步的锁，这些锁被称为内置锁（Intrinsic Lock）或监视器锁（Monitor Lock）。线程在进入同步代码块之前会自动获得锁，并且在退出同步代码块时（正常退出或异常退出）自动释放锁。 Java的内置锁相当于一种互..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-03-02T11:39:00.000Z"><meta property="article:tag" content="锁"><meta property="article:tag" content="synchronized"><meta property="article:modified_time" content="2023-03-02T11:39:00.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"锁","image":[""],"dateModified":"2023-03-02T11:39:00.000Z","author":[]}</script><link rel="icon" href="/logo.jpeg"><title>锁</title><meta name="description" content="1. 内置锁 synchronized Java提供了内置锁机制来支持原子性、可见性和有序性。 每个Java对象都可以用作一个实现同步的锁，这些锁被称为内置锁（Intrinsic Lock）或监视器锁（Monitor Lock）。线程在进入同步代码块之前会自动获得锁，并且在退出同步代码块时（正常退出或异常退出）自动释放锁。 Java的内置锁相当于一种互...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-daeac8ef.css" as="style"><link rel="stylesheet" href="/assets/style-daeac8ef.css">
    <link rel="modulepreload" href="/assets/app-945781d8.js"><link rel="modulepreload" href="/assets/framework-b6120433.js"><link rel="modulepreload" href="/assets/locks.html-5c5d75e7.js"><link rel="modulepreload" href="/assets/locks.html-73431147.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.jpeg" alt><!----><!----></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="首页"><span class="font-icon icon iconfont icon-home" style=""></span>首页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/interview" class="nav-link" aria-label="面试"><span class="font-icon icon iconfont icon-emoji" style=""></span>面试<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java"><span class="title"><span class="font-icon icon iconfont icon-java" style=""></span>Java</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java/jvm" class="nav-link" aria-label="☕️JVM"><!---->☕️JVM<!----></a></li><li class="dropdown-item"><a href="/java/magic" class="nav-link" aria-label="🪄魔法"><!---->🪄魔法<!----></a></li><li class="dropdown-item"><a href="/java/concurrent" class="nav-link active" aria-label="🛫并发"><!---->🛫并发<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="框架"><span class="title"><span class="font-icon icon iconfont icon-frame" style=""></span>框架</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/frame/gRPC" class="nav-link" aria-label="gRPC"><img class="icon" src="/assets/icons/grpc.ico">gRPC<!----></a></li><li class="dropdown-item"><a href="/frame/dubbo" class="nav-link" aria-label="Dubbo"><!---->Dubbo<!----></a></li><li class="dropdown-item"><a href="/frame/mybatis" class="nav-link" aria-label="MyBatis"><!---->MyBatis<!----></a></li><li class="dropdown-item"><a href="/frame/netty" class="nav-link" aria-label="Netty"><!---->Netty<!----></a></li><li class="dropdown-item"><a href="/frame/rpc" class="nav-link" aria-label="RPC"><!---->RPC<!----></a></li><li class="dropdown-item"><a href="/frame/spring" class="nav-link" aria-label="Spring"><!---->Spring<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="中间件"><span class="title"><span class="font-icon icon iconfont icon-any" style=""></span>中间件</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/middleware/flink" class="nav-link" aria-label="Flink"><img class="icon" src="/assets/icons/flink.ico">Flink<!----></a></li><li class="dropdown-item"><a href="/middleware/kafka" class="nav-link" aria-label="Kafka"><img class="icon" src="/assets/icons/kafka.ico">Kafka<!----></a></li><li class="dropdown-item"><a href="/middleware/mongodb/" class="nav-link" aria-label="MongoDB"><img class="icon" src="/assets/icons/mongo.ico">MongoDB<!----></a></li><li class="dropdown-item"><a href="/middleware/mysql" class="nav-link" aria-label="MySQL"><img class="icon" src="/assets/icons/mysql.ico">MySQL<!----></a></li><li class="dropdown-item"><a href="/middleware/pulsar" class="nav-link" aria-label="Pulsar"><img class="icon" src="/assets/icons/pulsar.ico">Pulsar<!----></a></li><li class="dropdown-item"><a href="/middleware/redis" class="nav-link" aria-label="Redis"><img class="icon" src="/assets/icons/redis.ico">Redis<!----></a></li><li class="dropdown-item"><a href="/middleware/zookeeper" class="nav-link" aria-label="ZooKeeper"><img class="icon" src="/assets/icons/zookeeper.ico">ZooKeeper<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="云原生"><span class="title"><span class="font-icon icon iconfont icon-mesh" style=""></span>云原生</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/cloud_native/microservices" class="nav-link" aria-label="微服务"><!---->微服务<!----></a></li><li class="dropdown-item"><a href="https://github.com" rel="noopener noreferrer" target="_blank" aria-label="CI/CD" class="nav-link"><!---->CI/CD<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://github.com" rel="noopener noreferrer" target="_blank" aria-label="DevOps" class="nav-link"><!---->DevOps<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://github.com" rel="noopener noreferrer" target="_blank" aria-label="容器" class="nav-link"><!---->容器<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="基础"><span class="title"><span class="font-icon icon iconfont icon-stack" style=""></span>基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/base/os" class="nav-link" aria-label="操作系统"><!---->操作系统<!----></a></li><li class="dropdown-item"><a href="/base/network" class="nav-link" aria-label="计算机网络"><!---->计算机网络<!----></a></li><li class="dropdown-item"><a href="/base/compiler" class="nav-link" aria-label="编译原理"><!---->编译原理<!----></a></li><li class="dropdown-item"><a href="/base/alg" class="nav-link" aria-label="数据结构和算法"><!---->数据结构和算法<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="四次元口袋"><span class="title"><span class="font-icon icon iconfont icon-tool" style=""></span>四次元口袋</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/doraemon/tools.html" class="nav-link" aria-label="任意门"><!---->任意门<!----></a></li><li class="dropdown-item"><a href="/doraemon/x.html" class="nav-link" aria-label="小记"><!---->小记<!----></a></li><li class="dropdown-item"><a href="/doraemon/scripts" class="nav-link" aria-label="脚本集"><!---->脚本集<!----></a></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/Spectred/spectred.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">☕️JVM</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">🪄魔法</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">🛫并发</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/java/concurrent/jmm.html" class="nav-link sidebar-link sidebar-page" aria-label="1. Java内存模型"><!---->1. Java内存模型<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrent/threads.html" class="nav-link sidebar-link sidebar-page" aria-label="2. 线程与线程池"><!---->2. 线程与线程池<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/java/concurrent/locks.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="3. 锁"><!---->3. 锁<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_1-内置锁-synchronized" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1. 内置锁 synchronized"><!---->1. 内置锁 synchronized<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_1-1-synchronized的使用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.1 synchronized的使用"><!---->1.1 synchronized的使用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_1-2-对象的内存布局" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2 对象的内存布局"><!---->1.2 对象的内存布局<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_1-3-锁升级" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.3 锁升级"><!---->1.3 锁升级<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_1-4-原理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.4 原理"><!---->1.4 原理<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-显式锁-lock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2. 显式锁 Lock"><!---->2. 显式锁 Lock<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-1-lock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1 Lock"><!---->2.1 Lock<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-2-重入锁-reentrantlock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.2 重入锁 ReentrantLock"><!---->2.2 重入锁 ReentrantLock<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-3-读-写锁-reentrantreadwritelock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.3 读-写锁 ReentrantReadWriteLock"><!---->2.3 读-写锁 ReentrantReadWriteLock<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-4-stampedlock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.4 StampedLock"><!---->2.4 StampedLock<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-5-condition" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.5 Condition"><!---->2.5 Condition<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_3-锁相关的源码分析" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3. 锁相关的源码分析"><!---->3. 锁相关的源码分析<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_4-死锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4. 死锁"><!---->4. 死锁<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_5-无锁" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5. 无锁"><!---->5. 无锁<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/java/concurrent/collector.html" class="nav-link sidebar-link sidebar-page" aria-label="4. 并发容器"><!---->4. 并发容器<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrent/atomic.html" class="nav-link sidebar-link sidebar-page" aria-label="5. 原子类"><!---->5. 原子类<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrent/tools.html" class="nav-link sidebar-link sidebar-page" aria-label="6. 并发工具"><!---->6. 并发工具<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><span class="font-icon icon iconfont icon-lock" style=""></span>锁</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-02-05T15:52:06.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 14 分钟</span><meta property="timeRequired" content="PT14M"></span><!----><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag8" role>锁</span><span class="page-tag-item tag8" role>synchronized</span><meta property="keywords" content="锁,synchronized"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容<!----></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_1-内置锁-synchronized" class="router-link-active router-link-exact-active toc-link level2">1. 内置锁 synchronized</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_1-1-synchronized的使用" class="router-link-active router-link-exact-active toc-link level3">1.1 synchronized的使用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_1-2-对象的内存布局" class="router-link-active router-link-exact-active toc-link level3">1.2 对象的内存布局</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_1-3-锁升级" class="router-link-active router-link-exact-active toc-link level3">1.3 锁升级</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_1-4-原理" class="router-link-active router-link-exact-active toc-link level3">1.4 原理</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-显式锁-lock" class="router-link-active router-link-exact-active toc-link level2">2. 显式锁 Lock</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-1-lock" class="router-link-active router-link-exact-active toc-link level3">2.1 Lock</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-2-重入锁-reentrantlock" class="router-link-active router-link-exact-active toc-link level3">2.2 重入锁 ReentrantLock</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-3-读-写锁-reentrantreadwritelock" class="router-link-active router-link-exact-active toc-link level3">2.3 读-写锁 ReentrantReadWriteLock</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-4-stampedlock" class="router-link-active router-link-exact-active toc-link level3">2.4 StampedLock</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-5-condition" class="router-link-active router-link-exact-active toc-link level3">2.5 Condition</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_3-锁相关的源码分析" class="router-link-active router-link-exact-active toc-link level2">3. 锁相关的源码分析</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_4-死锁" class="router-link-active router-link-exact-active toc-link level2">4. 死锁</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_5-无锁" class="router-link-active router-link-exact-active toc-link level2">5. 无锁</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="锁" tabindex="-1"><a class="header-anchor" href="#锁" aria-hidden="true">#</a> 锁</h1><figure><img src="https://s2.loli.net/2023/01/30/bd4GTk58g1HjmUI.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h2 id="_1-内置锁-synchronized" tabindex="-1"><a class="header-anchor" href="#_1-内置锁-synchronized" aria-hidden="true">#</a> 1. 内置锁 <code>synchronized</code></h2><p>Java提供了内置锁机制来支持原子性、可见性和有序性。</p><p>每个Java对象都可以用作一个实现同步的锁，这些锁被称为内置锁（Intrinsic Lock）或监视器锁（Monitor Lock）。线程在进入同步代码块之前会自动获得锁，并且在退出同步代码块时（正常退出或异常退出）自动释放锁。</p><p>Java的内置锁相当于一种互斥锁，最多只有一个线程能持有这种锁。当线程A尝试获取一个由线程B持有的锁时，线程A必须等待或阻塞，直到线程B释放这个锁。如果B永远不释放锁，那么A将永远等下去。</p><h3 id="_1-1-synchronized的使用" tabindex="-1"><a class="header-anchor" href="#_1-1-synchronized的使用" aria-hidden="true">#</a> 1.1 <code>synchronized</code>的使用</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 普通同步方法，锁是当前实例对象</span>
<span class="token punctuation">}</span>

<span class="token comment">// 等价于</span>
<span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 静态同步方法，锁是当前类的Class对象</span>
<span class="token punctuation">}</span>

<span class="token comment">// 等价于</span>
<span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">synchronized</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 同步方法块，锁是括号里配置的对象</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">临界区</p><p><a href="https://en.wikipedia.org/wiki/Critical_section" target="_blank" rel="noopener noreferrer">临界区<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>指的是某一块在同一时刻只能由一个线程执行的代码区域</p></div><p>使用<code>synchronized</code>确保多线程安全访问共享资源的代码示例</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedExample</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> count<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SynchronizedExample</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> thread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>example<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> thread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>example<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        thread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            thread1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Count: &quot;</span> <span class="token operator">+</span> example<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-对象的内存布局" tabindex="-1"><a class="header-anchor" href="#_1-2-对象的内存布局" aria-hidden="true">#</a> 1.2 对象的内存布局</h3><p>Java对象在对内存中的存储布局划分为三个部分: 对象头（Object Header）、实例数据（Instance Data）和对齐填充（Padding）。例如:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code># 这个对象在内存中的总大小是32个字节。
Object Header（8 bytes）    # 对象头占用了8个字节
    Mark Word（4 bytes）
    Class Pointer（4 bytes）
Instance Data（16 bytes）   # 实例数据占用了16个字节
    int field1（4 bytes）   # 由一个int类型
    long field2（8 bytes）  # 一个long类型
    Object Reference field3（4 bytes）  # 个Object类型组成
Padding（8 bytes）					# 为了保证对象在内存中的地址是8的倍数，虚拟机添加了8个字节的填充
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-1-对象头" tabindex="-1"><a class="header-anchor" href="#_1-2-1-对象头" aria-hidden="true">#</a> 1.2.1 对象头</h4><p>HotSpot虚拟机对象的对象头部分包括两类信息:</p><p>第一类是用于存储对象自身的运行时数据，如哈希码、GC分代年龄，锁状态标志、线程持有的锁、偏向线程ID、偏向时间戳等，称为<strong>Mark Word</strong>。在JDK17中 <a href="https://github.com/openjdk/jdk/blob/jdk-17-ga/src/hotspot/share/oops/markWord.hpp" target="_blank" rel="noopener noreferrer">markWord.hpp<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>中描述如下</p><details class="hint-container details"><summary>markWord</summary><p>The markWord describes the header of an object.</p><p>Bit-format of an object header (most significant first, big endian layout below):</p><p>32 bits:</p><p>--------</p><p>​ hash:25 ------------&gt;| age:4 biased_lock:1 lock:2 (normal object)</p><p>​ JavaThread*:23 epoch:2 age:4 biased_lock:1 lock:2 (biased object)</p><p>64 bits:</p><p>--------</p><p>unused:25 hash:31 --&gt;| unused_gap:1 age:4 biased_lock:1 lock:2 (normal object)</p><p>JavaThread*:54 epoch:2 unused_gap:1 age:4 biased_lock:1 lock:2 (biased object)</p><p>- hash contains the identity hash value: largest value is 31 bits, see os::random().</p><p>​ Also, 64-bit vm&#39;s require a hash value no bigger than 32 bits because they will not properly generate a mask larger than that: see library_call.cpp</p><p>- the biased lock pattern is used to bias a lock toward a given thread.</p><p>​ When this pattern is set in the low three bits, the lock is either biased toward a given thread or &quot;anonymously&quot; biased,</p><p>​ indicating that it is possible for it to be biased.</p><p>​ When the lock is biased toward a given thread, locking and unlocking can be performed by that thread without using atomic operations.</p><p>​ When a lock&#39;s bias is revoked, it reverts back to the normal locking scheme described below.</p><p>​ Note that we are overloading the meaning of the &quot;unlocked&quot; state of the header.</p><p>​ Because we steal a bit from the age we can guarantee that the bias pattern will never be seen for a truly unlocked object.</p><p>​ Note also that the biased state contains the age bits normally contained in the object header.</p><p>​ Large increases in scavenge times were seen when these bits were absent and an arbitrary age assigned to all biased objects,</p><p>​ because they tended to consume a significant fraction of the eden semispaces and were not promoted promptly,</p><p>​ causing an increase in the amount of copying performed.</p><p>​ The runtime system aligns all JavaThread* pointers to a very large value (currently 128 bytes (32bVM) or 256 bytes (64bVM))</p><p>​ to make room for the age bits &amp; the epoch bits (used in support of biased locking).</p><p>​ [JavaThread* | epoch | age | 1 | 01] lock is biased toward given thread</p><p>​ [0 | epoch | age | 1 | 01] lock is anonymously biased</p><p>- the two lock bits are used to describe three states: locked/unlocked and monitor.</p><p>​ [ptr | 00] locked ptr points to real header on stack</p><p>​ [header | 0 | 01] unlocked regular object header</p><p>​ [ptr | 10] monitor inflated lock (header is wapped out)</p><p>​ [ptr | 11] marked used to mark an object</p><p>​ [0 ............ 0| 00] inflating inflation in progress</p><p>​ We assume that stack/thread pointers have the lowest two bits cleared.</p><p>- INFLATING() is a distinguished markword value of all zeros that is used when inflating an existing stack-lock into an ObjectMonitor.</p><p>​ See below for is_being_inflated() and INFLATING().</p></details><figure><img src="https://s2.loli.net/2023/02/23/OmH3FRYujgBaJ7W.png" alt="图来自: 《深入理解Java虚拟机》13.3 锁优化)" tabindex="0" loading="lazy"><figcaption>图来自: 《深入理解Java虚拟机》13.3 锁优化)</figcaption></figure><p>第二类是<strong>类型指针</strong>，即对象指向它的类型原数据的指针，Java虚拟机通过这个指针来确定该对象是哪个类的实例</p><h4 id="_1-2-2-实例数据" tabindex="-1"><a class="header-anchor" href="#_1-2-2-实例数据" aria-hidden="true">#</a> 1.2.2 实例数据</h4><p>对象真正存储的有效信息，即在程序代码里所定义的各种类型的字段内容</p><h4 id="_1-2-3-对齐填充" tabindex="-1"><a class="header-anchor" href="#_1-2-3-对齐填充" aria-hidden="true">#</a> 1.2.3 对齐填充</h4><p>不是必然存在的，没有特别的含义，仅仅起占位符的作用</p><p>HotSpot虚拟机的自动内存管理系统要求对象起始地址必须是8字节的整数倍，任何对象的大小都必须是8字节的整数倍，如果对象实例数据部分没有对齐，就需要通过对齐填充来补全</p><div class="hint-container info"><p class="hint-container-title">JOL</p><p><strong>JOL</strong> (Java Object Layout) 是分析对象内存布局的工具。详情点击: <a href="https://github.com/openjdk/jol" target="_blank" rel="noopener noreferrer">openjdk/jol<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h3 id="_1-3-锁升级" tabindex="-1"><a class="header-anchor" href="#_1-3-锁升级" aria-hidden="true">#</a> 1.3 锁升级</h3><p>锁升级(或锁膨胀)指的是在多线程并发访问时，根据竞争情况将锁状态逐渐升级，包括: 无锁 -&gt; 偏向锁 -&gt; 轻量级锁 -&gt; 重量级锁。锁可以升级但不能降级(目的是为了提高获得锁和释放锁的效率)</p><h4 id="_1-3-1-无锁" tabindex="-1"><a class="header-anchor" href="#_1-3-1-无锁" aria-hidden="true">#</a> 1.3.1 无锁</h4><p>当一个线程访问一个没有被锁定的对象时，它会尝试使用CAS操作（Compare And Swap）来获取对象的锁。如果CAS操作成功，则表示该线程获得了对象的锁，此时对象处于无锁状态</p><h4 id="_1-3-2-偏向锁" tabindex="-1"><a class="header-anchor" href="#_1-3-2-偏向锁" aria-hidden="true">#</a> 1.3.2 偏向锁</h4><blockquote><p><a href="https://github.com/openjdk/jdk/blob/jdk-17-ga/src/hotspot/share/runtime/biasedLocking.hpp" target="_blank" rel="noopener noreferrer">biasedLocking.hpp<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><p>如果一个线程多次访问一个对象，并且其他线程没有竞争该对象的锁，那么该对象会被标记为偏向锁状态。这时，当该线程再次访问该对象时，就不需要CAS操作来获取锁了，而是直接获取该对象的锁。</p><p>假设当前虚拟机启动了偏向锁（-XX: +UseBiasedLocking）,那么当锁对象第一次被线程获取的时候，虚拟机将会把对象头中的标志位设置为<code>01</code>,把偏向模式设置为<code>1</code>,表示进入偏向模式。同时使用CAS操作把获取到这个锁的线程ID记录在对象的MardWord中。如果CAS成功，持有偏向锁的线程以后每次进入这个锁相关的同步块是，虚拟机都可以不再进行任何通过操作(如加锁、解锁和对MarkWord的更新)。</p><p>偏向锁在Java6和Java7里是默认启用的(准确的说是Java6到Java14)，但是在应用启动几秒中之后才激活，如有必要可以使用JVM参数来关闭延迟: <code>-XX:BiasedLockingStartupDelay=0</code>。如果确定应用程序里所有的锁通常情况下处于竞争状态，可以通过JVM参数关闭偏向锁: <code>-XX:-UseBiasedLocking=false</code>，那么程序默认会进入轻量级锁状态。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>偏向锁在Java15中废弃，参考: <a href="https://openjdk.org/jeps/374" target="_blank" rel="noopener noreferrer">jeps-374<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h4 id="_1-3-3-轻量级锁" tabindex="-1"><a class="header-anchor" href="#_1-3-3-轻量级锁" aria-hidden="true">#</a> 1.3.3 轻量级锁</h4><p>如果一个线程尝试获取一个对象的锁，但该对象已经被另一个线程获取了锁，那么该线程会将对象的锁升级为轻量级锁状态。升级为轻量级锁状态后，该线程会在自己的线程栈中申请一块空间作为锁记录（Lock Record），并将对象的Mark Word指向该锁记录的地址。此时，线程通过CAS操作更新对象的Mark Word，将其指向自己的锁记录，以获取对象的锁。（线程尝试使用CAS将MarkWord替换为只想锁记录的指针，如果成功，当前线程获得锁，如果失败，表示其他线程竞争锁，当前线程便擦灰姑娘是使用自旋来获取锁）</p><h4 id="_1-3-4-重量级锁" tabindex="-1"><a class="header-anchor" href="#_1-3-4-重量级锁" aria-hidden="true">#</a> 1.3.4 重量级锁</h4><p>如果一个对象的轻量级锁升级失败，即多个线程竞争同一个锁，那么该锁会升级为重量级锁状态（如轻量级锁自旋达到设定的次数）。重量级锁是一种基于操作系统的锁，它使用操作系统的互斥量来实现锁的竞争，相对于前面的三种锁级别，重量级锁的竞争强度更高，但开销也更大</p><div class="hint-container note"><p class="hint-container-title">锁优化</p><p>锁优化还包括 自旋锁与自适应锁、锁消除、锁粗化</p></div><h3 id="_1-4-原理" tabindex="-1"><a class="header-anchor" href="#_1-4-原理" aria-hidden="true">#</a> 1.4 原理</h3><p><code>synchronized</code>的原理是通过对象头的 Mark Word 和操作系统的互斥量实现</p><p>在源码中的实现如下：</p><p>对于同步代码块,<code>monitorenter</code>和<code>monitorexit</code>分别对应加锁和解锁操作</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// synchronized code block</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译后的字节码</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0: aload_1
1: dup
2: astore_2
3: monitorenter    // 加锁
4: aload_2
5: monitorexit     // 解锁
6: goto 14
9: astore_3
10: aload_2
11: monitorexit    // 解锁
12: aload_3
13: athrow
14: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于同步方法，使用ACC_SYNCHRONIZED标志来表示该方法是一个同步方法，进入该方法时会自动获取对象监视器（或称为锁），方法执行完成后会自动释放锁。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// synchronized method</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译后的字节码:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public synchronized void method();
    descriptor: ()V
    flags: ACC_PUBLIC, ACC_SYNCHRONIZED   // ACC_SYNCHRONIZED标志
    Code:
      stack=0, locals=1, args_size=1
         0: return
      LineNumberTable:
        line 7: 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">在JVM源码中的实现</p><p><a href="https://github.com/openjdk/jdk/blob/master/src/hotspot/share/runtime/objectMonitor.hpp" target="_blank" rel="noopener noreferrer">objectMonitor.hpp<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://github.com/openjdk/jdk/blob/jdk-17-ga/src/hotspot/share/runtime/objectMonitor.cpp" target="_blank" rel="noopener noreferrer">objectMonitor.cpp<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h2 id="_2-显式锁-lock" tabindex="-1"><a class="header-anchor" href="#_2-显式锁-lock" aria-hidden="true">#</a> 2. 显式锁 <code>Lock</code></h2><p>锁时用来控制多个线程访问共享资源的方式，一般来说一个锁能够防止多个线程同时访问共享资源。</p><p>Java中提供了: <code>java.util.concurrent.locks.Lock</code>接口作为显式锁，与内置加锁机制不同的是，Lock提供了一种无条件的、可轮询的、定时的以及可中断的锁获取操作，所有加锁和解锁方法都是显式的、在Lock的实现中必须提供与内部锁相同的内存可见性语义，但在加锁语义、调度算法和顺序保证以及性能特性等方面可以有所不同。</p><h3 id="_2-1-lock" tabindex="-1"><a class="header-anchor" href="#_2-1-lock" aria-hidden="true">#</a> 2.1 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/Lock.html" target="_blank" rel="noopener noreferrer">Lock<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><h4 id="_2-1-1-lock的使用方式" tabindex="-1"><a class="header-anchor" href="#_2-1-1-lock的使用方式" aria-hidden="true">#</a> 2.1.1 Lock的使用方式:</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Lock</span> l <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>  
l<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">try</span> <span class="token punctuation">{</span>    
  <span class="token comment">// access the resource protected by this lock  </span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    
  l<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">注意</p><p>在<code>finally</code>中释放锁，保证在获取锁之后，最终能够被释放</p><p>不要将获取锁的过程写在<code>try</code>中，因为如果在获取锁(自定义锁的实现)时发生了异常，抛出异常的同时也会导致锁无故释放</p></div><h4 id="_2-1-2-lock比synchronized提供了更多的功能性" tabindex="-1"><a class="header-anchor" href="#_2-1-2-lock比synchronized提供了更多的功能性" aria-hidden="true">#</a> 2.1.2 Lock比<code>synchronized</code>提供了更多的功能性:</h4><ul><li><code>tryLock()</code>: 非阻塞尝试获取锁</li><li><code>tryLock(long, TimeUnit)</code>: 可超时尝试获取锁</li><li><code>lockInterruptibly()</code>: 可中断尝试获取锁</li></ul><h4 id="_2-1-3-lock的api" tabindex="-1"><a class="header-anchor" href="#_2-1-3-lock的api" aria-hidden="true">#</a> 2.1.3 Lock的API</h4><div class="language-JAVA line-numbers-mode" data-ext="JAVA"><pre class="language-JAVA"><code>public interface Lock {

    /**
     * 获取锁
     * 调用该方法当前线程将会获取锁，获锁成功后从该方法返回
     */
    void lock();

    /**
     * 可中断地获取锁
     * 该方法会响应中断，即在锁的获取中可以终端当前线程
     */
    void lockInterruptibly() throws InterruptedException;

    /**
     * 尝试非阻塞的获取锁
     * 调用该方法护立刻返回，如果能够获取则返回true,否则返回false
     * &lt;p&gt;
     * 典型用法:
     * &lt;pre&gt; {@code
     * Lock lock = ...;
     * if (lock.tryLock()) {
     *   try {
     *     // manipulate protected state
     *   } finally {
     *     lock.unlock();
     *   }
     * } else {
     *   // perform alternative actions
     * }}&lt;/pre&gt;
     */
    boolean tryLock();

    /**
     * 超时的获取锁，当前线程在以下3种情况下会返回:
     * - 当前线程在超时时间内 获得锁
     * - 当前线程在超时时间内 被中断
     * - 超时时间结束，返回false
     */
    boolean tryLock(long time, TimeUnit unit) throws InterruptedException;

    /**
     * 释放锁
     */
    void unlock();

    /**
     * 获取Condition
     * 该Condition和当前锁绑定，当前线程只有获得了锁，才能调用Condition的wait()方法，而调用后，当前线程将释放锁
     */
    Condition newCondition();
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-重入锁-reentrantlock" tabindex="-1"><a class="header-anchor" href="#_2-2-重入锁-reentrantlock" aria-hidden="true">#</a> 2.2 重入锁 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/ReentrantLock.html" target="_blank" rel="noopener noreferrer">ReentrantLock<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><p>ReentrantLock，重入锁，表示该锁能够支持一个线程对资源的重复加锁，任意线程在获取锁之后能够再次获取该锁而不会被锁阻塞，该特性的实现需要解决以下两个问题</p><ol><li><p>线程再次获取锁</p><p>锁需要去识别获取锁的线程是否为当前占据锁的线程，如果是则再次成功获取</p></li><li><p>锁的最终释放</p><p>线程重复n次获取锁，随后在第n次释放该锁后，其他线程能够获取该锁</p></li></ol><h4 id="_2-2-1-轮询锁与定时锁" tabindex="-1"><a class="header-anchor" href="#_2-2-1-轮询锁与定时锁" aria-hidden="true">#</a> 2.2.1 轮询锁与定时锁</h4><p>轮询锁和定时锁的获取模式是由<code>tryLock</code>方法实现。</p><p>正确的使用可以避免死锁的发生: 如果不能获得所有需要的锁，那么可以使用可定时的或可轮询的锁获取方式，从而是的重新获得控制权，它会释放已经获得的锁，然后重新尝试获取所有锁。</p><p>定时锁的实例: 带有时间限制的加锁</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 尝试获取锁，等待1秒</span>
        <span class="token comment">// 获取锁成功后的代码逻辑</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取锁失败后的处理逻辑</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理线程中断异常</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放锁</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-可中断的锁获取操作" tabindex="-1"><a class="header-anchor" href="#_2-2-2-可中断的锁获取操作" aria-hidden="true">#</a> 2.2.2 可中断的锁获取操作</h4><p>可中断的锁获取操作能在可取消的操作中使用加锁，<code>lockInterruptibly()</code>方法能够在获得锁的同时保持对中断的响应，并且由于它包含在Lock中，因此无需创建其他类型的不可中断阻塞机制。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 尝试获取锁，并响应线程的中断请求</span>
    <span class="token comment">// 获取锁成功后的代码逻辑</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理线程中断异常</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放锁</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-3-非块结构的加锁" tabindex="-1"><a class="header-anchor" href="#_2-2-3-非块结构的加锁" aria-hidden="true">#</a> 2.2.3 非块结构的加锁</h4><p>内置锁是对一个块结构进行加锁，ReentrantLock是非块结构进行加锁</p><h4 id="_2-2-4-公平性" tabindex="-1"><a class="header-anchor" href="#_2-2-4-公平性" aria-hidden="true">#</a> 2.2.4 公平性</h4><p>可以通过构造函数传参来决定ReentrantLock的公平性，默认是非公平锁</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中FairSync和NonfairSync都继承自内部类Sync，Sync继承AbstractQueuedSynchronizer</p><p>公平锁和非公平锁的实现都是独占的，调用了AQS的setExclusiveOwnerThread方法，都是排他锁。</p><p>公平锁：线程将按照他们发出请求的顺序来获得锁</p><p>非公平锁：当一个线程请求非公平锁时，如果在发出请求的同时该锁的状态变为可用，那么这个线程将跳过队列中所有的等待线程并获得这个锁</p><div class="hint-container warning"><p class="hint-container-title">公平锁</p><p>对于公平锁，可轮询的tryLock仍然会“插队”</p></div><div class="hint-container info"><p class="hint-container-title">为什么ReentrantLock默认是非公平锁</p><p>非公平模式效率更高，因为非公平模式会在一开始就尝试两次获取锁，如果当时正好state是0，那么它就会成功获取锁，少了排队导致的阻塞/唤醒过程，并且减少了线程频繁的切换带来的性能损耗</p><p>但是非公平锁有可能导致一开始排队的线程一直获取不到锁，导致线程饿死</p></div><h4 id="_2-2-5-synchronized和reentrantlock的选择" tabindex="-1"><a class="header-anchor" href="#_2-2-5-synchronized和reentrantlock的选择" aria-hidden="true">#</a> 2.2.5 <code>synchronized</code>和<code>ReentrantLock</code>的选择</h4><p><strong>功能</strong>上: 优先使用<code>synchronized</code>，如果无法满足需求，需要一些高级功能时使用<code>ReentrantLock</code>,高级功能包括:</p><ul><li><p>可轮询的、可定时的 （tryLock）</p></li><li><p>可中断的锁获取操作 （lockInterruptibly）</p></li><li><p>公平队列 （FairSync）</p></li><li><p>非块结构的锁</p></li></ul><p><strong>性能</strong>上: 优先选择<code>synchronized</code></p><p>因为<code>synchronized</code>是JVM的内置属性，能执行一些优化，例如对线程封闭的锁对象的锁消除优化，通过加锁的粒度来消除内置锁</p><h3 id="_2-3-读-写锁-reentrantreadwritelock" tabindex="-1"><a class="header-anchor" href="#_2-3-读-写锁-reentrantreadwritelock" aria-hidden="true">#</a> 2.3 读-写锁 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/ReentrantReadWriteLock.html" target="_blank" rel="noopener noreferrer">ReentrantReadWriteLock<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><h3 id="_2-4-stampedlock" tabindex="-1"><a class="header-anchor" href="#_2-4-stampedlock" aria-hidden="true">#</a> 2.4 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/StampedLock.html" target="_blank" rel="noopener noreferrer">StampedLock<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><h3 id="_2-5-condition" tabindex="-1"><a class="header-anchor" href="#_2-5-condition" aria-hidden="true">#</a> 2.5 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/Condition.html" target="_blank" rel="noopener noreferrer">Condition<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><hr><h2 id="_3-锁相关的源码分析" tabindex="-1"><a class="header-anchor" href="#_3-锁相关的源码分析" aria-hidden="true">#</a> 3. 锁相关的源码分析</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>jdk/src/java.base/share/classes/java/util/concurrent/locks
├── AbstractOwnableSynchronizer.java
├── AbstractQueuedLongSynchronizer.java
├── AbstractQueuedSynchronizer.java
├── Condition.java
├── Lock.java
├── LockSupport.java
├── ReadWriteLock.java
├── ReentrantLock.java
├── ReentrantReadWriteLock.java
└── StampedLock.java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-1-aqs" tabindex="-1"><a class="header-anchor" href="#_3-1-aqs" aria-hidden="true">#</a> 3.1 AQS</h4><h4 id="_3-2-locksupport" tabindex="-1"><a class="header-anchor" href="#_3-2-locksupport" aria-hidden="true">#</a> 3.2 LockSupport</h4><h4 id="_3-3-reentrantlock" tabindex="-1"><a class="header-anchor" href="#_3-3-reentrantlock" aria-hidden="true">#</a> 3.3 ReentrantLock</h4><h4 id="_3-4-reentrantreadwritelock" tabindex="-1"><a class="header-anchor" href="#_3-4-reentrantreadwritelock" aria-hidden="true">#</a> 3.4 ReentrantReadWriteLock</h4><h4 id="_3-5-stampedlock" tabindex="-1"><a class="header-anchor" href="#_3-5-stampedlock" aria-hidden="true">#</a> 3.5 StampedLock</h4><h2 id="_4-死锁" tabindex="-1"><a class="header-anchor" href="#_4-死锁" aria-hidden="true">#</a> 4. 死锁</h2><h2 id="_5-无锁" tabindex="-1"><a class="header-anchor" href="#_5-无锁" aria-hidden="true">#</a> 5. 无锁</h2></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/Spectred/spectred.github.io/edit/main/src/java/concurrent/locks.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 1505073336@qq.com">spectred</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/java/concurrent/threads.html" class="nav-link prev" aria-label="2. 线程与线程池"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->2. 线程与线程池</div></a><a href="/java/concurrent/collector.html" class="nav-link next" aria-label="4. 并发容器"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">4. 并发容器<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><img src="https://v2.jinrishici.com/one.svg?font-size=14&spacing=2&color=SkyBlue" alt="今日诗词API"></div><!----></footer></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-945781d8.js" defer></script>
  </body>
</html>
