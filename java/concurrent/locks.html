<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://spectred.github.io/java/concurrent/locks.html"><meta property="og:title" content="é”"><meta property="og:description" content="1. å†…ç½®é” synchronized Javaæä¾›äº†å†…ç½®é”æœºåˆ¶æ¥æ”¯æŒåŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ã€‚ æ¯ä¸ªJavaå¯¹è±¡éƒ½å¯ä»¥ç”¨ä½œä¸€ä¸ªå®ç°åŒæ­¥çš„é”ï¼Œè¿™äº›é”è¢«ç§°ä¸ºå†…ç½®é”ï¼ˆIntrinsic Lockï¼‰æˆ–ç›‘è§†å™¨é”ï¼ˆMonitor Lockï¼‰ã€‚çº¿ç¨‹åœ¨è¿›å…¥åŒæ­¥ä»£ç å—ä¹‹å‰ä¼šè‡ªåŠ¨è·å¾—é”ï¼Œå¹¶ä¸”åœ¨é€€å‡ºåŒæ­¥ä»£ç å—æ—¶ï¼ˆæ­£å¸¸é€€å‡ºæˆ–å¼‚å¸¸é€€å‡ºï¼‰è‡ªåŠ¨é‡Šæ”¾é”ã€‚ Javaçš„å†…ç½®é”ç›¸å½“äºä¸€ç§äº’..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-03-23T23:58:18.000Z"><meta property="article:tag" content="é”"><meta property="article:tag" content="synchronized"><meta property="article:modified_time" content="2023-03-23T23:58:18.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"é”","image":[""],"dateModified":"2023-03-23T23:58:18.000Z","author":[]}</script><link rel="icon" href="/logo.jpeg"><title>é”</title><meta name="description" content="1. å†…ç½®é” synchronized Javaæä¾›äº†å†…ç½®é”æœºåˆ¶æ¥æ”¯æŒåŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ã€‚ æ¯ä¸ªJavaå¯¹è±¡éƒ½å¯ä»¥ç”¨ä½œä¸€ä¸ªå®ç°åŒæ­¥çš„é”ï¼Œè¿™äº›é”è¢«ç§°ä¸ºå†…ç½®é”ï¼ˆIntrinsic Lockï¼‰æˆ–ç›‘è§†å™¨é”ï¼ˆMonitor Lockï¼‰ã€‚çº¿ç¨‹åœ¨è¿›å…¥åŒæ­¥ä»£ç å—ä¹‹å‰ä¼šè‡ªåŠ¨è·å¾—é”ï¼Œå¹¶ä¸”åœ¨é€€å‡ºåŒæ­¥ä»£ç å—æ—¶ï¼ˆæ­£å¸¸é€€å‡ºæˆ–å¼‚å¸¸é€€å‡ºï¼‰è‡ªåŠ¨é‡Šæ”¾é”ã€‚ Javaçš„å†…ç½®é”ç›¸å½“äºä¸€ç§äº’...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-daeac8ef.css" as="style"><link rel="stylesheet" href="/assets/style-daeac8ef.css">
    <link rel="modulepreload" href="/assets/app-bceac402.js"><link rel="modulepreload" href="/assets/framework-eedf5ae1.js"><link rel="modulepreload" href="/assets/locks.html-2db6a35b.js"><link rel="modulepreload" href="/assets/locks.html-37c5382e.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.jpeg" alt><!----><!----></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="é¦–é¡µ"><span class="font-icon icon iconfont icon-home" style=""></span>é¦–é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a href="/interview" class="nav-link" aria-label="é¢è¯•"><span class="font-icon icon iconfont icon-emoji" style=""></span>é¢è¯•<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java"><span class="title"><span class="font-icon icon iconfont icon-java" style=""></span>Java</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/java/jvm" class="nav-link" aria-label="â˜•ï¸JVM"><!---->â˜•ï¸JVM<!----></a></li><li class="dropdown-item"><a href="/java/magic" class="nav-link" aria-label="ğŸª„é­”æ³•"><!---->ğŸª„é­”æ³•<!----></a></li><li class="dropdown-item"><a href="/java/concurrent" class="nav-link active" aria-label="ğŸ›«å¹¶å‘"><!---->ğŸ›«å¹¶å‘<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æ¡†æ¶"><span class="title"><span class="font-icon icon iconfont icon-frame" style=""></span>æ¡†æ¶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/frame/gRPC" class="nav-link" aria-label="gRPC"><!---->gRPC<!----></a></li><li class="dropdown-item"><a href="/frame/dubbo" class="nav-link" aria-label="Dubbo"><!---->Dubbo<!----></a></li><li class="dropdown-item"><a href="/frame/mybatis" class="nav-link" aria-label="MyBatis"><!---->MyBatis<!----></a></li><li class="dropdown-item"><a href="/frame/netty" class="nav-link" aria-label="Netty"><!---->Netty<!----></a></li><li class="dropdown-item"><a href="/frame/rpc" class="nav-link" aria-label="RPC"><!---->RPC<!----></a></li><li class="dropdown-item"><a href="/frame/spring" class="nav-link" aria-label="Spring"><!---->Spring<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="ä¸­é—´ä»¶"><span class="title"><span class="font-icon icon iconfont icon-any" style=""></span>ä¸­é—´ä»¶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/middleware/flink" class="nav-link" aria-label="Flink"><!---->Flink<!----></a></li><li class="dropdown-item"><a href="/middleware/kafka" class="nav-link" aria-label="Kafka"><!---->Kafka<!----></a></li><li class="dropdown-item"><a href="/middleware/mongodb/" class="nav-link" aria-label="MongoDB"><!---->MongoDB<!----></a></li><li class="dropdown-item"><a href="/middleware/mysql" class="nav-link" aria-label="MySQL"><span class="font-icon icon iconfont icon-mysql" style=""></span>MySQL<!----></a></li><li class="dropdown-item"><a href="/middleware/pulsar" class="nav-link" aria-label="Pulsar"><!---->Pulsar<!----></a></li><li class="dropdown-item"><a href="/middleware/redis" class="nav-link" aria-label="Redis"><span class="font-icon icon iconfont icon-like" style=""></span>Redis<!----></a></li><li class="dropdown-item"><a href="/middleware/zookeeper" class="nav-link" aria-label="ZooKeeper"><!---->ZooKeeper<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="äº‘åŸç”Ÿ"><span class="title"><span class="font-icon icon iconfont icon-mesh" style=""></span>äº‘åŸç”Ÿ</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/cloud_native/microservices" class="nav-link" aria-label="å¾®æœåŠ¡"><!---->å¾®æœåŠ¡<!----></a></li><li class="dropdown-item"><a href="https://github.com" rel="noopener noreferrer" target="_blank" aria-label="CI/CD" class="nav-link"><!---->CI/CD<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://github.com" rel="noopener noreferrer" target="_blank" aria-label="DevOps" class="nav-link"><!---->DevOps<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="https://github.com" rel="noopener noreferrer" target="_blank" aria-label="å®¹å™¨" class="nav-link"><!---->å®¹å™¨<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="åŸºç¡€"><span class="title"><span class="font-icon icon iconfont icon-stack" style=""></span>åŸºç¡€</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/base/os" class="nav-link" aria-label="æ“ä½œç³»ç»Ÿ"><!---->æ“ä½œç³»ç»Ÿ<!----></a></li><li class="dropdown-item"><a href="/base/network" class="nav-link" aria-label="è®¡ç®—æœºç½‘ç»œ"><!---->è®¡ç®—æœºç½‘ç»œ<!----></a></li><li class="dropdown-item"><a href="/base/compiler" class="nav-link" aria-label="ç¼–è¯‘åŸç†"><!---->ç¼–è¯‘åŸç†<!----></a></li><li class="dropdown-item"><a href="/base/alg" class="nav-link" aria-label="æ•°æ®ç»“æ„å’Œç®—æ³•"><!---->æ•°æ®ç»“æ„å’Œç®—æ³•<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="AI"><span class="title"><span class="font-icon icon iconfont icon-customize" style=""></span>AI</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/ai/prompt" class="nav-link" aria-label="æç¤ºè¯"><!---->æç¤ºè¯<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="å››æ¬¡å…ƒå£è¢‹"><span class="title"><span class="font-icon icon iconfont icon-tool" style=""></span>å››æ¬¡å…ƒå£è¢‹</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/doraemon/tools.html" class="nav-link" aria-label="ä»»æ„é—¨"><!---->ä»»æ„é—¨<!----></a></li><li class="dropdown-item"><a href="/doraemon/scripts" class="nav-link" aria-label="è„šæœ¬é›†"><!---->è„šæœ¬é›†<!----></a></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/Spectred/spectred.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">â˜•ï¸JVM</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">ğŸª„é­”æ³•</span><span class="arrow end"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">ğŸ›«å¹¶å‘</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/java/concurrent/jmm.html" class="nav-link sidebar-link sidebar-page" aria-label="1. Javaå†…å­˜æ¨¡å‹"><!---->1. Javaå†…å­˜æ¨¡å‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrent/threads.html" class="nav-link sidebar-link sidebar-page" aria-label="2. çº¿ç¨‹ä¸çº¿ç¨‹æ± "><!---->2. çº¿ç¨‹ä¸çº¿ç¨‹æ± <!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/java/concurrent/locks.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="3. é”"><!---->3. é”<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_1-å†…ç½®é”-synchronized" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1. å†…ç½®é” synchronized"><!---->1. å†…ç½®é” synchronized<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_1-1-synchronizedçš„ä½¿ç”¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.1 synchronizedçš„ä½¿ç”¨"><!---->1.1 synchronizedçš„ä½¿ç”¨<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_1-2-å¯¹è±¡çš„å†…å­˜å¸ƒå±€" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2 å¯¹è±¡çš„å†…å­˜å¸ƒå±€"><!---->1.2 å¯¹è±¡çš„å†…å­˜å¸ƒå±€<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_1-3-é”å‡çº§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.3 é”å‡çº§"><!---->1.3 é”å‡çº§<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_1-4-åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.4 åŸç†"><!---->1.4 åŸç†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-æ˜¾å¼é”-lock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2. æ˜¾å¼é” Lock"><!---->2. æ˜¾å¼é” Lock<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-1-lock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1 Lock"><!---->2.1 Lock<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-2-é‡å…¥é”-reentrantlock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.2 é‡å…¥é” ReentrantLock"><!---->2.2 é‡å…¥é” ReentrantLock<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-3-è¯»-å†™é”-reentrantreadwritelock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.3 è¯»-å†™é” ReentrantReadWriteLock"><!---->2.3 è¯»-å†™é” ReentrantReadWriteLock<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-4-stampedlock" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.4 StampedLock"><!---->2.4 StampedLock<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_2-5-condition" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.5 Condition"><!---->2.5 Condition<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_3-é”ç›¸å…³çš„æºç åˆ†æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3. é”ç›¸å…³çš„æºç åˆ†æ"><!---->3. é”ç›¸å…³çš„æºç åˆ†æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_3-1-aqs" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.1 AQS"><!---->3.1 AQS<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_4-æ­»é”" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4. æ­»é”"><!---->4. æ­»é”<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/concurrent/locks.html#_5-æ— é”" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5. æ— é”"><!---->5. æ— é”<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/java/concurrent/collector.html" class="nav-link sidebar-link sidebar-page" aria-label="4. å¹¶å‘å®¹å™¨"><!---->4. å¹¶å‘å®¹å™¨<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrent/atomic.html" class="nav-link sidebar-link sidebar-page" aria-label="5. åŸå­ç±»"><!---->5. åŸå­ç±»<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/concurrent/tools.html" class="nav-link sidebar-link sidebar-page" aria-label="6. å¹¶å‘å·¥å…·"><!---->6. å¹¶å‘å·¥å…·<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><span class="font-icon icon iconfont icon-lock" style=""></span>é”</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-02-05T15:52:06.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 29 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT29M"></span><!----><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag8" role>é”</span><span class="page-tag-item tag8" role>synchronized</span><meta property="keywords" content="é”,synchronized"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹<!----></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_1-å†…ç½®é”-synchronized" class="router-link-active router-link-exact-active toc-link level2">1. å†…ç½®é” synchronized</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_1-1-synchronizedçš„ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level3">1.1 synchronizedçš„ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_1-2-å¯¹è±¡çš„å†…å­˜å¸ƒå±€" class="router-link-active router-link-exact-active toc-link level3">1.2 å¯¹è±¡çš„å†…å­˜å¸ƒå±€</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_1-3-é”å‡çº§" class="router-link-active router-link-exact-active toc-link level3">1.3 é”å‡çº§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_1-4-åŸç†" class="router-link-active router-link-exact-active toc-link level3">1.4 åŸç†</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-æ˜¾å¼é”-lock" class="router-link-active router-link-exact-active toc-link level2">2. æ˜¾å¼é” Lock</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-1-lock" class="router-link-active router-link-exact-active toc-link level3">2.1 Lock</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-2-é‡å…¥é”-reentrantlock" class="router-link-active router-link-exact-active toc-link level3">2.2 é‡å…¥é” ReentrantLock</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-3-è¯»-å†™é”-reentrantreadwritelock" class="router-link-active router-link-exact-active toc-link level3">2.3 è¯»-å†™é” ReentrantReadWriteLock</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-4-stampedlock" class="router-link-active router-link-exact-active toc-link level3">2.4 StampedLock</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_2-5-condition" class="router-link-active router-link-exact-active toc-link level3">2.5 Condition</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_3-é”ç›¸å…³çš„æºç åˆ†æ" class="router-link-active router-link-exact-active toc-link level2">3. é”ç›¸å…³çš„æºç åˆ†æ</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_3-1-aqs" class="router-link-active router-link-exact-active toc-link level3">3.1 AQS</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_4-æ­»é”" class="router-link-active router-link-exact-active toc-link level2">4. æ­»é”</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/concurrent/locks.html#_5-æ— é”" class="router-link-active router-link-exact-active toc-link level2">5. æ— é”</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="é”" tabindex="-1"><a class="header-anchor" href="#é”" aria-hidden="true">#</a> é”</h1><figure><img src="https://s2.loli.net/2023/01/30/bd4GTk58g1HjmUI.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h2 id="_1-å†…ç½®é”-synchronized" tabindex="-1"><a class="header-anchor" href="#_1-å†…ç½®é”-synchronized" aria-hidden="true">#</a> 1. å†…ç½®é” <code>synchronized</code></h2><p>Javaæä¾›äº†å†…ç½®é”æœºåˆ¶æ¥æ”¯æŒåŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ã€‚</p><p>æ¯ä¸ªJavaå¯¹è±¡éƒ½å¯ä»¥ç”¨ä½œä¸€ä¸ªå®ç°åŒæ­¥çš„é”ï¼Œè¿™äº›é”è¢«ç§°ä¸ºå†…ç½®é”ï¼ˆIntrinsic Lockï¼‰æˆ–ç›‘è§†å™¨é”ï¼ˆMonitor Lockï¼‰ã€‚çº¿ç¨‹åœ¨è¿›å…¥åŒæ­¥ä»£ç å—ä¹‹å‰ä¼šè‡ªåŠ¨è·å¾—é”ï¼Œå¹¶ä¸”åœ¨é€€å‡ºåŒæ­¥ä»£ç å—æ—¶ï¼ˆæ­£å¸¸é€€å‡ºæˆ–å¼‚å¸¸é€€å‡ºï¼‰è‡ªåŠ¨é‡Šæ”¾é”ã€‚</p><p>Javaçš„å†…ç½®é”ç›¸å½“äºä¸€ç§äº’æ–¥é”ï¼Œæœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰è¿™ç§é”ã€‚å½“çº¿ç¨‹Aå°è¯•è·å–ä¸€ä¸ªç”±çº¿ç¨‹BæŒæœ‰çš„é”æ—¶ï¼Œçº¿ç¨‹Aå¿…é¡»ç­‰å¾…æˆ–é˜»å¡ï¼Œç›´åˆ°çº¿ç¨‹Bé‡Šæ”¾è¿™ä¸ªé”ã€‚å¦‚æœBæ°¸è¿œä¸é‡Šæ”¾é”ï¼Œé‚£ä¹ˆAå°†æ°¸è¿œç­‰ä¸‹å»ã€‚</p><h3 id="_1-1-synchronizedçš„ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_1-1-synchronizedçš„ä½¿ç”¨" aria-hidden="true">#</a> 1.1 <code>synchronized</code>çš„ä½¿ç”¨</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// æ™®é€šåŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç­‰ä»·äº</span>
<span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// é™æ€åŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰ç±»çš„Classå¯¹è±¡</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç­‰ä»·äº</span>
<span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">synchronized</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// åŒæ­¥æ–¹æ³•å—ï¼Œé”æ˜¯æ‹¬å·é‡Œé…ç½®çš„å¯¹è±¡</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">ä¸´ç•ŒåŒº</p><p><a href="https://en.wikipedia.org/wiki/Critical_section" target="_blank" rel="noopener noreferrer">ä¸´ç•ŒåŒº<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æŒ‡çš„æ˜¯æŸä¸€å—åœ¨åŒä¸€æ—¶åˆ»åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ä»£ç åŒºåŸŸ</p></div><p>ä½¿ç”¨<code>synchronized</code>ç¡®ä¿å¤šçº¿ç¨‹å®‰å…¨è®¿é—®å…±äº«èµ„æºçš„ä»£ç ç¤ºä¾‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedExample</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> count<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SynchronizedExample</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> thread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>example<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> thread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>example<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        thread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            thread1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Count: &quot;</span> <span class="token operator">+</span> example<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-å¯¹è±¡çš„å†…å­˜å¸ƒå±€" tabindex="-1"><a class="header-anchor" href="#_1-2-å¯¹è±¡çš„å†…å­˜å¸ƒå±€" aria-hidden="true">#</a> 1.2 å¯¹è±¡çš„å†…å­˜å¸ƒå±€</h3><p>Javaå¯¹è±¡åœ¨å¯¹å†…å­˜ä¸­çš„å­˜å‚¨å¸ƒå±€åˆ’åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†: å¯¹è±¡å¤´ï¼ˆObject Headerï¼‰ã€å®ä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰å’Œå¯¹é½å¡«å……ï¼ˆPaddingï¼‰ã€‚ä¾‹å¦‚:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code># è¿™ä¸ªå¯¹è±¡åœ¨å†…å­˜ä¸­çš„æ€»å¤§å°æ˜¯32ä¸ªå­—èŠ‚ã€‚
Object Headerï¼ˆ8 bytesï¼‰    # å¯¹è±¡å¤´å ç”¨äº†8ä¸ªå­—èŠ‚
    Mark Wordï¼ˆ4 bytesï¼‰
    Class Pointerï¼ˆ4 bytesï¼‰
Instance Dataï¼ˆ16 bytesï¼‰   # å®ä¾‹æ•°æ®å ç”¨äº†16ä¸ªå­—èŠ‚
    int field1ï¼ˆ4 bytesï¼‰   # ç”±ä¸€ä¸ªintç±»å‹
    long field2ï¼ˆ8 bytesï¼‰  # ä¸€ä¸ªlongç±»å‹
    Object Reference field3ï¼ˆ4 bytesï¼‰  # ä¸ªObjectç±»å‹ç»„æˆ
Paddingï¼ˆ8 bytesï¼‰					# ä¸ºäº†ä¿è¯å¯¹è±¡åœ¨å†…å­˜ä¸­çš„åœ°å€æ˜¯8çš„å€æ•°ï¼Œè™šæ‹Ÿæœºæ·»åŠ äº†8ä¸ªå­—èŠ‚çš„å¡«å……
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-1-å¯¹è±¡å¤´" tabindex="-1"><a class="header-anchor" href="#_1-2-1-å¯¹è±¡å¤´" aria-hidden="true">#</a> 1.2.1 å¯¹è±¡å¤´</h4><p>HotSpotè™šæ‹Ÿæœºå¯¹è±¡çš„å¯¹è±¡å¤´éƒ¨åˆ†åŒ…æ‹¬ä¸¤ç±»ä¿¡æ¯:</p><p>ç¬¬ä¸€ç±»æ˜¯ç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚å“ˆå¸Œç ã€GCåˆ†ä»£å¹´é¾„ï¼Œé”çŠ¶æ€æ ‡å¿—ã€çº¿ç¨‹æŒæœ‰çš„é”ã€åå‘çº¿ç¨‹IDã€åå‘æ—¶é—´æˆ³ç­‰ï¼Œç§°ä¸º<strong>Mark Word</strong>ã€‚åœ¨JDK17ä¸­ <a href="https://github.com/openjdk/jdk/blob/jdk-17-ga/src/hotspot/share/oops/markWord.hpp" target="_blank" rel="noopener noreferrer">markWord.hpp<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ä¸­æè¿°å¦‚ä¸‹</p><details class="hint-container details"><summary>markWord</summary><p>The markWord describes the header of an object.</p><p>Bit-format of an object header (most significant first, big endian layout below):</p><p>32 bits:</p><p>--------</p><p>â€‹ hash:25 ------------&gt;| age:4 biased_lock:1 lock:2 (normal object)</p><p>â€‹ JavaThread*:23 epoch:2 age:4 biased_lock:1 lock:2 (biased object)</p><p>64 bits:</p><p>--------</p><p>unused:25 hash:31 --&gt;| unused_gap:1 age:4 biased_lock:1 lock:2 (normal object)</p><p>JavaThread*:54 epoch:2 unused_gap:1 age:4 biased_lock:1 lock:2 (biased object)</p><p>- hash contains the identity hash value: largest value is 31 bits, see os::random().</p><p>â€‹ Also, 64-bit vm&#39;s require a hash value no bigger than 32 bits because they will not properly generate a mask larger than that: see library_call.cpp</p><p>- the biased lock pattern is used to bias a lock toward a given thread.</p><p>â€‹ When this pattern is set in the low three bits, the lock is either biased toward a given thread or &quot;anonymously&quot; biased,</p><p>â€‹ indicating that it is possible for it to be biased.</p><p>â€‹ When the lock is biased toward a given thread, locking and unlocking can be performed by that thread without using atomic operations.</p><p>â€‹ When a lock&#39;s bias is revoked, it reverts back to the normal locking scheme described below.</p><p>â€‹ Note that we are overloading the meaning of the &quot;unlocked&quot; state of the header.</p><p>â€‹ Because we steal a bit from the age we can guarantee that the bias pattern will never be seen for a truly unlocked object.</p><p>â€‹ Note also that the biased state contains the age bits normally contained in the object header.</p><p>â€‹ Large increases in scavenge times were seen when these bits were absent and an arbitrary age assigned to all biased objects,</p><p>â€‹ because they tended to consume a significant fraction of the eden semispaces and were not promoted promptly,</p><p>â€‹ causing an increase in the amount of copying performed.</p><p>â€‹ The runtime system aligns all JavaThread* pointers to a very large value (currently 128 bytes (32bVM) or 256 bytes (64bVM))</p><p>â€‹ to make room for the age bits &amp; the epoch bits (used in support of biased locking).</p><p>â€‹ [JavaThread* | epoch | age | 1 | 01] lock is biased toward given thread</p><p>â€‹ [0 | epoch | age | 1 | 01] lock is anonymously biased</p><p>- the two lock bits are used to describe three states: locked/unlocked and monitor.</p><p>â€‹ [ptr | 00] locked ptr points to real header on stack</p><p>â€‹ [header | 0 | 01] unlocked regular object header</p><p>â€‹ [ptr | 10] monitor inflated lock (header is wapped out)</p><p>â€‹ [ptr | 11] marked used to mark an object</p><p>â€‹ [0 ............ 0| 00] inflating inflation in progress</p><p>â€‹ We assume that stack/thread pointers have the lowest two bits cleared.</p><p>- INFLATING() is a distinguished markword value of all zeros that is used when inflating an existing stack-lock into an ObjectMonitor.</p><p>â€‹ See below for is_being_inflated() and INFLATING().</p></details><figure><img src="https://s2.loli.net/2023/02/23/OmH3FRYujgBaJ7W.png" alt="å›¾æ¥è‡ª: ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹13.3 é”ä¼˜åŒ–)" tabindex="0" loading="lazy"><figcaption>å›¾æ¥è‡ª: ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹13.3 é”ä¼˜åŒ–)</figcaption></figure><p>ç¬¬äºŒç±»æ˜¯<strong>ç±»å‹æŒ‡é’ˆ</strong>ï¼Œå³å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å‹åŸæ•°æ®çš„æŒ‡é’ˆï¼ŒJavaè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¯¥å¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹</p><h4 id="_1-2-2-å®ä¾‹æ•°æ®" tabindex="-1"><a class="header-anchor" href="#_1-2-2-å®ä¾‹æ•°æ®" aria-hidden="true">#</a> 1.2.2 å®ä¾‹æ•°æ®</h4><p>å¯¹è±¡çœŸæ­£å­˜å‚¨çš„æœ‰æ•ˆä¿¡æ¯ï¼Œå³åœ¨ç¨‹åºä»£ç é‡Œæ‰€å®šä¹‰çš„å„ç§ç±»å‹çš„å­—æ®µå†…å®¹</p><h4 id="_1-2-3-å¯¹é½å¡«å……" tabindex="-1"><a class="header-anchor" href="#_1-2-3-å¯¹é½å¡«å……" aria-hidden="true">#</a> 1.2.3 å¯¹é½å¡«å……</h4><p>ä¸æ˜¯å¿…ç„¶å­˜åœ¨çš„ï¼Œæ²¡æœ‰ç‰¹åˆ«çš„å«ä¹‰ï¼Œä»…ä»…èµ·å ä½ç¬¦çš„ä½œç”¨</p><p>HotSpotè™šæ‹Ÿæœºçš„è‡ªåŠ¨å†…å­˜ç®¡ç†ç³»ç»Ÿè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ï¼Œä»»ä½•å¯¹è±¡çš„å¤§å°éƒ½å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ï¼Œå¦‚æœå¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†æ²¡æœ‰å¯¹é½ï¼Œå°±éœ€è¦é€šè¿‡å¯¹é½å¡«å……æ¥è¡¥å…¨</p><div class="hint-container info"><p class="hint-container-title">JOL</p><p><strong>JOL</strong> (Java Object Layout) æ˜¯åˆ†æå¯¹è±¡å†…å­˜å¸ƒå±€çš„å·¥å…·ã€‚è¯¦æƒ…ç‚¹å‡»: <a href="https://github.com/openjdk/jol" target="_blank" rel="noopener noreferrer">openjdk/jol<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h3 id="_1-3-é”å‡çº§" tabindex="-1"><a class="header-anchor" href="#_1-3-é”å‡çº§" aria-hidden="true">#</a> 1.3 é”å‡çº§</h3><p>é”å‡çº§(æˆ–é”è†¨èƒ€)æŒ‡çš„æ˜¯åœ¨å¤šçº¿ç¨‹å¹¶å‘è®¿é—®æ—¶ï¼Œæ ¹æ®ç«äº‰æƒ…å†µå°†é”çŠ¶æ€é€æ¸å‡çº§ï¼ŒåŒ…æ‹¬: æ— é” -&gt; åå‘é” -&gt; è½»é‡çº§é” -&gt; é‡é‡çº§é”ã€‚é”å¯ä»¥å‡çº§ä½†ä¸èƒ½é™çº§(ç›®çš„æ˜¯ä¸ºäº†æé«˜è·å¾—é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡)</p><h4 id="_1-3-1-æ— é”" tabindex="-1"><a class="header-anchor" href="#_1-3-1-æ— é”" aria-hidden="true">#</a> 1.3.1 æ— é”</h4><p>å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªæ²¡æœ‰è¢«é”å®šçš„å¯¹è±¡æ—¶ï¼Œå®ƒä¼šå°è¯•ä½¿ç”¨CASæ“ä½œï¼ˆCompare And Swapï¼‰æ¥è·å–å¯¹è±¡çš„é”ã€‚å¦‚æœCASæ“ä½œæˆåŠŸï¼Œåˆ™è¡¨ç¤ºè¯¥çº¿ç¨‹è·å¾—äº†å¯¹è±¡çš„é”ï¼Œæ­¤æ—¶å¯¹è±¡å¤„äºæ— é”çŠ¶æ€</p><h4 id="_1-3-2-åå‘é”" tabindex="-1"><a class="header-anchor" href="#_1-3-2-åå‘é”" aria-hidden="true">#</a> 1.3.2 åå‘é”</h4><blockquote><p><a href="https://github.com/openjdk/jdk/blob/jdk-17-ga/src/hotspot/share/runtime/biasedLocking.hpp" target="_blank" rel="noopener noreferrer">biasedLocking.hpp<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><p>å¦‚æœä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è®¿é—®ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å…¶ä»–çº¿ç¨‹æ²¡æœ‰ç«äº‰è¯¥å¯¹è±¡çš„é”ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡ä¼šè¢«æ ‡è®°ä¸ºåå‘é”çŠ¶æ€ã€‚è¿™æ—¶ï¼Œå½“è¯¥çº¿ç¨‹å†æ¬¡è®¿é—®è¯¥å¯¹è±¡æ—¶ï¼Œå°±ä¸éœ€è¦CASæ“ä½œæ¥è·å–é”äº†ï¼Œè€Œæ˜¯ç›´æ¥è·å–è¯¥å¯¹è±¡çš„é”ã€‚</p><p>å‡è®¾å½“å‰è™šæ‹Ÿæœºå¯åŠ¨äº†åå‘é”ï¼ˆ-XX: +UseBiasedLockingï¼‰,é‚£ä¹ˆå½“é”å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å–çš„æ—¶å€™ï¼Œè™šæ‹Ÿæœºå°†ä¼šæŠŠå¯¹è±¡å¤´ä¸­çš„æ ‡å¿—ä½è®¾ç½®ä¸º<code>01</code>,æŠŠåå‘æ¨¡å¼è®¾ç½®ä¸º<code>1</code>,è¡¨ç¤ºè¿›å…¥åå‘æ¨¡å¼ã€‚åŒæ—¶ä½¿ç”¨CASæ“ä½œæŠŠè·å–åˆ°è¿™ä¸ªé”çš„çº¿ç¨‹IDè®°å½•åœ¨å¯¹è±¡çš„MardWordä¸­ã€‚å¦‚æœCASæˆåŠŸï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹ä»¥åæ¯æ¬¡è¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—æ˜¯ï¼Œè™šæ‹Ÿæœºéƒ½å¯ä»¥ä¸å†è¿›è¡Œä»»ä½•é€šè¿‡æ“ä½œ(å¦‚åŠ é”ã€è§£é”å’Œå¯¹MarkWordçš„æ›´æ–°)ã€‚</p><p>åå‘é”åœ¨Java6å’ŒJava7é‡Œæ˜¯é»˜è®¤å¯ç”¨çš„(å‡†ç¡®çš„è¯´æ˜¯Java6åˆ°Java14)ï¼Œä½†æ˜¯åœ¨åº”ç”¨å¯åŠ¨å‡ ç§’ä¸­ä¹‹åæ‰æ¿€æ´»ï¼Œå¦‚æœ‰å¿…è¦å¯ä»¥ä½¿ç”¨JVMå‚æ•°æ¥å…³é—­å»¶è¿Ÿ: <code>-XX:BiasedLockingStartupDelay=0</code>ã€‚å¦‚æœç¡®å®šåº”ç”¨ç¨‹åºé‡Œæ‰€æœ‰çš„é”é€šå¸¸æƒ…å†µä¸‹å¤„äºç«äº‰çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡JVMå‚æ•°å…³é—­åå‘é”: <code>-XX:-UseBiasedLocking=false</code>ï¼Œé‚£ä¹ˆç¨‹åºé»˜è®¤ä¼šè¿›å…¥è½»é‡çº§é”çŠ¶æ€ã€‚</p><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>åå‘é”åœ¨Java15ä¸­åºŸå¼ƒï¼Œå‚è€ƒ: <a href="https://openjdk.org/jeps/374" target="_blank" rel="noopener noreferrer">jeps-374<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h4 id="_1-3-3-è½»é‡çº§é”" tabindex="-1"><a class="header-anchor" href="#_1-3-3-è½»é‡çº§é”" aria-hidden="true">#</a> 1.3.3 è½»é‡çº§é”</h4><p>å¦‚æœä¸€ä¸ªçº¿ç¨‹å°è¯•è·å–ä¸€ä¸ªå¯¹è±¡çš„é”ï¼Œä½†è¯¥å¯¹è±¡å·²ç»è¢«å¦ä¸€ä¸ªçº¿ç¨‹è·å–äº†é”ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šå°†å¯¹è±¡çš„é”å‡çº§ä¸ºè½»é‡çº§é”çŠ¶æ€ã€‚å‡çº§ä¸ºè½»é‡çº§é”çŠ¶æ€åï¼Œè¯¥çº¿ç¨‹ä¼šåœ¨è‡ªå·±çš„çº¿ç¨‹æ ˆä¸­ç”³è¯·ä¸€å—ç©ºé—´ä½œä¸ºé”è®°å½•ï¼ˆLock Recordï¼‰ï¼Œå¹¶å°†å¯¹è±¡çš„Mark WordæŒ‡å‘è¯¥é”è®°å½•çš„åœ°å€ã€‚æ­¤æ—¶ï¼Œçº¿ç¨‹é€šè¿‡CASæ“ä½œæ›´æ–°å¯¹è±¡çš„Mark Wordï¼Œå°†å…¶æŒ‡å‘è‡ªå·±çš„é”è®°å½•ï¼Œä»¥è·å–å¯¹è±¡çš„é”ã€‚ï¼ˆçº¿ç¨‹å°è¯•ä½¿ç”¨CASå°†MarkWordæ›¿æ¢ä¸ºåªæƒ³é”è®°å½•çš„æŒ‡é’ˆï¼Œå¦‚æœæˆåŠŸï¼Œå½“å‰çº¿ç¨‹è·å¾—é”ï¼Œå¦‚æœå¤±è´¥ï¼Œè¡¨ç¤ºå…¶ä»–çº¿ç¨‹ç«äº‰é”ï¼Œå½“å‰çº¿ç¨‹ä¾¿æ“¦ç°å§‘å¨˜æ˜¯ä½¿ç”¨è‡ªæ—‹æ¥è·å–é”ï¼‰</p><h4 id="_1-3-4-é‡é‡çº§é”" tabindex="-1"><a class="header-anchor" href="#_1-3-4-é‡é‡çº§é”" aria-hidden="true">#</a> 1.3.4 é‡é‡çº§é”</h4><p>å¦‚æœä¸€ä¸ªå¯¹è±¡çš„è½»é‡çº§é”å‡çº§å¤±è´¥ï¼Œå³å¤šä¸ªçº¿ç¨‹ç«äº‰åŒä¸€ä¸ªé”ï¼Œé‚£ä¹ˆè¯¥é”ä¼šå‡çº§ä¸ºé‡é‡çº§é”çŠ¶æ€ï¼ˆå¦‚è½»é‡çº§é”è‡ªæ—‹è¾¾åˆ°è®¾å®šçš„æ¬¡æ•°ï¼‰ã€‚é‡é‡çº§é”æ˜¯ä¸€ç§åŸºäºæ“ä½œç³»ç»Ÿçš„é”ï¼Œå®ƒä½¿ç”¨æ“ä½œç³»ç»Ÿçš„äº’æ–¥é‡æ¥å®ç°é”çš„ç«äº‰ï¼Œç›¸å¯¹äºå‰é¢çš„ä¸‰ç§é”çº§åˆ«ï¼Œé‡é‡çº§é”çš„ç«äº‰å¼ºåº¦æ›´é«˜ï¼Œä½†å¼€é”€ä¹Ÿæ›´å¤§</p><div class="hint-container note"><p class="hint-container-title">é”ä¼˜åŒ–</p><p>é”ä¼˜åŒ–è¿˜åŒ…æ‹¬ è‡ªæ—‹é”ä¸è‡ªé€‚åº”é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–</p></div><h3 id="_1-4-åŸç†" tabindex="-1"><a class="header-anchor" href="#_1-4-åŸç†" aria-hidden="true">#</a> 1.4 åŸç†</h3><p><code>synchronized</code>çš„åŸç†æ˜¯é€šè¿‡å¯¹è±¡å¤´çš„ Mark Word å’Œæ“ä½œç³»ç»Ÿçš„äº’æ–¥é‡å®ç°</p><p>åœ¨æºç ä¸­çš„å®ç°å¦‚ä¸‹ï¼š</p><p>å¯¹äºåŒæ­¥ä»£ç å—,<code>monitorenter</code>å’Œ<code>monitorexit</code>åˆ†åˆ«å¯¹åº”åŠ é”å’Œè§£é”æ“ä½œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// synchronized code block</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¼–è¯‘åçš„å­—èŠ‚ç </p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0: aload_1
1: dup
2: astore_2
3: monitorenter    // åŠ é”
4: aload_2
5: monitorexit     // è§£é”
6: goto 14
9: astore_3
10: aload_2
11: monitorexit    // è§£é”
12: aload_3
13: athrow
14: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹äºåŒæ­¥æ–¹æ³•ï¼Œä½¿ç”¨ACC_SYNCHRONIZEDæ ‡å¿—æ¥è¡¨ç¤ºè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œè¿›å…¥è¯¥æ–¹æ³•æ—¶ä¼šè‡ªåŠ¨è·å–å¯¹è±¡ç›‘è§†å™¨ï¼ˆæˆ–ç§°ä¸ºé”ï¼‰ï¼Œæ–¹æ³•æ‰§è¡Œå®Œæˆåä¼šè‡ªåŠ¨é‡Šæ”¾é”ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// synchronized method</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¼–è¯‘åçš„å­—èŠ‚ç :</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>public synchronized void method();
    descriptor: ()V
    flags: ACC_PUBLIC, ACC_SYNCHRONIZED   // ACC_SYNCHRONIZEDæ ‡å¿—
    Code:
      stack=0, locals=1, args_size=1
         0: return
      LineNumberTable:
        line 7: 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">åœ¨JVMæºç ä¸­çš„å®ç°</p><p><a href="https://github.com/openjdk/jdk/blob/master/src/hotspot/share/runtime/objectMonitor.hpp" target="_blank" rel="noopener noreferrer">objectMonitor.hpp<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://github.com/openjdk/jdk/blob/jdk-17-ga/src/hotspot/share/runtime/objectMonitor.cpp" target="_blank" rel="noopener noreferrer">objectMonitor.cpp<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h2 id="_2-æ˜¾å¼é”-lock" tabindex="-1"><a class="header-anchor" href="#_2-æ˜¾å¼é”-lock" aria-hidden="true">#</a> 2. æ˜¾å¼é” <code>Lock</code></h2><p>é”æ—¶ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„æ–¹å¼ï¼Œä¸€èˆ¬æ¥è¯´ä¸€ä¸ªé”èƒ½å¤Ÿé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºã€‚</p><p>Javaä¸­æä¾›äº†: <code>java.util.concurrent.locks.Lock</code>æ¥å£ä½œä¸ºæ˜¾å¼é”ï¼Œä¸å†…ç½®åŠ é”æœºåˆ¶ä¸åŒçš„æ˜¯ï¼ŒLockæä¾›äº†ä¸€ç§æ— æ¡ä»¶çš„ã€å¯è½®è¯¢çš„ã€å®šæ—¶çš„ä»¥åŠå¯ä¸­æ–­çš„é”è·å–æ“ä½œï¼Œæ‰€æœ‰åŠ é”å’Œè§£é”æ–¹æ³•éƒ½æ˜¯æ˜¾å¼çš„ã€åœ¨Lockçš„å®ç°ä¸­å¿…é¡»æä¾›ä¸å†…éƒ¨é”ç›¸åŒçš„å†…å­˜å¯è§æ€§è¯­ä¹‰ï¼Œä½†åœ¨åŠ é”è¯­ä¹‰ã€è°ƒåº¦ç®—æ³•å’Œé¡ºåºä¿è¯ä»¥åŠæ€§èƒ½ç‰¹æ€§ç­‰æ–¹é¢å¯ä»¥æœ‰æ‰€ä¸åŒã€‚</p><h3 id="_2-1-lock" tabindex="-1"><a class="header-anchor" href="#_2-1-lock" aria-hidden="true">#</a> 2.1 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/Lock.html" target="_blank" rel="noopener noreferrer">Lock<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><h4 id="_2-1-1-lockçš„ä½¿ç”¨æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_2-1-1-lockçš„ä½¿ç”¨æ–¹å¼" aria-hidden="true">#</a> 2.1.1 Lockçš„ä½¿ç”¨æ–¹å¼:</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Lock</span> l <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>  
l<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">try</span> <span class="token punctuation">{</span>    
  <span class="token comment">// access the resource protected by this lock  </span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    
  l<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">æ³¨æ„</p><p>åœ¨<code>finally</code>ä¸­é‡Šæ”¾é”ï¼Œä¿è¯åœ¨è·å–é”ä¹‹åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¢«é‡Šæ”¾</p><p>ä¸è¦å°†è·å–é”çš„è¿‡ç¨‹å†™åœ¨<code>try</code>ä¸­ï¼Œå› ä¸ºå¦‚æœåœ¨è·å–é”(è‡ªå®šä¹‰é”çš„å®ç°)æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸çš„åŒæ—¶ä¹Ÿä¼šå¯¼è‡´é”æ— æ•…é‡Šæ”¾</p></div><h4 id="_2-1-2-lockæ¯”synchronizedæä¾›äº†æ›´å¤šçš„åŠŸèƒ½æ€§" tabindex="-1"><a class="header-anchor" href="#_2-1-2-lockæ¯”synchronizedæä¾›äº†æ›´å¤šçš„åŠŸèƒ½æ€§" aria-hidden="true">#</a> 2.1.2 Lockæ¯”<code>synchronized</code>æä¾›äº†æ›´å¤šçš„åŠŸèƒ½æ€§:</h4><ul><li><code>tryLock()</code>: éé˜»å¡å°è¯•è·å–é”</li><li><code>tryLock(long, TimeUnit)</code>: å¯è¶…æ—¶å°è¯•è·å–é”</li><li><code>lockInterruptibly()</code>: å¯ä¸­æ–­å°è¯•è·å–é”</li></ul><h4 id="_2-1-3-lockçš„api" tabindex="-1"><a class="header-anchor" href="#_2-1-3-lockçš„api" aria-hidden="true">#</a> 2.1.3 Lockçš„API</h4><div class="language-JAVA line-numbers-mode" data-ext="JAVA"><pre class="language-JAVA"><code>public interface Lock {

    /**
     * è·å–é”
     * è°ƒç”¨è¯¥æ–¹æ³•å½“å‰çº¿ç¨‹å°†ä¼šè·å–é”ï¼Œè·é”æˆåŠŸåä»è¯¥æ–¹æ³•è¿”å›
     */
    void lock();

    /**
     * å¯ä¸­æ–­åœ°è·å–é”
     * è¯¥æ–¹æ³•ä¼šå“åº”ä¸­æ–­ï¼Œå³åœ¨é”çš„è·å–ä¸­å¯ä»¥ç»ˆç«¯å½“å‰çº¿ç¨‹
     */
    void lockInterruptibly() throws InterruptedException;

    /**
     * å°è¯•éé˜»å¡çš„è·å–é”
     * è°ƒç”¨è¯¥æ–¹æ³•æŠ¤ç«‹åˆ»è¿”å›ï¼Œå¦‚æœèƒ½å¤Ÿè·å–åˆ™è¿”å›true,å¦åˆ™è¿”å›false
     * &lt;p&gt;
     * å…¸å‹ç”¨æ³•:
     * &lt;pre&gt; {@code
     * Lock lock = ...;
     * if (lock.tryLock()) {
     *   try {
     *     // manipulate protected state
     *   } finally {
     *     lock.unlock();
     *   }
     * } else {
     *   // perform alternative actions
     * }}&lt;/pre&gt;
     */
    boolean tryLock();

    /**
     * è¶…æ—¶çš„è·å–é”ï¼Œå½“å‰çº¿ç¨‹åœ¨ä»¥ä¸‹3ç§æƒ…å†µä¸‹ä¼šè¿”å›:
     * - å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†… è·å¾—é”
     * - å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†… è¢«ä¸­æ–­
     * - è¶…æ—¶æ—¶é—´ç»“æŸï¼Œè¿”å›false
     */
    boolean tryLock(long time, TimeUnit unit) throws InterruptedException;

    /**
     * é‡Šæ”¾é”
     */
    void unlock();

    /**
     * è·å–Condition
     * è¯¥Conditionå’Œå½“å‰é”ç»‘å®šï¼Œå½“å‰çº¿ç¨‹åªæœ‰è·å¾—äº†é”ï¼Œæ‰èƒ½è°ƒç”¨Conditionçš„wait()æ–¹æ³•ï¼Œè€Œè°ƒç”¨åï¼Œå½“å‰çº¿ç¨‹å°†é‡Šæ”¾é”
     */
    Condition newCondition();
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-é‡å…¥é”-reentrantlock" tabindex="-1"><a class="header-anchor" href="#_2-2-é‡å…¥é”-reentrantlock" aria-hidden="true">#</a> 2.2 é‡å…¥é” <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/ReentrantLock.html" target="_blank" rel="noopener noreferrer">ReentrantLock<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><p>ReentrantLockï¼Œé‡å…¥é”ï¼Œè¡¨ç¤ºè¯¥é”èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„é‡å¤åŠ é”ï¼Œä»»æ„çº¿ç¨‹åœ¨è·å–é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–è¯¥é”è€Œä¸ä¼šè¢«é”é˜»å¡ï¼Œè¯¥ç‰¹æ€§çš„å®ç°éœ€è¦è§£å†³ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜</p><ol><li><p>çº¿ç¨‹å†æ¬¡è·å–é”</p><p>é”éœ€è¦å»è¯†åˆ«è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰å æ®é”çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯åˆ™å†æ¬¡æˆåŠŸè·å–</p></li><li><p>é”çš„æœ€ç»ˆé‡Šæ”¾</p><p>çº¿ç¨‹é‡å¤næ¬¡è·å–é”ï¼Œéšååœ¨ç¬¬næ¬¡é‡Šæ”¾è¯¥é”åï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿè·å–è¯¥é”</p></li></ol><h4 id="_2-2-1-è½®è¯¢é”ä¸å®šæ—¶é”" tabindex="-1"><a class="header-anchor" href="#_2-2-1-è½®è¯¢é”ä¸å®šæ—¶é”" aria-hidden="true">#</a> 2.2.1 è½®è¯¢é”ä¸å®šæ—¶é”</h4><p>è½®è¯¢é”å’Œå®šæ—¶é”çš„è·å–æ¨¡å¼æ˜¯ç”±<code>tryLock</code>æ–¹æ³•å®ç°ã€‚</p><p>æ­£ç¡®çš„ä½¿ç”¨å¯ä»¥é¿å…æ­»é”çš„å‘ç”Ÿ: å¦‚æœä¸èƒ½è·å¾—æ‰€æœ‰éœ€è¦çš„é”ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨å¯å®šæ—¶çš„æˆ–å¯è½®è¯¢çš„é”è·å–æ–¹å¼ï¼Œä»è€Œæ˜¯çš„é‡æ–°è·å¾—æ§åˆ¶æƒï¼Œå®ƒä¼šé‡Šæ”¾å·²ç»è·å¾—çš„é”ï¼Œç„¶åé‡æ–°å°è¯•è·å–æ‰€æœ‰é”ã€‚</p><p>å®šæ—¶é”çš„å®ä¾‹: å¸¦æœ‰æ—¶é—´é™åˆ¶çš„åŠ é”</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å°è¯•è·å–é”ï¼Œç­‰å¾…1ç§’</span>
        <span class="token comment">// è·å–é”æˆåŠŸåçš„ä»£ç é€»è¾‘</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–é”å¤±è´¥åçš„å¤„ç†é€»è¾‘</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¤„ç†çº¿ç¨‹ä¸­æ–­å¼‚å¸¸</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡Šæ”¾é”</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-å¯ä¸­æ–­çš„é”è·å–æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#_2-2-2-å¯ä¸­æ–­çš„é”è·å–æ“ä½œ" aria-hidden="true">#</a> 2.2.2 å¯ä¸­æ–­çš„é”è·å–æ“ä½œ</h4><p>å¯ä¸­æ–­çš„é”è·å–æ“ä½œèƒ½åœ¨å¯å–æ¶ˆçš„æ“ä½œä¸­ä½¿ç”¨åŠ é”ï¼Œ<code>lockInterruptibly()</code>æ–¹æ³•èƒ½å¤Ÿåœ¨è·å¾—é”çš„åŒæ—¶ä¿æŒå¯¹ä¸­æ–­çš„å“åº”ï¼Œå¹¶ä¸”ç”±äºå®ƒåŒ…å«åœ¨Lockä¸­ï¼Œå› æ­¤æ— éœ€åˆ›å»ºå…¶ä»–ç±»å‹çš„ä¸å¯ä¸­æ–­é˜»å¡æœºåˆ¶ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°è¯•è·å–é”ï¼Œå¹¶å“åº”çº¿ç¨‹çš„ä¸­æ–­è¯·æ±‚</span>
    <span class="token comment">// è·å–é”æˆåŠŸåçš„ä»£ç é€»è¾‘</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¤„ç†çº¿ç¨‹ä¸­æ–­å¼‚å¸¸</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡Šæ”¾é”</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-3-éå—ç»“æ„çš„åŠ é”" tabindex="-1"><a class="header-anchor" href="#_2-2-3-éå—ç»“æ„çš„åŠ é”" aria-hidden="true">#</a> 2.2.3 éå—ç»“æ„çš„åŠ é”</h4><p>å†…ç½®é”æ˜¯å¯¹ä¸€ä¸ªå—ç»“æ„è¿›è¡ŒåŠ é”ï¼ŒReentrantLockæ˜¯éå—ç»“æ„è¿›è¡ŒåŠ é”</p><h4 id="_2-2-4-å…¬å¹³æ€§" tabindex="-1"><a class="header-anchor" href="#_2-2-4-å…¬å¹³æ€§" aria-hidden="true">#</a> 2.2.4 å…¬å¹³æ€§</h4><p>å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°ä¼ å‚æ¥å†³å®šReentrantLockçš„å…¬å¹³æ€§ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä¸­FairSyncå’ŒNonfairSyncéƒ½ç»§æ‰¿è‡ªå†…éƒ¨ç±»Syncï¼ŒSyncç»§æ‰¿AbstractQueuedSynchronizer</p><p>å…¬å¹³é”å’Œéå…¬å¹³é”çš„å®ç°éƒ½æ˜¯ç‹¬å çš„ï¼Œè°ƒç”¨äº†AQSçš„setExclusiveOwnerThreadæ–¹æ³•ï¼Œéƒ½æ˜¯æ’ä»–é”ã€‚</p><p>å…¬å¹³é”ï¼šçº¿ç¨‹å°†æŒ‰ç…§ä»–ä»¬å‘å‡ºè¯·æ±‚çš„é¡ºåºæ¥è·å¾—é”</p><p>éå…¬å¹³é”ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚éå…¬å¹³é”æ—¶ï¼Œå¦‚æœåœ¨å‘å‡ºè¯·æ±‚çš„åŒæ—¶è¯¥é”çš„çŠ¶æ€å˜ä¸ºå¯ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°†è·³è¿‡é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„ç­‰å¾…çº¿ç¨‹å¹¶è·å¾—è¿™ä¸ªé”</p><div class="hint-container warning"><p class="hint-container-title">å…¬å¹³é”</p><p>å¯¹äºå…¬å¹³é”ï¼Œå¯è½®è¯¢çš„tryLockä»ç„¶ä¼šâ€œæ’é˜Ÿâ€</p></div><div class="hint-container info"><p class="hint-container-title">ä¸ºä»€ä¹ˆReentrantLocké»˜è®¤æ˜¯éå…¬å¹³é”</p><p>éå…¬å¹³æ¨¡å¼æ•ˆç‡æ›´é«˜ï¼Œå› ä¸ºéå…¬å¹³æ¨¡å¼ä¼šåœ¨ä¸€å¼€å§‹å°±å°è¯•ä¸¤æ¬¡è·å–é”ï¼Œå¦‚æœå½“æ—¶æ­£å¥½stateæ˜¯0ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šæˆåŠŸè·å–é”ï¼Œå°‘äº†æ’é˜Ÿå¯¼è‡´çš„é˜»å¡/å”¤é†’è¿‡ç¨‹ï¼Œå¹¶ä¸”å‡å°‘äº†çº¿ç¨‹é¢‘ç¹çš„åˆ‡æ¢å¸¦æ¥çš„æ€§èƒ½æŸè€—</p><p>ä½†æ˜¯éå…¬å¹³é”æœ‰å¯èƒ½å¯¼è‡´ä¸€å¼€å§‹æ’é˜Ÿçš„çº¿ç¨‹ä¸€ç›´è·å–ä¸åˆ°é”ï¼Œå¯¼è‡´çº¿ç¨‹é¥¿æ­»</p></div><h4 id="_2-2-5-synchronizedå’Œreentrantlockçš„é€‰æ‹©" tabindex="-1"><a class="header-anchor" href="#_2-2-5-synchronizedå’Œreentrantlockçš„é€‰æ‹©" aria-hidden="true">#</a> 2.2.5 <code>synchronized</code>å’Œ<code>ReentrantLock</code>çš„é€‰æ‹©</h4><p><strong>åŠŸèƒ½</strong>ä¸Š: ä¼˜å…ˆä½¿ç”¨<code>synchronized</code>ï¼Œå¦‚æœæ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œéœ€è¦ä¸€äº›é«˜çº§åŠŸèƒ½æ—¶ä½¿ç”¨<code>ReentrantLock</code>,é«˜çº§åŠŸèƒ½åŒ…æ‹¬:</p><ul><li><p>å¯è½®è¯¢çš„ã€å¯å®šæ—¶çš„ ï¼ˆtryLockï¼‰</p></li><li><p>å¯ä¸­æ–­çš„é”è·å–æ“ä½œ ï¼ˆlockInterruptiblyï¼‰</p></li><li><p>å…¬å¹³é˜Ÿåˆ— ï¼ˆFairSyncï¼‰</p></li><li><p>éå—ç»“æ„çš„é”</p></li></ul><p><strong>æ€§èƒ½</strong>ä¸Š: ä¼˜å…ˆé€‰æ‹©<code>synchronized</code></p><p>å› ä¸º<code>synchronized</code>æ˜¯JVMçš„å†…ç½®å±æ€§ï¼Œèƒ½æ‰§è¡Œä¸€äº›ä¼˜åŒ–ï¼Œä¾‹å¦‚å¯¹çº¿ç¨‹å°é—­çš„é”å¯¹è±¡çš„é”æ¶ˆé™¤ä¼˜åŒ–ï¼Œé€šè¿‡åŠ é”çš„ç²’åº¦æ¥æ¶ˆé™¤å†…ç½®é”</p><h3 id="_2-3-è¯»-å†™é”-reentrantreadwritelock" tabindex="-1"><a class="header-anchor" href="#_2-3-è¯»-å†™é”-reentrantreadwritelock" aria-hidden="true">#</a> 2.3 è¯»-å†™é” <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/ReentrantReadWriteLock.html" target="_blank" rel="noopener noreferrer">ReentrantReadWriteLock<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><p><code>synchronized</code>å’Œ<code>ReentrantLock</code>å±äºæ’ä»–é”ã€‚è¯»-å†™é”é€‚ç”¨äº: ä¸€ä¸ªèµ„æºå¯ä»¥è¢«å¤šä¸ªè¯»æ“ä½œè®¿é—®ï¼Œæˆ–è¢«ä¸€ä¸ªå†™æ“ä½œè®¿é—®ï¼Œä½†ä¸¤è€…ä¸èƒ½åŒæ—¶è¿›è¡Œã€‚è¯»-å†™é”è§£å†³äº†è¯»-è¯»å†²çªçš„é—®é¢˜ï¼Œæ›´é€‚åˆäºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚</p><p>Javaä¸­æä¾›äº†ä¸€ä¸ªæ¥å£java.util.concurrent.locks.ReadWriteLockï¼Œç”¨äºå®ç°è¯»å†™é”ã€‚è¯¥æ¥å£æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šreadLock()å’ŒwriteLock()ï¼Œåˆ†åˆ«è¿”å›è¯»é”å’Œå†™é”ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚è¯»é”æ—¶ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰å†™é”ï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šç«‹å³è·å¾—è¯»é”ï¼Œå¦åˆ™å®ƒä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰æŒæœ‰å†™é”çš„çº¿ç¨‹é‡Šæ”¾å†™é”ã€‚åŒæ ·åœ°ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å†™é”æ—¶ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰è¯»é”æˆ–å†™é”ï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šç«‹å³è·å¾—å†™é”ï¼Œå¦åˆ™å®ƒä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰æŒæœ‰è¯»é”å’Œå†™é”çš„çº¿ç¨‹éƒ½é‡Šæ”¾å®ƒä»¬ã€‚</p><p>ç¤ºä¾‹: ç”¨è¯»-å†™é”æ¥åŒ…è£…Map</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReadWriteLock</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantReadWriteLock</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReadWriteMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReadWriteLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Lock</span> r <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Lock</span> w <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ReadWriteMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>map <span class="token operator">=</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¯¹remove,putAllç­‰æ–¹æ³•æ‰§è¡Œç›¸åŒçš„æ“ä½œ</span>
        w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-stampedlock" tabindex="-1"><a class="header-anchor" href="#_2-4-stampedlock" aria-hidden="true">#</a> 2.4 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/StampedLock.html" target="_blank" rel="noopener noreferrer">StampedLock<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><p>StampedLockå®ç°äº†è¯»å†™é”çš„åŠŸèƒ½ï¼Œå°†è¯»é”åˆ†ä¸ºä¹è§‚è¯»é”å’Œæ‚²è§‚è¯»é”ï¼Œä¸ä¼šåƒReentrantReadWriteLockå‘ç”Ÿå†™é¥¥é¥¿ï¼Œæ ¸å¿ƒæ€æƒ³: åœ¨è¯»çš„æ—¶å€™å¦‚æœå‘ç”Ÿäº†å†™ï¼Œåº”è¯¥é€šè¿‡é‡è¯•çš„æ–¹å¼æ¥è·å–æ–°çš„å€¼ï¼Œè€Œä¸æ˜¯é˜»å¡è¯¥å†™æ“ä½œï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘ï¼Œä¾‹å¦‚ç¼“å­˜ç³»ç»Ÿã€æ•°æ®åº“ç³»ç»Ÿã€‚</p><p>StampedLockçš„å†…éƒ¨å®ç°æ˜¯åŸºäºä¸€ä¸ªæ•´æ•°stampï¼Œå®ƒç±»ä¼¼äºä¸€ä¸ªç‰ˆæœ¬å·ï¼Œç”¨æ¥æ ‡è®°å½“å‰é”çš„çŠ¶æ€ã€‚åœ¨è¯»æ“ä½œçš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šè·å–ä¸€ä¸ªstampå€¼ï¼Œå¹¶ç”¨è¿™ä¸ªstampå€¼æ¥åˆ¤æ–­è¯»æ“ä½œæ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼›åœ¨å†™æ“ä½œçš„æ—¶å€™ï¼Œçº¿ç¨‹éœ€è¦å…ˆè·å–ä¸€ä¸ªç‹¬å é”ï¼Œç„¶åå°†stampå€¼+1ï¼Œä»¥è¡¨ç¤ºè¯»æ“ä½œæ— æ•ˆã€‚è¿™æ ·ï¼Œåœ¨è¯»æ“ä½œè¿‡ç¨‹ä¸­å¦‚æœå‘ç°å½“å‰stampå€¼å·²ç»å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå°±éœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p><p>StampedLockæä¾›äº†ä¸‰ç§é”æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯è¯»é”ã€å†™é”å’Œä¹è§‚é”ã€‚</p><p>åœ¨è¯»é”æ¨¡å¼ä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»å–å…±äº«æ•°æ®ï¼Œä½†æ˜¯å†™æ“ä½œä¼šè¢«é˜»å¡ï¼›</p><p>åœ¨å†™é”æ¨¡å¼ä¸‹ï¼Œç‹¬å é”è¢«ç”¨äºä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ‰€æœ‰è¯»å†™æ“ä½œéƒ½ä¼šè¢«é˜»å¡ï¼›</p><p>åœ¨ä¹è§‚é”æ¨¡å¼ä¸‹ï¼Œçº¿ç¨‹ä¼šè·å–ä¸€ä¸ªstampå€¼ï¼Œå¹¶å°è¯•è¯»å–å…±äº«æ•°æ®ï¼Œå¦‚æœè¯»å–æˆåŠŸï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™éœ€è¦é‡æ–°è·å–é”ã€‚</p><p>ç›¸æ¯”äºReadWriteLockï¼ŒStampedLockå…·æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š</p><ol><li>æ›´é«˜çš„å¹¶å‘æ€§èƒ½ã€‚StampedLocké‡‡ç”¨äº†ä¹è§‚é”çš„æ€æƒ³ï¼Œå‡å°‘äº†çº¿ç¨‹é˜»å¡çš„æƒ…å†µï¼Œä»è€Œæé«˜äº†å¹¶å‘æ€§èƒ½ã€‚</li><li>æ›´ä½çš„çº¿ç¨‹é˜»å¡ã€‚StampedLockå†…éƒ¨é‡‡ç”¨äº†è‡ªæ—‹é”çš„æ–¹å¼ï¼Œé¿å…äº†çº¿ç¨‹é˜»å¡çš„æƒ…å†µï¼Œä»è€Œæé«˜äº†çº¿ç¨‹çš„å“åº”é€Ÿåº¦ã€‚</li><li>æ›´å¥½çš„å¯æ‰©å±•æ€§ã€‚StampedLockæ”¯æŒå¤šä¸ªè¯»çº¿ç¨‹åŒæ—¶è¯»å–å…±äº«æ•°æ®ï¼Œä»è€Œæé«˜äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚</li><li>æ›´å¥½çš„æ•°æ®ä¸€è‡´æ€§ã€‚StampedLockå†…éƒ¨é‡‡ç”¨äº†ç‹¬å é”çš„æ–¹å¼ï¼Œä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ï¼Œé¿å…äº†è¯»å†™å†²çªçš„æƒ…å†µã€‚</li></ol><p>ä»£ç ç¤ºä¾‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">StampedLock</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StampedLockDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StampedLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token keyword">double</span> deltaX<span class="token punctuation">,</span> <span class="token keyword">double</span> deltaY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å†™é”</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            x <span class="token operator">+=</span> deltaX<span class="token punctuation">;</span>
            y <span class="token operator">+=</span> deltaY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// é‡Šæ”¾å†™é”</span>
            lock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">distanceFromOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–ä¹è§‚è¯»é”</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> currentX <span class="token operator">=</span> x<span class="token punctuation">,</span> currentY <span class="token operator">=</span> y<span class="token punctuation">;</span>
        <span class="token comment">// æ£€æŸ¥é”æ˜¯å¦æœ‰æ•ˆ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å–æ‚²è§‚è¯»é”</span>
            stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                currentX <span class="token operator">=</span> x<span class="token punctuation">;</span>
                currentY <span class="token operator">=</span> y<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// é‡Šæ”¾æ‚²è§‚è¯»é”</span>
                lock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>currentX <span class="token operator">*</span> currentX <span class="token operator">+</span> currentY <span class="token operator">*</span> currentY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>åœ¨ç¼“å­˜ä¸­çš„åº”ç”¨ä»£ç ç¤ºä¾‹</summary><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">StampedLock</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StampedLockCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StampedLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°è¯•è·å–ä¹è§‚è¯»é”</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">V</span> value <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ£€æŸ¥é”æ˜¯å¦æœ‰æ•ˆ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å–æ‚²è§‚è¯»é”</span>
            stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                value <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// é‡Šæ”¾æ‚²è§‚è¯»é”</span>
                lock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å†™é”</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// é‡Šæ”¾å†™é”</span>
            lock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å†™é”</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            cache<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// é‡Šæ”¾å†™é”</span>
            lock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h3 id="_2-5-condition" tabindex="-1"><a class="header-anchor" href="#_2-5-condition" aria-hidden="true">#</a> 2.5 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/Condition.html" target="_blank" rel="noopener noreferrer">Condition<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><p>Javaä¸­çš„Conditionæ˜¯ä¸€ä¸ªä¸Lockç›¸å…³è”çš„æ¡ä»¶é˜Ÿåˆ—ï¼Œå®ƒæä¾›äº†ä¸€ç§è®©çº¿ç¨‹èƒ½å¤Ÿç­‰å¾…æŸä¸ªæ¡ä»¶æˆç«‹çš„æœºåˆ¶ã€‚åœ¨Javaä¸­ï¼ŒConditioné€šå¸¸ç”¨äºè§£å†³çº¿ç¨‹é—´çš„åä½œé—®é¢˜ï¼Œæ¯”å¦‚ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ç­‰ã€‚</p><p>ä»£ç ç¤ºä¾‹: ä½¿ç”¨Conditionçš„æœ‰ç•Œç¼“å­˜</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Condition</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantLock</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConditionBoundedBuffer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">BUFFER_SIZE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// count &lt; items.length</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// count &gt; 0</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> items <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token constant">BUFFER_SIZE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> head<span class="token punctuation">,</span> tail<span class="token punctuation">,</span> count<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">T</span> x<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            items<span class="token punctuation">[</span>tail<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>tail <span class="token operator">==</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> tail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>count<span class="token punctuation">;</span>

            notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">T</span> x <span class="token operator">=</span> items<span class="token punctuation">[</span>head<span class="token punctuation">]</span><span class="token punctuation">;</span>
            items<span class="token punctuation">[</span>head<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>head <span class="token operator">==</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> head <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token operator">--</span>count<span class="token punctuation">;</span>

            notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">ç‰¹åˆ«æ³¨æ„</p><p>åœ¨Conditionå¯¹è±¡ä¸­ï¼Œä¸waitã€notifyå’ŒnotifyAllæ–¹æ³•å¯¹åº”çš„åˆ†åˆ«æ˜¯awaitï¼Œsignalå’ŒsignalAllã€‚</p><p>ä½†æ˜¯Conditionå¯¹Objectè¿›è¡Œäº†æ‰©å±•ï¼Œä¹ŸåŒ…å«waitã€notifyå’ŒnotifyAllã€‚</p></div><details class="hint-container details"><summary>Javaåˆ†æ®µé”ç¤ºä¾‹</summary><blockquote><p><a href="https://juejin.cn/post/6898255397497339912" target="_blank" rel="noopener noreferrer">Java ä¸­å¸¸è§çš„ç»†ç²’åº¦é”å®ç° - æ˜é‡‘ (juejin.cn)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantLock</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SegmentedLockExample</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Lock</span><span class="token punctuation">&gt;</span></span> locks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateProperty</span><span class="token punctuation">(</span><span class="token class-name">String</span> objectId<span class="token punctuation">,</span> <span class="token class-name">String</span> propertyName<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token function">getLock</span><span class="token punctuation">(</span>objectId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¿›è¡Œä¿®æ”¹æ“ä½œ</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Lock</span> <span class="token function">getLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> objectId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Lock</span> lock <span class="token operator">=</span> locks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>objectId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            locks<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>objectId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock <span class="token operator">=</span> locks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>objectId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> lock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><hr><h2 id="_3-é”ç›¸å…³çš„æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_3-é”ç›¸å…³çš„æºç åˆ†æ" aria-hidden="true">#</a> 3. é”ç›¸å…³çš„æºç åˆ†æ</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>jdk/src/java.base/share/classes/java/util/concurrent/locks
â”œâ”€â”€ AbstractOwnableSynchronizer.java
â”œâ”€â”€ AbstractQueuedLongSynchronizer.java
â”œâ”€â”€ AbstractQueuedSynchronizer.java
â”œâ”€â”€ Condition.java
â”œâ”€â”€ Lock.java
â”œâ”€â”€ LockSupport.java
â”œâ”€â”€ ReadWriteLock.java
â”œâ”€â”€ ReentrantLock.java
â”œâ”€â”€ ReentrantReadWriteLock.java
â””â”€â”€ StampedLock.java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-1-aqs" tabindex="-1"><a class="header-anchor" href="#_3-1-aqs" aria-hidden="true">#</a> 3.1 <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/locks/AbstractQueuedSynchronizer.html" target="_blank" rel="noopener noreferrer">AQS<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><p>AQSæ˜¯<code>AbstractQueuedSynchronizer</code>çš„ç®€ç§°ï¼Œè¯‘æˆæŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨</p><p>AQSå¯ä»¥ç”¨æ¥æ„å»ºé”å’ŒåŒæ­¥å™¨çš„æ¡†æ¶ï¼Œå¦‚ReentrantLock,Semaphore,FutureTash,CountDownLatchç­‰</p><div class="hint-container tip"><p class="hint-container-title">AOSã€AQLS</p><p>ç›¸å…³çš„ç±»æœ‰AOS:AbstractOwnableSynchronizerã€AQLS: AbstractQueuedLongSynchronizerï¼ŒAQLSçš„stateæ˜¯long,AOSæ˜¯ä¸¤è€…çš„åŸºç±»</p></div><h4 id="_3-1-1-æºç æ³¨é‡Šä¸­çš„-overview" tabindex="-1"><a class="header-anchor" href="#_3-1-1-æºç æ³¨é‡Šä¸­çš„-overview" aria-hidden="true">#</a> 3.1.1 æºç æ³¨é‡Šä¸­çš„&quot;Overview&quot;</h4><details class="hint-container details"><summary>AQS Overview</summary><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>The wait queue is a variant of a &quot;CLH&quot; (Craig, Landin, and Hagersten) lock queue. 
CLH locks are normally used for spinlocks.
We instead use them for blocking synchronizers by including explicit (&quot;prev&quot; and &quot;next&quot;) links plus a &quot;status&quot; field that allo w nodes to signal successors when releasinglocks, and handle cancellation due to interrupts and timeouts.
The status field includes bits that track whether a thread needs a signal (using LockSupport.unpark). 
Despite these additions, we maintain most CLH locality properties.

ç­‰å¾…é˜Ÿåˆ—æ˜¯â€œCLHâ€ï¼ˆCraigï¼ŒLandinå’ŒHagerstenï¼‰é”é˜Ÿåˆ—çš„ä¸€ç§å˜ä½“ã€‚
CLHé”é€šå¸¸ç”¨äºè‡ªæ—‹é”ã€‚
è€Œæˆ‘ä»¬ä½¿ç”¨å®ƒä»¬ç”¨äºé˜»å¡åŒæ­¥å™¨ï¼ŒåŒ…æ‹¬æ˜¾å¼çš„ï¼ˆâ€œprevâ€å’Œâ€œnextâ€ï¼‰é“¾æ¥ä»¥åŠä¸€ä¸ªâ€œstatusâ€å­—æ®µï¼Œå…è®¸èŠ‚ç‚¹åœ¨é‡Šæ”¾é”æ—¶å‘åç»§å‘å‡ºä¿¡å·ï¼Œå¹¶å¤„ç†ç”±äºä¸­æ–­å’Œè¶…æ—¶è€Œå–æ¶ˆçš„æƒ…å†µã€‚
çŠ¶æ€å­—æ®µåŒ…æ‹¬è·Ÿè¸ªçº¿ç¨‹æ˜¯å¦éœ€è¦ä¿¡å·ï¼ˆä½¿ç”¨LockSupport.unparkï¼‰çš„ä½ã€‚
å°½ç®¡æœ‰è¿™äº›æ·»åŠ ï¼Œæˆ‘ä»¬ä»ç„¶ä¿æŒå¤§éƒ¨åˆ†CLHå±€éƒ¨æ€§è´¨ã€‚

To enqueue into a CLH lock, you atomically splice it in as newtail. 
To dequeue, you set the head field, so the next eligible waiter becomes first.

å°†å…ƒç´ å…¥é˜Ÿåˆ°CLHé”ä¸­ï¼Œéœ€è¦å°†å…¶ä½œä¸ºæ–°çš„å°¾èŠ‚ç‚¹åŸå­åœ°æ’å…¥ã€‚
è¦å‡ºé˜Ÿï¼Œæ‚¨éœ€è¦è®¾ç½®å¤´èŠ‚ç‚¹ï¼Œè¿™æ ·ä¸‹ä¸€ä¸ªå¯ç”¨çš„ç­‰å¾…è€…å°±ä¼šæˆä¸ºç¬¬ä¸€ä¸ªã€‚

  +------+  prev +-------+       +------+
  | head | &lt;---- | first | &lt;---- | tail |
  +------+       +-------+       +------+
  
Insertion into a CLH queue requires only a single atomic operation on &quot;tail&quot;, so there is a simple point of demarcation from unqueued to queued. 
The &quot;next&quot; link of the predecessor is set by the enqueuing thread after successful CAS. 
Even though non-atomic, this suffices to ensure that any blocked thread is signalled by a predecessor when eligible (although in the case of cancellation, possibly with the assistance of a signal in method cleanQueue). 
Signalling is based in part on a Dekker-like scheme in which the to-be waiting thread indicates WAITING status, then retries acquiring, and then rechecks status before blocking. 
The signaller atomically clears WAITING status when unparking.

å°†å…ƒç´ æ’å…¥åˆ°CLHé˜Ÿåˆ—ä¸­ä»…éœ€è¦å¯¹â€œtailâ€è¿›è¡Œå•ä¸ªåŸå­æ“ä½œï¼Œå› æ­¤ä»æœªæ’é˜Ÿåˆ°å·²æ’é˜Ÿæœ‰ä¸€ä¸ªç®€å•çš„åˆ†ç•Œç‚¹ã€‚
åœ¨æˆåŠŸçš„CASæ“ä½œä¹‹åï¼Œå‰ç½®èŠ‚ç‚¹çš„â€œnextâ€é“¾æ¥ç”±å…¥é˜Ÿçº¿ç¨‹è®¾ç½®ã€‚
å³ä½¿éåŸå­æ€§ï¼Œè¿™ä¹Ÿè¶³ä»¥ç¡®ä¿ä»»ä½•è¢«é˜»å¡çš„çº¿ç¨‹åœ¨ç¬¦åˆæ¡ä»¶æ—¶ç”±å‰ç½®èŠ‚ç‚¹å‘å‡ºä¿¡å·ï¼ˆå°½ç®¡åœ¨å–æ¶ˆçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦åœ¨cleanQueueæ–¹æ³•ä¸­ä½¿ç”¨ä¿¡å·æ¥ååŠ©ï¼‰ã€‚
ä¿¡å·éƒ¨åˆ†åŸºäºç±»ä¼¼Dekkeræ–¹æ¡ˆçš„æ–¹æ¡ˆï¼Œåœ¨è¯¥æ–¹æ¡ˆä¸­ï¼Œå¾…ç­‰å¾…çš„çº¿ç¨‹æŒ‡ç¤ºç­‰å¾…çŠ¶æ€ï¼Œç„¶åé‡è¯•è·å–ï¼Œç„¶ååœ¨é˜»å¡ä¹‹å‰é‡æ–°æ£€æŸ¥çŠ¶æ€ã€‚
å‘ä¿¡å·è€…åœ¨è§£é™¤é˜»å¡æ—¶åŸå­æ€§åœ°æ¸…é™¤WAITINGçŠ¶æ€ã€‚

Dequeuing on acquire involves detaching (nulling) a node&#39;s &quot;prev&quot; node and then updating the &quot;head&quot;. 
Other threads check if a node is or was dequeued by checking &quot;prev&quot; rather than head. 
We enforce the nulling then setting order by spin-waiting if necessary. 
Because of this, the lock algorithm is not itself strictly &quot;lock-free&quot; because an acquiring thread may need to wait for a previous acquire to make progress. 
When used with exclusive locks, such progress is required anyway. 
However Shared mode may (uncommonly) require a spin-wait before setting head field to ensure proper propagation. 
(Historical note: This allows some simplifications and efficiencies compared to previous versions of this class.)

è·å–æ—¶å‡ºåˆ—æ¶‰åŠåˆ†ç¦»ï¼ˆæ¸…ç©ºï¼‰èŠ‚ç‚¹çš„â€œprevâ€èŠ‚ç‚¹ï¼Œç„¶åæ›´æ–°â€œheadâ€ã€‚
å…¶ä»–çº¿ç¨‹é€šè¿‡æ£€æŸ¥â€œprevâ€è€Œä¸æ˜¯ head æ¥æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å‡ºé˜Ÿã€‚
å¦‚æœ‰å¿…è¦ï¼Œæˆ‘ä»¬é€šè¿‡è‡ªæ—‹ç­‰å¾…æ¥å¼ºåˆ¶æ‰§è¡Œæ¸…é›¶ç„¶åè®¾ç½®é¡ºåºã€‚
å› æ­¤ï¼Œé”å®šç®—æ³•æœ¬èº«å¹¶ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„â€œæ— é”â€ï¼Œå› ä¸ºè·å–çº¿ç¨‹å¯èƒ½éœ€è¦ç­‰å¾…å…ˆå‰çš„è·å–æ‰èƒ½å–å¾—è¿›å±•ã€‚
å½“ä¸ç‹¬å é”ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œæ— è®ºå¦‚ä½•éƒ½éœ€è¦è¿™æ ·çš„è¿›å±•ã€‚
ç„¶è€Œï¼Œå…±äº«æ¨¡å¼å¯èƒ½ï¼ˆä¸å¸¸è§ï¼‰éœ€è¦åœ¨è®¾ç½® head å­—æ®µä¹‹å‰è¿›è¡Œè‡ªæ—‹ç­‰å¾…ä»¥ç¡®ä¿æ­£ç¡®ä¼ æ’­ã€‚
ï¼ˆå†å²è®°å½•ï¼šä¸æ­¤ç±»çš„å…ˆå‰ç‰ˆæœ¬ç›¸æ¯”ï¼Œè¿™å…è®¸ä¸€äº›ç®€åŒ–å’Œæ•ˆç‡ã€‚ï¼‰

A node&#39;s predecessor can change due to cancellation while it is waiting, until the node is first in queue, at which point it cannot change. 
The acquire methods cope with this by rechecking &quot;prev&quot; before waiting. 
The prev and next fields are modified only via CAS by cancelled nodes in method cleanQueue. 
The unsplice strategy is reminiscent of Michael-Scott queues in that after a successful CAS to prev field, other threads help fix next fields.  
Because cancellation often occurs in bunches that complicate decisions about necessary signals, each call to cleanQueue traverses the queue until a clean sweep. 
Nodes that become relinked as first are unconditionally unparked (sometimes unnecessarily, but those cases are not worth avoiding).

èŠ‚ç‚¹çš„å‰ä»»èŠ‚ç‚¹åœ¨ç­‰å¾…æœŸé—´å¯èƒ½ä¼šå› å–æ¶ˆè€Œå‘ç”Ÿæ›´æ”¹ï¼Œç›´åˆ°è¯¥èŠ‚ç‚¹ä½äºé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ­¤æ—¶å®ƒä¸èƒ½æ›´æ”¹ã€‚
acquire æ–¹æ³•é€šè¿‡åœ¨ç­‰å¾…ä¹‹å‰é‡æ–°æ£€æŸ¥â€œprevâ€æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
prev å’Œ next å­—æ®µåªèƒ½é€šè¿‡ cleanQueue æ–¹æ³•ä¸­å–æ¶ˆçš„èŠ‚ç‚¹é€šè¿‡ CAS è¿›è¡Œä¿®æ”¹ã€‚
unsplice ç­–ç•¥è®©äººæƒ³èµ· Michael-Scott é˜Ÿåˆ—ï¼Œå› ä¸ºåœ¨æˆåŠŸ CAS åˆ°ä¸Šä¸€ä¸ªå­—æ®µä¹‹åï¼Œå…¶ä»–çº¿ç¨‹å¸®åŠ©ä¿®å¤ä¸‹ä¸€ä¸ªå­—æ®µã€‚
ç”±äºå–æ¶ˆé€šå¸¸æˆæ‰¹å‘ç”Ÿï¼Œè¿™ä½¿å¾—æœ‰å…³å¿…è¦ä¿¡å·çš„å†³ç­–å˜å¾—å¤æ‚ï¼Œå› æ­¤æ¯æ¬¡è°ƒç”¨ cleanQueue éƒ½ä¼šéå†é˜Ÿåˆ—ï¼Œç›´åˆ°å½»åº•æ¸…é™¤ã€‚
é¦–å…ˆé‡æ–°é“¾æ¥çš„èŠ‚ç‚¹å°†æ— æ¡ä»¶åœ°å–æ¶ˆåœæ”¾ï¼ˆæœ‰æ—¶æ˜¯ä¸å¿…è¦çš„ï¼Œä½†è¿™äº›æƒ…å†µä¸å€¼å¾—é¿å…ï¼‰ã€‚

A thread may try to acquire if it is first (frontmost) in the queue, and sometimes before.  
Being first does not guarantee success; it only gives the right to contend. 
We balance throughput, overhead, and fairness by allowing incoming threads to &quot;barge&quot; and acquire the synchronizer while in the process of enqueuing, in which case an awakened first thread may need to rewait.  
To counteract possible repeated unlucky rewaits, we exponentially increase retries (up to 256) to acquire each time a thread is unparked.
Except in this case, AQS locks do not spin; they instead interleave attempts to acquire with bookkeeping steps. 
(Users who want spinlocks can use tryAcquire.)

å¦‚æœçº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­æ’åœ¨ç¬¬ä¸€ä½ï¼ˆæœ€å‰é¢ï¼‰ï¼Œæœ‰æ—¶å¯èƒ½ä¼šå°è¯•è·å–ã€‚
æˆä¸ºç¬¬ä¸€å¹¶ä¸èƒ½ä¿è¯æˆåŠŸï¼› å®ƒåªèµ‹äºˆç«äº‰çš„æƒåˆ©ã€‚
æˆ‘ä»¬é€šè¿‡å…è®¸ä¼ å…¥çº¿ç¨‹åœ¨æ’é˜Ÿè¿‡ç¨‹ä¸­â€œé—¯å…¥â€å¹¶è·å–åŒæ­¥å™¨æ¥å¹³è¡¡ååé‡ã€å¼€é”€å’Œå…¬å¹³æ€§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¬¬ä¸€ä¸ªè¢«å”¤é†’çš„çº¿ç¨‹å¯èƒ½éœ€è¦é‡æ–°ç­‰å¾…ã€‚
ä¸ºäº†æŠµæ¶ˆå¯èƒ½é‡å¤çš„ä¸å¹¸é‡æ–°ç­‰å¾…ï¼Œæˆ‘ä»¬ä»¥æŒ‡æ•°æ–¹å¼å¢åŠ é‡è¯•æ¬¡æ•°ï¼ˆæœ€å¤š 256 æ¬¡ï¼‰ä»¥è·å–æ¯æ¬¡çº¿ç¨‹æœªåœæ”¾çš„æ—¶é—´ã€‚
é™¤äº†è¿™ç§æƒ…å†µï¼ŒAQS é”ä¸ä¼šè‡ªæ—‹ï¼› ç›¸åï¼Œä»–ä»¬å°†è·å–çš„å°è¯•ä¸ç°¿è®°æ­¥éª¤äº¤ç»‡åœ¨ä¸€èµ·ã€‚
ï¼ˆæƒ³è¦è‡ªæ—‹é”çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨ tryAcquireã€‚ï¼‰

To improve garbage collectibility, fields of nodes not yet on list are null. 
(It is not rare to create and then throw away a node without using it.) 
Fields of nodes coming off the list are nulled out as soon as possible. 
This accentuates the challenge of externally determining the first waiting thread (as in method getFirstQueuedThread). 
This sometimes requires the fallback of traversing backwards from the atomically updated &quot;tail&quot; when fields appear null. (This is never needed in the process of signalling though.)

ä¸ºäº†æé«˜åƒåœ¾å›æ”¶èƒ½åŠ›ï¼Œå°šæœªåœ¨åˆ—è¡¨ä¸­çš„èŠ‚ç‚¹çš„å­—æ®µä¸ºç©ºã€‚
ï¼ˆåˆ›å»ºç„¶åä¸¢å¼ƒä¸€ä¸ªèŠ‚ç‚¹è€Œä¸ä½¿ç”¨å®ƒçš„æƒ…å†µå¹¶ä¸å°‘è§ã€‚ï¼‰
ç¦»å¼€åˆ—è¡¨çš„èŠ‚ç‚¹å­—æ®µå°†å°½å¿«æ¸…é›¶ã€‚
è¿™çªå‡ºäº†ä»å¤–éƒ¨ç¡®å®šç¬¬ä¸€ä¸ªç­‰å¾…çº¿ç¨‹çš„æŒ‘æˆ˜ï¼ˆå¦‚åœ¨æ–¹æ³• getFirstQueuedThread ä¸­ï¼‰ã€‚
è¿™æœ‰æ—¶éœ€è¦åœ¨å­—æ®µæ˜¾ç¤ºä¸ºç©ºæ—¶ä»åŸå­æ›´æ–°çš„â€œå°¾éƒ¨â€å‘åéå†çš„å›é€€ã€‚ ï¼ˆå°½ç®¡åœ¨ä¿¡å·å‘é€è¿‡ç¨‹ä¸­ä»æ¥ä¸éœ€è¦è¿™æ ·åšã€‚ï¼‰

CLH queues need a dummy header node to get started. 
But we don&#39;t create them on construction, because it would be wasted effort if there is never contention. 
Instead, the node is constructed and head and tail pointers are set upon first contention.

CLH é˜Ÿåˆ—éœ€è¦ä¸€ä¸ªè™šæ‹Ÿå¤´èŠ‚ç‚¹æ‰èƒ½å¼€å§‹ã€‚
ä½†æ˜¯æˆ‘ä»¬ä¸ä¼šåœ¨æ„å»ºæ—¶åˆ›å»ºå®ƒä»¬ï¼Œå› ä¸ºå¦‚æœæ°¸è¿œæ²¡æœ‰äº‰ç”¨ï¼Œé‚£å°†æ˜¯æµªè´¹ç²¾åŠ›ã€‚
å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œæ„é€ èŠ‚ç‚¹å¹¶åœ¨ç¬¬ä¸€æ¬¡äº‰ç”¨æ—¶è®¾ç½®å¤´æŒ‡é’ˆå’Œå°¾æŒ‡é’ˆã€‚

Shared mode operations differ from Exclusive in that an acquire signals the next waiter to try to acquire if it is also Shared. 
The tryAcquireShared API allows users to indicate the degree of propagation, but in most applications, it is more efficient to ignore this, allowing the successor to try acquiring in any case.

Shared æ¨¡å¼æ“ä½œä¸ Exclusive çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå¦‚æœå®ƒä¹Ÿæ˜¯ Sharedï¼Œåˆ™ acquire ä¼šé€šçŸ¥ä¸‹ä¸€ä¸ªæœåŠ¡å‘˜å°è¯•è·å–ã€‚
tryAcquireShared API å…è®¸ç”¨æˆ·æŒ‡ç¤ºä¼ æ’­ç¨‹åº¦ï¼Œä½†åœ¨å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸­ï¼Œå¿½ç•¥è¿™ä¸€ç‚¹æ•ˆç‡æ›´é«˜ï¼Œè®©åç»§è€…åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½å¯ä»¥å°è¯•è·å–ã€‚

Threads waiting on Conditions use nodes with an additional link to maintain the (FIFO) list of conditions. 
Conditions only need to link nodes in simple (non-concurrent) linked queues because they are only accessed when exclusively held.  
Upon await, a node is inserted into a condition queue.  
Upon signal, the node is enqueued on the main queue.  
A special status field value is used to track and atomically trigger this.

ç­‰å¾…æ¡ä»¶çš„çº¿ç¨‹ä½¿ç”¨å¸¦æœ‰é™„åŠ é“¾æ¥çš„èŠ‚ç‚¹æ¥ç»´æŠ¤ (FIFO) æ¡ä»¶åˆ—è¡¨ã€‚
æ¡ä»¶åªéœ€è¦é“¾æ¥ç®€å•ï¼ˆéå¹¶å‘ï¼‰é“¾æ¥é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼Œå› ä¸ºå®ƒä»¬ä»…åœ¨ç‹¬å æ—¶æ‰è¢«è®¿é—®ã€‚
åœ¨ç­‰å¾…æ—¶ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¢«æ’å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—ä¸­ã€‚
æ”¶åˆ°ä¿¡å·åï¼ŒèŠ‚ç‚¹å°†åœ¨ä¸»é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚
ä¸€ä¸ªç‰¹æ®Šçš„çŠ¶æ€å­—æ®µå€¼ç”¨äºè·Ÿè¸ªå’Œè‡ªåŠ¨è§¦å‘å®ƒã€‚

Accesses to fields head, tail, and state use full Volatile mode, along with CAS. 
Node fields status, prev and next also do so while threads may be signallable, but sometimes use weaker modes otherwise. 
Accesses to field &quot;waiter&quot; (the thread to be signalled) are always sandwiched between other atomic accesses so are used in Plain mode. 
We use jdk.internal Unsafe versions of atomic access methods rather than VarHandles to avoid potential VM bootstrap issues.

å¯¹å­—æ®µ headã€tail å’Œ state çš„è®¿é—®ä½¿ç”¨å®Œæ•´çš„ Volatile æ¨¡å¼ä»¥åŠ CASã€‚
èŠ‚ç‚¹å­—æ®µ statusã€prev å’Œ next ä¹Ÿè¿™æ ·åšï¼Œè€Œçº¿ç¨‹å¯èƒ½æ˜¯å¯å‘ä¿¡å·çš„ï¼Œä½†æœ‰æ—¶ä½¿ç”¨è¾ƒå¼±çš„æ¨¡å¼ã€‚
å¯¹å­—æ®µâ€œwaiterâ€ï¼ˆè¦å‘å‡ºä¿¡å·çš„çº¿ç¨‹ï¼‰çš„è®¿é—®æ€»æ˜¯å¤¹åœ¨å…¶ä»–åŸå­è®¿é—®ä¹‹é—´ï¼Œå› æ­¤åœ¨æ™®é€šæ¨¡å¼ä¸‹ä½¿ç”¨ã€‚
æˆ‘ä»¬ä½¿ç”¨ jdk.internal åŸå­è®¿é—®æ–¹æ³•çš„ä¸å®‰å…¨ç‰ˆæœ¬è€Œä¸æ˜¯ VarHandles æ¥é¿å…æ½œåœ¨çš„ VM å¼•å¯¼é—®é¢˜ã€‚

Most of the above is performed by primary internal method acquire, that is invoked in some way by all exported acquire methods.  
(It is usually easy for compilers to optimize call-site specializations when heavily used.)

ä¸Šé¢çš„å¤§éƒ¨åˆ†æ˜¯ç”±ä¸»è¦çš„å†…éƒ¨æ–¹æ³• acquire æ‰§è¡Œçš„ï¼Œæ‰€æœ‰å¯¼å‡ºçš„ acquire æ–¹æ³•éƒ½ä»¥æŸç§æ–¹å¼è°ƒç”¨å®ƒã€‚
ï¼ˆç¼–è¯‘å™¨é€šå¸¸å¾ˆå®¹æ˜“åœ¨å¤§é‡ä½¿ç”¨æ—¶ä¼˜åŒ–è°ƒç”¨ç«™ç‚¹ç‰¹åŒ–ã€‚ï¼‰

There are several arbitrary decisions about when and how to check interrupts in both acquire and await before and/or after blocking. 
The decisions are less arbitrary in implementation updates because some users appear to rely on original behaviors in ways that are racy and so (rarely) wrong in general but hard to justify changing.

å…³äºä½•æ—¶ä»¥åŠå¦‚ä½•åœ¨é˜»å¡ä¹‹å‰å’Œ/æˆ–ä¹‹åæ£€æŸ¥ acquire å’Œ await ä¸­çš„ä¸­æ–­ï¼Œæœ‰å‡ ä¸ªä»»æ„çš„å†³å®šã€‚
è¿™äº›å†³å®šåœ¨å®æ–½æ›´æ–°ä¸­ä¸é‚£ä¹ˆéšæ„ï¼Œå› ä¸ºä¸€äº›ç”¨æˆ·ä¼¼ä¹ä»¥æ´»æ³¼çš„æ–¹å¼ä¾èµ–åŸå§‹è¡Œä¸ºï¼Œå› æ­¤ï¼ˆå¾ˆå°‘ï¼‰é€šå¸¸æ˜¯é”™è¯¯çš„ï¼Œä½†å¾ˆéš¾è¯æ˜æ”¹å˜æ˜¯åˆç†çš„ã€‚

Thanks go to Dave Dice, Mark Moir, Victor Luchangco, Bill Scherer and Michael Scott, along with members of JSR-166 expert group, for helpful ideas, discussions, and critiques on the design of this class.

æ„Ÿè°¢ Dave Diceã€Mark Moirã€Victor Luchangcoã€Bill Scherer å’Œ Michael Scott ä»¥åŠ JSR-166 ä¸“å®¶ç»„çš„æˆå‘˜ï¼Œæ„Ÿè°¢ä»–ä»¬å¯¹æœ¬è¯¾ç¨‹çš„è®¾è®¡æå‡ºäº†æœ‰ç›Šçš„æƒ³æ³•ã€è®¨è®ºå’Œæ‰¹è¯„ã€‚
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h4 id="_3-1-2-aqsçš„ä½¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#_3-1-2-aqsçš„ä½¿ç”¨ç¤ºä¾‹" aria-hidden="true">#</a> 3.1.2 AQSçš„ä½¿ç”¨ç¤ºä¾‹</h4><blockquote><p>æ¥è‡ªäºæºç ç±»æ³¨é‡Šä¸­çš„Usage Examples</p></blockquote><h5 id="_3-1-2-1-ä¸å¯é‡å…¥çš„äº’æ–¥é”" tabindex="-1"><a class="header-anchor" href="#_3-1-2-1-ä¸å¯é‡å…¥çš„äº’æ–¥é”" aria-hidden="true">#</a> 3.1.2.1 ä¸å¯é‡å…¥çš„äº’æ–¥é”</h5><details class="hint-container details"><summary>Mutex (non-reentrant mutual exclusion lock)</summary><p>Here is a non-reentrant mutual exclusion lock class that uses the value zero to represent the unlocked state, and one to represent the locked state. While a non-reentrant lock does not strictly require recording of the current owner thread, this class does so anyway to make usage easier to monitor. It also supports conditions and exposes some instrumentation methods:</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">AbstractQueuedSynchronizer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Condition</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Mutex</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>

        <span class="token comment">// Acquires the lock if state is zero</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> acquires <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Releases the lock by setting state to zero</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> releases <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">// éç‹¬å é”åˆ™æŠ›å‡ºå¼‚å¸¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// çŠ¶æ€ä¸ä¸ºé›¶åˆ™æŒæœ‰é”</span>
            <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æŒæœ‰é”çš„çº¿ç¨‹å¦‚æœæ˜¯å½“å‰çº¿ç¨‹åˆ™è¿”å›true</span>
            <span class="token comment">// a data race, but safe due to out-of-thin-air guarantees</span>
            <span class="token keyword">return</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Provides a Condition      </span>
        <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConditionObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Deserializes properly      </span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reset to unlocked state      </span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The sync object does all the hard work. We just forward to it.</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>3.1.2.2 é—©é”ç±» ï¼ˆç±»ä¼¼äºCountDownLatchï¼Œä½†æ˜¯åªè®¡æ•°1åˆ™è§¦å‘ï¼‰</p><details class="hint-container details"><summary>BooleanLatch</summary><p>Here is a latch class that is like a CountDownLatch except that it only requires a single signal to fire. Because a latch is non-exclusive, it uses the shared acquire and release methods.</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">AbstractQueuedSynchronizer</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BooleanLatch</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> <span class="token function">isSignalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">isSignalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSignalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">isSignalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h4 id="_3-2-locksupport" tabindex="-1"><a class="header-anchor" href="#_3-2-locksupport" aria-hidden="true">#</a> 3.2 LockSupport</h4><h4 id="_3-3-reentrantlock" tabindex="-1"><a class="header-anchor" href="#_3-3-reentrantlock" aria-hidden="true">#</a> 3.3 ReentrantLock</h4><h4 id="_3-4-reentrantreadwritelock" tabindex="-1"><a class="header-anchor" href="#_3-4-reentrantreadwritelock" aria-hidden="true">#</a> 3.4 ReentrantReadWriteLock</h4><h4 id="_3-5-stampedlock" tabindex="-1"><a class="header-anchor" href="#_3-5-stampedlock" aria-hidden="true">#</a> 3.5 StampedLock</h4><h2 id="_4-æ­»é”" tabindex="-1"><a class="header-anchor" href="#_4-æ­»é”" aria-hidden="true">#</a> 4. æ­»é”</h2><h2 id="_5-æ— é”" tabindex="-1"><a class="header-anchor" href="#_5-æ— é”" aria-hidden="true">#</a> 5. æ— é”</h2></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/Spectred/spectred.github.io/edit/main/src/java/concurrent/locks.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 1505073336@qq.com">spectred</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/java/concurrent/threads.html" class="nav-link prev" aria-label="2. çº¿ç¨‹ä¸çº¿ç¨‹æ± "><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->2. çº¿ç¨‹ä¸çº¿ç¨‹æ± </div></a><a href="/java/concurrent/collector.html" class="nav-link next" aria-label="4. å¹¶å‘å®¹å™¨"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">4. å¹¶å‘å®¹å™¨<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><img src="https://v2.jinrishici.com/one.svg?font-size=14&spacing=2&color=SkyBlue" alt="ä»Šæ—¥è¯—è¯API"></div><!----></footer></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-bceac402.js" defer></script>
  </body>
</html>
